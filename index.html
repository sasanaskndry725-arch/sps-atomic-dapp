<!doctype html>
<html lang="fa">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>SPS Atomic DApp — Polygon Mainnet</title>
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.min.js"></script>
  <style>
    :root{--bg:#071024;--card:#0b1220;--muted:#9aa4b2;--accent:#2563eb;--ok:#10b981;--err:#ef4444}
    body{font-family: \"Vazirmatn\", Tahoma, Arial, sans-serif;direction:rtl;background:linear-gradient(180deg,#071024 0%,#07162a 100%);color:#e6eef8;margin:0;padding:28px}
    .wrap{max-width:980px;margin:0 auto}
    .card{background:var(--card);border-radius:12px;padding:18px;box-shadow:0 10px 30px rgba(2,6,23,0.6);}
    h1{margin:0 0 10px;font-size:20px}
    .row{display:flex;gap:12px;flex-wrap:wrap;align-items:center}
    button{background:var(--accent);border:0;padding:8px 12px;border-radius:8px;color:white;cursor:pointer}
    input,select,textarea{padding:8px;border-radius:8px;border:1px solid #142130;background:#071623;color:#e6eef8}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    pre{background:#071926;padding:10px;border-radius:8px;overflow:auto;color:#cfe8ff}
    .kpi{background:linear-gradient(90deg,rgba(255,255,255,0.02),transparent);padding:12px;border-radius:8px}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    #log{height:160px;overflow:auto;padding:8px;border-radius:8px;background:#05101a}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>SPS Atomic DApp — Polygon Mainnet</h1>
      <p class="muted">برای اجرای تراکنش: MetaMask متصل و کیف پول دارای MATIC باشد. این فایل را روی GitHub Pages یا هر هاست استاتیک قرار بده.</p>

      <div class="grid" style="margin-top:12px">
        <div>
          <div class="row" style="justify-content:space-between;margin-bottom:12px">
            <div>
              <button id="btn-connect">اتصال کیف پول</button>
              <button id="btn-disconnect">قطع اتصال</button>
              <button id="btn-refresh">خواندن داده‌ها</button>
            </div>
            <div class="muted">وضعیت: <span id="status">قطع</span></div>
          </div>

          <div class="kpi">
            <div class="row small" style="justify-content:space-between">
              <div>آدرس قرارداد: <code id="contract-address">0x7a7b06D49129B34976D07B3854d4D72D01588191</code></div>
              <div>شبکه: <span id="required-network">Polygon Mainnet (137)</span></div>
            </div>
            <hr style="opacity:0.06;margin:8px 0"/>
            <div class="row" style="gap:18px;align-items:center">
              <div>
                <p class="muted">تعداد کل کاربران</p>
                <h2 id="totalUsers">—</h2>
              </div>
              <div>
                <p class="muted">موجودی استخر (MATIC)</p>
                <h2 id="poolBalance">—</h2>
              </div>
              <div>
                <p class="muted">قیمت توکن (MATIC)</p>
                <h2 id="tokenPrice">—</h2>
              </div>
            </div>
          </div>

          <div style="margin-top:12px">
            <h3>جستجوی اطلاعات کاربر</h3>
            <div class="row" style="margin-bottom:8px">
              <input id="userAddr" placeholder="آدرس کاربر (خالی => آدرس متصل)" />
              <button id="btn-getUser">دریافت اطلاعات کاربر</button>
            </div>
            <pre id="userInfo">نتیجه اینجا نمایش داده می‌شود</pre>

            <h3 style="margin-top:12px">لاگ‌ها</h3>
            <div id="log"></div>
          </div>
        </div>

        <div>
          <div style="background:linear-gradient(180deg,#071926,#05101a);padding:12px;border-radius:10px">
            <h3>عملیات تراکنشی</h3>
            <p class="muted small">قبل از اجرا: کیف پول را متصل کنید.</p>

            <div style="margin-top:8px">
              <label class="small muted">ثبت‌نام (register) — نیازمند ارزش ENTRY_FEE</label>
              <div class="row" style="margin-top:6px">
                <input id="regUpline" placeholder="uplineCode (عدد)" />
                <select id="regPlace"><option value="true">چپ</option><option value="false">راست</option></select>
              </div>
              <div class="row" style="margin-top:8px">
                <button id="btn-register">ثبت‌نام (payable)</button>
              </div>
            </div>

            <hr style="opacity:0.06"/>

            <div>
              <label class="small muted">ارسال به استخر (contributeToMinerPool)</label>
              <div class="row" style="margin-top:6px">
                <input id="contribAmount" placeholder="مقدار به MATIC (مثال: 0.1)" />
                <button id="btn-contrib">ارسال</button>
              </div>
            </div>

            <hr style="opacity:0.06"/>

            <div class="row" style="margin-top:8px">
              <button id="btn-buyTokens">buyMinerTokens</button>
              <button id="btn-distribute">distributeMinerTokens</button>
            </div>
            <div class="row" style="margin-top:8px">
              <button id="btn-withdrawPool">withdrawPool</button>
              <button id="btn-withdrawSpecials">withdrawSpecials</button>
            </div>

            <hr style="opacity:0.06"/>

            <div style="margin-top:8px">
              <label class="small muted">تابع mpu (مدیریتی)</label>
              <textarea id="mpuPayload" rows="4" style="width:100%;background:#071623;color:#cfe8ff;border-radius:8px;padding:8px;border:1px solid #122233" placeholder='JSON payload: {"id":1,"userWallet":"0x..","uplineId":2,"leftChildAddress":"0x..","rightChildAddress":"0x..","oldLeftCount":0,"oldRightCount":0,"oldLeftSave":0,"oldRightSave":0}'></textarea>
              <div class="row" style="margin-top:6px">
                <button id="btn-mpu">ارسال mpu</button>
              </div>
            </div>

          </div>
        </div>
      </div>

      <footer>
        <div class="muted">راهنما: اگر اتصال برقرار نشد، DevTools → Console را باز کن، خطاها را کپی کن و برایم بفرست تا فیکس کنم.</div>
      </footer>
    </div>
  </div>

<script>
/* ---------------- تنظیمات قرارداد (از شما) ---------------- */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},{"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}];
/* ---------------- / تنظیمات قرارداد ---------------- */

const logEl = document.getElementById('log');
function log(...args){
  console.log(...args);
  const p = document.createElement('div');
  p.textContent = args.map(a => typeof a==='object'?JSON.stringify(a):String(a)).join(' ');
  logEl.prepend(p);
}

let provider = null;
let signer = null;
let contract = null;

async function initProvider(){
  if(window.ethereum){
    provider = new ethers.BrowserProvider(window.ethereum,"any");
    log('injected provider detected');
  } else {
    provider = new ethers.JsonRpcProvider('https://polygon-rpc.com');
    log('no injected provider — fallback to polygon-rpc.com (read-only)');
  }
}

async function connectWallet(){
  try{
    if(!window.ethereum) return alert('MetaMask یا کیف پول وب۳ نصب نیست.');
    await initProvider();
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    signer = await provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    document.getElementById('status').textContent = `متصل: ${short(addr)}`;
    log('connected', addr);
    await checkNetwork();
  } catch(e){
    log('connect error', e);
    document.getElementById('status').textContent = 'خطا در اتصال';
  }
}

function disconnectWallet(){
  signer = null; contract = null;
  document.getElementById('status').textContent = 'قطع (local)';
  log('local disconnect');
}

function short(a){ return a? `${a.slice(0,6)}…${a.slice(-4)}` : ''; }

async function checkNetwork(){
  try{
    const net = await provider.getNetwork();
    log('network', net);
    if(Number(net.chainId) !== 137){
      document.getElementById('status').textContent += ` — شبکه کیف پول: ${net.chainId}. لطفاً پالیگان (137) انتخاب کنید.`;
    } else {
      document.getElementById('status').textContent += ' — شبکه صحیح (Polygon)';
    }
  }catch(e){ log('checkNetwork err', e); }
}

async function refreshData(){
  try{
    if(!provider) await initProvider();
    const readContract = contract ? contract : new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);

    // totalUsers
    let totalUsers = '—';
    if(typeof readContract.totalUsers === 'function'){
      try{ const tu = await readContract.totalUsers(); totalUsers = tu.toString(); }catch(e){ log('totalUsers read err', e); }
    }
    document.getElementById('totalUsers').textContent = totalUsers;

    // poolBalance
    let pb = '—';
    if(typeof readContract.poolBalance === 'function'){
      try{ const raw = await readContract.poolBalance(); pb = ethers.formatEther(raw); }catch(e){ log('poolBalance err', e); }
    }
    document.getElementById('poolBalance').textContent = pb;

    // token price
    let tp = '—';
    if(typeof readContract.getTokenPrice === 'function'){
      try{ const r = await readContract.getTokenPrice(); tp = ethers.formatEther(r); }catch(e){ log('getTokenPrice err', e); }
    }
    document.getElementById('tokenPrice').textContent = tp;

    log('refreshed data', {totalUsers, pb, tp});
  } catch(e){ log('refreshData err', e); }
}

async function getUserInfo(){
  try{
    if(!provider) await initProvider();
    const addr = document.getElementById('userAddr').value || (signer ? await signer.getAddress() : null);
    if(!addr) return alert('آدرس خالی است و کیف پول متصل نیست.');
    const readContract = contract ? contract : new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
    const info = await readContract.getUserInfo(addr);
    const out = {
      id: info.id?.toString?.() || info[0]?.toString?.(),
      uplineId: info.uplineId?.toString?.() || info[1]?.toString?.(),
      leftCount: info.leftCount?.toString?.() || info[2]?.toString?.(),
      rightCount: info.rightCount?.toString?.() || info[3]?.toString?.(),
      saveLeft: info.saveLeft?.toString?.() || info[4]?.toString?.(),
      saveRight: info.saveRight?.toString?.() || info[5]?.toString?.(),
      balanceCount: info.balanceCount?.toString?.() || info[6]?.toString?.(),
      specialBalanceCount: info.specialBalanceCount?.toString?.() || info[7]?.toString?.(),
      totalMinerRewards: info.totalMinerRewards?.toString?.() || info[8]?.toString?.(),
      entryPrice: info.entryPrice ? ethers.formatEther(info.entryPrice) : (info[9] ? ethers.formatEther(info[9]) : undefined),
      isMiner: info.isMiner === undefined ? info[10] : info.isMiner
    };
    document.getElementById('userInfo').textContent = JSON.stringify(out, null, 2);
    log('getUserInfo', addr, out);
  }catch(e){ log('getUserInfo err', e); document.getElementById('userInfo').textContent = 'خطا — کنسول را بررسی کن'; }
}

// ---------------- transaction functions ----------------
async function sendRegister(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const upline = document.getElementById('regUpline').value || 0;
    const place = document.getElementById('regPlace').value === 'true';
    // try read ENTRY_FEE
    let fee = null;
    try{ fee = await contract.ENTRY_FEE(); }catch(e){ log('ENTRY_FEE read error (maybe not present)', e); }
    const overrides = {};
    if(fee) overrides.value = fee;
    const tx = await contract.register(upline, place, overrides);
    document.getElementById('status').textContent = 'در انتظار تایید تراکنش ثبت‌نام...';
    log('register tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'ثبت‌نام انجام شد';
    refreshData();
  }catch(e){ log('register err', e); alert('خطا در ثبت‌نام — کنسول را ببین'); }
}

async function sendContribute(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const v = document.getElementById('contribAmount').value;
    if(!v) return alert('مقدار را وارد کنید');
    const wei = ethers.parseEther(v);
    const tx = await contract.contributeToMinerPool({ value: wei });
    document.getElementById('status').textContent = 'در انتظار تایید contribution...';
    log('contribute tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'contribution تایید شد';
    refreshData();
  }catch(e){ log('contribute err', e); alert('خطا در ارسال'); }
}

async function buyMinerTokens(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const tx = await contract.buyMinerTokens();
    document.getElementById('status').textContent = 'در انتظار تایید buyMinerTokens...';
    log('buyMinerTokens tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'buyMinerTokens تایید شد';
    refreshData();
  }catch(e){ log('buyMinerTokens err', e); alert('خطا'); }
}

async function distributeMinerTokens(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const tx = await contract.distributeMinerTokens();
    document.getElementById('status').textContent = 'در انتظار تایید distribute...';
    log('distribute tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'distribute تایید شد';
    refreshData();
  }catch(e){ log('distribute err', e); alert('خطا'); }
}

async function withdrawPool(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const tx = await contract.withdrawPool();
    document.getElementById('status').textContent = 'در انتظار تایید withdrawPool...';
    log('withdrawPool tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'withdrawPool تایید شد';
    refreshData();
  }catch(e){ log('withdrawPool err', e); alert('خطا'); }
}

async function withdrawSpecials(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const tx = await contract.withdrawSpecials();
    document.getElementById('status').textContent = 'در انتظار تایید withdrawSpecials...';
    log('withdrawSpecials tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'withdrawSpecials تایید شد';
    refreshData();
  }catch(e){ log('withdrawSpecials err', e); alert('خطا'); }
}

async function sendMpu(){
  try{
    if(!contract) return alert('ابتدا کیف پول را متصل کنید');
    const raw = document.getElementById('mpuPayload').value;
    if(!raw) return alert('payload خالی است');
    let p;
    try{ p = JSON.parse(raw); }catch(e){ return alert('JSON معتبر نیست'); }
    const tx = await contract.mpu(p.id, p.userWallet, p.uplineId, p.leftChildAddress, p.rightChildAddress, p.oldLeftCount||0, p.oldRightCount||0, p.oldLeftSave||0, p.oldRightSave||0);
    document.getElementById('status').textContent = 'در انتظار تایید mpu...';
    log('mpu tx', tx);
    await tx.wait();
    document.getElementById('status').textContent = 'mpu تایید شد';
    refreshData();
  }catch(e){ log('mpu err', e); alert('خطا در ارسال mpu — کنسول را بررسی کن'); }
}

/* ---------------- wire UI ---------------- */
document.getElementById('btn-connect').addEventListener('click', connectWallet);
document.getElementById('btn-disconnect').addEventListener('click', disconnectWallet);
document.getElementById('btn-refresh').addEventListener('click', refreshData);
document.getElementById('btn-getUser').addEventListener('click', getUserInfo);
document.getElementById('btn-register').addEventListener('click', sendRegister);
document.getElementById('btn-contrib').addEventListener('click', sendContribute);
document.getElementById('btn-buyTokens').addEventListener('click', buyMinerTokens);
document.getElementById('btn-distribute').addEventListener('click', distributeMinerTokens);
document.getElementById('btn-withdrawPool').addEventListener('click', withdrawPool);
document.getElementById('btn-withdrawSpecials').addEventListener('click', withdrawSpecials);
document.getElementById('btn-mpu').addEventListener('click', sendMpu);

/* auto init */
initProvider().then(()=>refreshData()).catch(e=>log('init err', e));

/* wallet events */
if(window.ethereum){
  window.ethereum.on && window.ethereum.on('accountsChanged', (accounts)=>{ log('accountsChanged', accounts); if(accounts.length===0){ document.getElementById('status').textContent='کیف پول قطع شد'; signer=null; contract=null; } else { connectWallet(); } });
  window.ethereum.on && window.ethereum.on('chainChanged', (c)=>{ log('chainChanged', c); initProvider().catch(e=>log('reinit',e)); });
}
</script>
</body>
</html>