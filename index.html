<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>SPS DApp - Ù†Ø³Ø®Ù‡ Ù†Ù‡Ø§ÛŒÛŒ</title>

    <!-- Ethers.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

    <style>
        :root{
            --primary:#3b82f6;
            --accent:#8b5cf6;
            --card-bg: rgba(15,23,42,0.75);
            --muted: #94a3b8;
            --glass: rgba(255,255,255,0.03);
            --success:#10b981;
            --danger:#ef4444;
        }
        *{box-sizing:border-box;margin:0;padding:0}
        body{
            font-family: Tahoma, sans-serif;
            background: linear-gradient(135deg,#0f172a 0%,#111827 100%);
            color:#e6eef8;
            min-height:100vh;
            padding:18px;
            -webkit-font-smoothing:antialiased;
        }

        /* Header */
        .container{ max-width:1200px;margin:0 auto; }
        .header{
            background:var(--card-bg);
            border-radius:12px;
            padding:16px;
            display:flex;
            gap:12px;
            align-items:center;
            justify-content:space-between;
            border:1px solid rgba(255,255,255,0.04);
        }
        .logo { font-weight:800; font-size:22px; background:linear-gradient(90deg,var(--primary),var(--accent)); -webkit-background-clip:text; -webkit-text-fill-color:transparent; }
        .status-ind { display:flex; gap:10px; align-items:center; }
        .status-dot{width:12px;height:12px;border-radius:50%;background:var(--danger);box-shadow:0 0 6px rgba(0,0,0,0.4)}
        .status-dot.connected{background:var(--success)}
        .wallet-btn{ background:linear-gradient(90deg,var(--primary),#6366f1); padding:10px 18px; border-radius:8px; border:none; color:white; cursor:pointer; font-weight:700 }

        /* tabs */
        .tabs{ display:flex; gap:8px; margin:16px 0; flex-wrap:wrap }
        .tab-btn{ background:transparent;border:1px solid transparent;color:var(--muted); padding:10px 14px;border-radius:8px; cursor:pointer }
        .tab-btn.active{ background: rgba(59,130,246,0.12); color:var(--primary); border-color: rgba(59,130,246,0.12) }

        /* grid */
        .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:14px; margin:16px 0 }
        .stat-box{ background:var(--card-bg); padding:14px; border-radius:10px; text-align:center; border:1px solid rgba(255,255,255,0.03) }
        .stat-label{ color:var(--muted); font-size:13px }
        .stat-value{ font-weight:800; margin-top:8px; color:#cfe7ff }

        .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:18px; margin-top:12px }
        .card{ background:var(--card-bg); padding:14px; border-radius:10px; border:1px solid rgba(255,255,255,0.03) }

        /* tree */
        .tree-container{ max-height:420px; overflow:auto; padding:10px; border-radius:8px; background:linear-gradient(180deg, rgba(255,255,255,0.01), transparent) }
        .node{ padding:8px 10px; border-radius:8px; margin-bottom:8px; background: rgba(30,41,59,0.5); border:1px solid rgba(59,130,246,0.09); display:flex; justify-content:space-between; align-items:center; gap:8px }
        .node .meta{ color:var(--muted); font-size:13px }
        .children{ margin-right:16px; padding-right:12px; border-right:2px dashed rgba(59,130,246,0.08) }
        .toggle-btn{ background:transparent;border:none;color:var(--primary);cursor:pointer;font-weight:700 }

        /* forms */
        .form-group{ margin-bottom:12px }
        .form-label{ color:var(--muted); font-size:13px; margin-bottom:6px; display:block }
        .form-input, textarea, select{ width:100%; padding:10px; background:transparent; border:1px solid rgba(255,255,255,0.06); color:inherit; border-radius:8px }

        /* buttons */
        .btn{ padding:12px; border-radius:8px; border:none; cursor:pointer; font-weight:700 }
        .btn-primary{ background:linear-gradient(90deg,var(--primary),#6366f1); color:white }
        .btn-success{ background:linear-gradient(90deg,var(--success),#34d399); color:white }
        .btn-warning{ background:linear-gradient(90deg,#f59e0b,#fbbf24); color:white }
        .btn-danger{ background:linear-gradient(90deg,var(--danger),#f87171); color:white }

        .btn-group{ display:grid; grid-template-columns:repeat(auto-fit,minmax(150px,1fr)); gap:10px }

        /* status message */
        .status{ padding:12px; border-radius:8px; margin-top:10px; font-weight:700; text-align:center }
        .status.info{ background: rgba(59,130,246,0.08); color:#60a5fa; border:1px solid rgba(59,130,246,0.06) }
        .status.success{ background: rgba(16,185,129,0.08); color:#34d399; border:1px solid rgba(16,185,129,0.06) }
        .status.error{ background: rgba(239,68,68,0.08); color:#fb7185; border:1px solid rgba(239,68,68,0.06) }
        .tx-link{ color:#9ecbff; text-decoration:none; padding:6px 10px; display:inline-block; margin-top:8px; border-radius:6px; border:1px solid rgba(59,130,246,0.06) }

        /* loading */
        .loading{ display:none; position:fixed; inset:0; background:rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center }
        .spinner{ width:56px; height:56px; border-radius:50%; border:5px solid rgba(255,255,255,0.08); border-top-color:var(--primary); animation:spin 1s linear infinite }
        @keyframes spin { to{ transform:rotate(360deg) } }

        footer{ margin-top:20px; text-align:center; color:var(--muted); font-size:13px }

        /* responsive */
        @media (max-width:900px){
            .grid-2{ grid-template-columns:1fr }
            .header{ flex-direction:column; gap:8px; align-items:flex-start }
        }

        /* small tooltip */
        .help { font-size:12px; color:var(--muted); margin-top:6px }
    </style>
</head>
<body>
    <div class="container">
        <!-- header -->
        <div class="header">
            <div style="display:flex;align-items:center;gap:12px">
                <div class="logo">SPS</div>
                <div class="status-ind">
                    <div id="statusDot" class="status-dot"></div>
                    <div id="networkStatus">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</div>
                </div>
            </div>

            <div id="connectArea">
                <button id="connectBtn" class="wallet-btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
            </div>
        </div>

        <!-- tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="tab-btn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
            <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
            <button class="tab-btn" onclick="showTab('admin')" id="adminTab" style="display:none">Ù…Ø¯ÛŒØ±ÛŒØª</button>
        </div>

        <!-- Dashboard -->
        <div id="dashboardTab">
            <div class="stats-grid">
                <div class="stat-box" title="Ú©Ù„ Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø± (MATIC)">
                    <div class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
                    <div class="stat-value" id="poolBalance">0 MATIC</div>
                </div>
                <div class="stat-box" title="Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø± (pToken)">
                    <div class="stat-label">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
                    <div class="stat-value" id="minerPool">0 pToken</div>
                </div>
                <div class="stat-box" title="Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ (MATIC)">
                    <div class="stat-label">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
                    <div class="stat-value" id="specialPool">0 MATIC</div>
                </div>
                <div class="stat-box" title="Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯ (MATIC)">
                    <div class="stat-label">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
                    <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
                </div>
            </div>

            <div class="grid-2">
                <div class="card">
                    <h3>ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
                    <div id="userInfo" class="status info">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</div>
                    <div class="help">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù„ÛŒÙ†Ú© ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
                </div>

                <div class="card">
                    <h3>ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø´Ù…Ø§</h3>
                    <div class="tree-container" id="treeContainer">
                        <div class="node">ğŸ”„ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯</div>
                    </div>
                    <div class="help">Ø±ÙˆÛŒ Ù‡Ø± Ú¯Ø±Ù‡ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯ ØªØ§ Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø² ÛŒØ§ Ø¨Ø³ØªÙ‡ Ø´ÙˆÙ†Ø¯. Ø³Ø·ÙˆØ­ Ø¨Ù‡ ØµÙˆØ±Øª Ø¨Ø§Ø²Ú¯Ø´ØªÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
                </div>
            </div>
        </div>

        <!-- Register -->
        <div id="registerTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
                    <div class="form-group">
                        <label class="form-label">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label>
                        <input id="uplineCode" class="form-input" type="number" placeholder="1" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
                        <select id="position" class="form-input">
                            <option value="true">Ú†Ù¾</option>
                            <option value="false">Ø±Ø§Ø³Øª</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="register()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
                    <div id="registerResult"></div>
                </div>

                <div class="card">
                    <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
                    <div id="registerInfo" class="status info">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
                </div>
            </div>
        </div>

        <!-- Miner -->
        <div id="minerTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>â›ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
                    <div class="form-group">
                        <label class="form-label">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
                        <input id="contribution" class="form-input" placeholder="0.1" />
                    </div>

                    <div class="btn-group">
                        <button class="btn btn-success" onclick="contribute()">Ù…Ø´Ø§Ø±Ú©Øª</button>
                        <!-- Ù…ØªÙ† Ø¯Ú©Ù…Ù‡ Ø®Ø±ÛŒØ¯ ØªØºÛŒÛŒØ± Ø¯Ø§Ø¯Ù‡ Ø´Ø¯ -->
                        <button class="btn btn-primary" onclick="buyTokens()">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±</button>
                        <!-- Ø¯Ú©Ù…Ù‡ ÙØ±ÙˆØ´ Ø§Ø² UI Ø­Ø°Ù Ø´Ø¯ (Ù…Ù†Ø·Ù‚ ØªØ§Ø¨Ø¹ sellTokens Ù‡Ù…Ú†Ù†Ø§Ù† Ø¯Ø± Ú©Ø¯ Ø¨Ø§Ù‚ÛŒ Ø§Ø³Øª) -->
                        <!-- <button class="btn btn-primary" onclick="sellTokens()">ÙØ±ÙˆØ´ ØªÙˆÚ©Ù†</button> -->
                        <button class="btn btn-success" onclick="distribute()">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
                    </div>

                    <div id="minerResult"></div>
                </div>

                <div class="card">
                    <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
                    <div id="minerInfo" class="status info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§</div>
                </div>
            </div>
        </div>

        <!-- Actions -->
        <div id="actionsTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±Ù‡Ø§</h3>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ</button>
                        <button class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
                    </div>
                    <div id="withdrawResult"></div>
                </div>

                <div class="card">
                    <h3>ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
                    <div id="withdrawInfo" class="status info">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</div>
                </div>
            </div>
        </div>

        <!-- Admin -->
        <div id="adminTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
                    <div class="form-group">
                        <label class="form-label">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
                        <input id="newFee" class="form-input" placeholder="300000000000000000000" />
                    </div>
                    <button class="btn btn-danger" onclick="updateFee()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯</button>
                    <div id="adminResult"></div>
                </div>

                <div class="card">
                    <h3>ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</h3>
                    <div class="form-group">
                        <label class="form-label">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§)</label>
                        <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
                    </div>
                    <button class="btn btn-danger" onclick="removeMiners()">Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</button>
                </div>
            </div>
        </div>

        <div class="loading" id="loading"><div class="spinner"></div></div>

        <footer>
            SPS Network â€¢ Ø¢Ø¯Ø±Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: 0x7a7b06D49129B34976D07B3854d4D72D01588191 â€¢ Polygon Mainnet
        </footer>
    </div>

    <script>
        // ======= Ø«Ø§Ø¨Øªâ€ŒÙ‡Ø§ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±) =======
        const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
        const POLYGON_CHAIN_ID = "0x89";
        const ENTRY_FEE = "300000000000000000000"; // 300 MATIC

        // ABI Ú©Ø§Ù…Ù„ (Ù‡Ù…Ø§Ù† ABI Ø§ØµÙ„ÛŒ â€” Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ±)
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},
            {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"specialPointCount","stateMutability":"view","type":"function"},
            {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];

        // ===== state =====
        let provider, signer, contract, userAddress, isOwner = false;

        // ===== helpers =====
        function showStatus(message, type='info', targetId='userInfo') {
            const el = document.getElementById(targetId);
            el.className = `status ${type}`;
            el.innerHTML = message;
            console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g,'')}`);
        }

        function showLoading(show){
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }

        function showPending(txHash, targetId){
            const link = `https://polygonscan.com/tx/${txHash}`;
            document.getElementById(targetId).innerHTML = `
                <div class="status info">
                    â³ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯ â€” Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± ØªØ£ÛŒÛŒØ¯...
                    <div style="margin-top:8px">
                        <a href="${link}" target="_blank" class="tx-link">ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Polygonscan</a>
                    </div>
                </div>
            `;
        }

        function showTransactionLink(txHash, targetId){
            const link = `https://polygonscan.com/tx/${txHash}`;
            document.getElementById(targetId).innerHTML = `
                <div class="status success">
                    âœ… ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øª Ø´Ø¯
                    <div style="margin-top:8px">
                        <a href="${link}" target="_blank" class="tx-link">ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Polygonscan</a>
                    </div>
                </div>
            `;
        }

        function updateNetworkStatus(connected){
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('networkStatus');
            if(connected){ dot.classList.add('connected'); text.textContent = 'Polygon Mainnet' }
            else { dot.classList.remove('connected'); text.textContent = 'Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡' }
        }

        // ===== tree: multi-level recursive view (UI only, uses existing read functions) =====
        async function buildTreeHtml(userId, depth = 0, maxDepth = 4){
            try {
                if (depth > maxDepth) return '';
                // get user info and directs
                const info = await contract.getUserInfo(userAddress).catch(()=>null);
                // We must call getUserDirects with the node id we want to expand
                const directs = await contract.getUserDirects(userId).catch(()=>[0,0]);
                const left = directs[0] ? Number(directs[0]) : 0;
                const right = directs[1] ? Number(directs[1]) : 0;

                // create node markup
                let html = `<div class="node" data-id="${userId}" style="margin-right:${depth*12}px">`;
                html += `<div style="display:flex;flex-direction:column;gap:4px">`;
                html += `<div style="font-weight:700">ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± ID: ${userId}</div>`;
                html += `<div class="meta">Ú†Ù¾: ${left} â€” Ø±Ø§Ø³Øª: ${right}</div>`;
                html += `</div>`;
                // toggle area: if there are children, show button
                if (left > 0 || right > 0) {
                    html += `<div><button class="toggle-btn" data-target="${userId}">[Ø¨Ø§Ø²/Ø¨Ø³ØªÙ‡]</button></div>`;
                }
                html += `</div>`;

                // placeholder for children
                if (left > 0 || right > 0) {
                    html += `<div class="children" id="children-${userId}" style="display:none">`;
                    if (left > 0) html += await buildTreeHtml(left, depth+1, maxDepth);
                    if (right > 0) html += await buildTreeHtml(right, depth+1, maxDepth);
                    html += `</div>`;
                }

                return html;

            } catch (e) {
                console.error('buildTreeHtml error', e);
                return `<div class="node">âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ú¯Ø±Ù‡ ${userId}</div>`;
            }
        }

        async function loadTreeStructure(userId){
            const container = document.getElementById('treeContainer');
            container.innerHTML = `<div class="node">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±...</div>`;
            try {
                const html = await buildTreeHtml(userId);
                container.innerHTML = html || `<div class="node">ğŸ“­ Ù‡ÛŒÚ† Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>`;
                // add toggle listeners
                container.querySelectorAll('.toggle-btn').forEach(btn=>{
                    btn.onclick = (e)=>{
                        const id = btn.getAttribute('data-target');
                        const el = document.getElementById('children-'+id);
                        if (!el) return;
                        el.style.display = (el.style.display === 'none' || el.style.display === '') ? 'block' : 'none';
                    };
                });
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ:', error);
                container.innerHTML = `<div class="node">âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±</div>`;
            }
        }

        // ====== Sell tokens UI removal note: function remains (no logic change) ======
        async function sellTokens(){
            if (!contract) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
                return;
            }

            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±ÙˆØ´ ØªÙˆÚ©Ù†...', 'info', 'minerResult');

                // NOTE: Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                // Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† ØªØ§Ø¨Ø¹ sellMinerTokens Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¯Ø§Ø±ÛŒØ¯
                // const tx = await contract.sellMinerTokens();

                // ÙØ¹Ù„Ø§Ù‹ Ù¾ÛŒØ§Ù… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                await new Promise(resolve => setTimeout(resolve, 2000));
                showStatus(`
                    âš ï¸ ØªØ§Ø¨Ø¹ ÙØ±ÙˆØ´ ØªÙˆÚ©Ù† Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª<br>
                    Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† ØªØ§Ø¨Ø¹ sellMinerTokens Ø¯Ø± Smart Contract
                `, 'error', 'minerResult');

            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'minerResult');
            } finally {
                showLoading(false);
            }
        }

        // ====== Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ø¨Ø¯ÙˆÙ† ØªØºÛŒÛŒØ± Ù…Ù†Ø·Ù‚ÛŒØŒ ÙÙ‚Ø· UI Ø¨Ù‡ØªØ±) ======
        async function connectWallet(){
            if (typeof window.ethereum === 'undefined') {
                showStatus('âŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø«Ù„ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                return;
            }
            try {
                showLoading(true);
                showStatus('ğŸ”— Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...', 'info');

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                // Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¨Ú©Ù‡ Ùˆ Ø³ÙˆÛŒÛŒÚ† Ø¨Ù‡ Polygon Ø§Ú¯Ø± Ù„Ø§Ø²Ù… Ø¨ÙˆØ¯
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                if (chainId !== POLYGON_CHAIN_ID) {
                    showStatus('ğŸ”„ ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Polygon...', 'info');
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: POLYGON_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: POLYGON_CHAIN_ID,
                                    chainName: 'Polygon Mainnet',
                                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                    rpcUrls: ['https://polygon-rpc.com'],
                                    blockExplorerUrls: ['https://polygonscan.com']
                                }],
                            });
                        }
                    }
                    // give wallet a moment
                    await new Promise(r=>setTimeout(r,1200));
                }

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);

                // update UI connect area
                document.getElementById('connectArea').innerHTML = `
                    <div style="background:linear-gradient(90deg,#10b981,#34d399);color:#06281a;padding:10px;border-radius:8px;font-weight:700">
                        âœ… ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}
                    </div>
                `;

                updateNetworkStatus(true);
                await loadDashboard();
                showStatus('âœ… Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯', 'success');

                // events
                window.ethereum.on('accountsChanged', ()=> location.reload());
                window.ethereum.on('chainChanged', ()=> location.reload());

            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }

        // ====== loadDashboard (minerPool uses pToken unit as requested) ======
        async function loadDashboard(){
            if (!contract) return;
            try {
                const [poolBalance, minerPool, specialPool, entryFee] = await Promise.all([
                    contract.poolBalance().catch(()=>0),
                    contract.minerTokenPool().catch(()=>0),
                    contract.specialRewardPool().catch(()=>0),
                    contract.ENTRY_FEE().catch(()=>ENTRY_FEE)
                ]);

                // format and display
                document.getElementById('poolBalance').textContent = (ethers.formatEther(poolBalance).substring(0,12) || '0') + ' MATIC';
                // **ONLY minerPool uses pToken**
                document.getElementById('minerPool').textContent = (ethers.formatEther(minerPool).substring(0,12) || '0') + ' pToken';
                document.getElementById('specialPool').textContent = (ethers.formatEther(specialPool).substring(0,12) || '0') + ' MATIC';
                document.getElementById('entryFeeDisplay').textContent = (ethers.formatEther(entryFee) || '0') + ' MATIC';

                // user info
                const userInfo = await contract.getUserInfo(userAddress).catch(()=>null);
                if (userInfo) {
                    const userId = userInfo[0];
                    showStatus(`
                        <strong>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± #${userId}</strong><br>
                        ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${userInfo[6]} ÙˆØ§Ø­Ø¯<br>
                        ğŸ Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡: ${userInfo[7]}<br>
                        â›ï¸ Ù…Ø§ÛŒÙ†Ø±: ${userInfo[10] ? 'âœ…' : 'âŒ'}<br>
                        ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§: ${ethers.formatEther(userInfo[8])} MATIC
                    `, 'success');

                    // load tree multi-level
                    await loadTreeStructure(Number(userId));

                    // check owner
                    const owner = await contract.owner().catch(()=>null);
                    if (owner && owner.toLowerCase() === userAddress.toLowerCase()) {
                        isOwner = true;
                        document.getElementById('adminTab').style.display = 'block';
                    }
                }

            } catch (e) {
                console.error('loadDashboard error', e);
            }
        }

        // ====== helper to parse and wait tx but show pending UI ======
        async function handleTx(txPromise, targetId){
            try {
                showLoading(true);
                const tx = await txPromise;
                showPending(tx.hash, targetId);
                const receipt = await tx.wait();
                // success
                showTransactionLink(tx.hash, targetId);
                return receipt;
            } catch (err) {
                document.getElementById(targetId).innerHTML = `<div class="status error">âŒ Ø®Ø·Ø§: ${err.message}</div>`;
                throw err;
            } finally {
                showLoading(false);
            }
        }

        // ===== main actions (kept logic same but UI coverage improved) =====
        async function register(){
            const uplineCode = document.getElementById('uplineCode').value;
            const position = document.getElementById('position').value === 'true';
            if (!uplineCode){ alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }

            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...', 'info', 'registerResult');
                const txPromise = contract.register(uplineCode, position, { value: ENTRY_FEE });
                const receipt = await handleTx(txPromise, 'registerResult');
                showStatus(`
                    âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚<br>
                    ğŸ‰ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯<br>
                    ğŸ”— <a href="https://polygonscan.com/tx/${receipt.transactionHash}" target="_blank" class="tx-link">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ±Ø§Ú©Ù†Ø´</a>
                `, 'success', 'registerResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'registerResult');
            }
        }

        async function contribute(){
            const amount = document.getElementById('contribution').value;
            if (!amount || amount <= 0){ alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø´Ø§Ø±Ú©Øª...', 'info', 'minerResult');
                const txPromise = contract.contributeToMinerPool({ value: ethers.parseEther(amount) });
                const receipt = await handleTx(txPromise, 'minerResult');
                showStatus('âœ… Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'minerResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'minerResult');
            }
        }

        async function buyTokens(){
            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†...', 'info', 'minerResult');
                const txPromise = contract.buyMinerTokens();
                const receipt = await handleTx(txPromise, 'minerResult');
                showStatus('âœ… Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'minerResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'minerResult');
            }
        }

        async function distribute(){
            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§...', 'info', 'minerResult');
                const txPromise = contract.distributeMinerTokens();
                const receipt = await handleTx(txPromise, 'minerResult');
                showStatus('âœ… ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'minerResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'minerResult');
            }
        }

        async function withdrawPool(){
            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±...', 'info', 'withdrawResult');
                const txPromise = contract.withdrawPool();
                const receipt = await handleTx(txPromise, 'withdrawResult');
                showStatus('âœ… Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'withdrawResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'withdrawResult');
            }
        }

        async function withdrawSpecial(){
            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡...', 'info', 'withdrawResult');
                const txPromise = contract.withdrawSpecials();
                const receipt = await handleTx(txPromise, 'withdrawResult');
                showStatus('âœ… Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø¯Ø§Ø´Øª Ø´Ø¯', 'success', 'withdrawResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'withdrawResult');
            }
        }

        async function updateFee(){
            if (!isOwner){ alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯: ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯'); return; }
            const newFee = document.getElementById('newFee').value;
            if (!newFee){ alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            try {
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯...', 'info', 'adminResult');
                const txPromise = contract.updateEntryFee(newFee);
                const receipt = await handleTx(txPromise, 'adminResult');
                showStatus('âœ… Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success', 'adminResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'adminResult');
            }
        }

        async function removeMiners(){
            if (!isOwner){ alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯: ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯'); return; }
            const addressesText = document.getElementById('addresses').value;
            if (!addressesText){ alert('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
            const addresses = addressesText.split(',').map(a=>a.trim()).filter(a=>ethers.isAddress(a));
            if (addresses.length === 0){ alert('Ù‡ÛŒÚ† Ø¢Ø¯Ø±Ø³ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
            try {
                showStatus(`ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù ${addresses.length} Ù…Ø§ÛŒÙ†Ø±...`, 'info', 'adminResult');
                const txPromise = contract.batchRemoveMiners(addresses);
                const receipt = await handleTx(txPromise, 'adminResult');
                showStatus(`âœ… ${addresses.length} Ù…Ø§ÛŒÙ†Ø± Ø­Ø°Ù Ø´Ø¯Ù†Ø¯`, 'success', 'adminResult');
                await loadDashboard();
            } catch (err) {
                showStatus(`âŒ Ø®Ø·Ø§: ${err.message}`, 'error', 'adminResult');
            }
        }

        // ====== tabs and init ======
        function showTab(tabName){
            const tabs = ['dashboard','register','miner','actions','admin'];
            tabs.forEach(t => document.getElementById(t+'Tab').style.display = 'none');
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(tabName + 'Tab').style.display = 'block';
            // activate matching tab button
            const btns = Array.from(document.querySelectorAll('.tab-btn'));
            const btn = btns.find(b=> b.textContent.trim() === (tabName==='dashboard'?'Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯': tabName==='register'?'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…': tabName==='miner'?'Ù…Ø§ÛŒÙ†Ø±': tabName==='actions'?'Ø¹Ù…Ù„ÛŒØ§Øª':'Ù…Ø¯ÛŒØ±ÛŒØª'));
            if (btn) btn.classList.add('active');

            if (tabName === 'dashboard') loadDashboard();
        }

        window.onload = function(){
            console.log('SPS DApp (final) loaded');
            document.getElementById('connectBtn').onclick = connectWallet;

            // auto connect if accounts exist
            if (typeof window.ethereum !== 'undefined'){
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts=>{
                        if (accounts.length > 0) setTimeout(()=> connectWallet(), 800);
                    });
            }
        };
    </script>
</body>
</html>