<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPS DApp - Premium Edition</title>

<!-- ethers.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<style>
  /* ----------------- Theme (Original Blue-Purple) ----------------- */
  :root{
    --bg-1: #040615;
    --bg-2: #071029;
    --glass: rgba(255,255,255,0.03);
    --card: rgba(255,255,255,0.02);
    --muted: #9fb3cf;
    --primary: #3b82f6;
    --accent: #8b5cf6;
    --neon: #00ffd5;
    --neon-2: #7c3aed;
    --success: #10b981;
    --danger: #ef4444;
    --glass-border: rgba(255,255,255,0.04);
    --gold: #ffd700;
    --gold-light: rgba(255,215,0,0.15);
  }

  *{box-sizing:border-box;margin:0;padding:0}
  html[dir="rtl"]{ direction: rtl; }
  html[dir="ltr"]{ direction: ltr; }

  body{
    font-family: Inter, "Segoe UI", Tahoma, Arial, sans-serif;
    background:
      radial-gradient(800px 320px at 10% 10%, rgba(139,92,246,0.04), transparent),
      radial-gradient(700px 280px at 90% 90%, rgba(0,255,213,0.02), transparent),
      linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
    color: #e6eef8;
    min-height:100vh;
    padding:15px;
    -webkit-font-smoothing:antialiased;
    -moz-osx-font-smoothing:grayscale;
    overflow-x:hidden;
  }

  /* ---------- Simple Glow ---------- */
  .simple-glow {
    position: fixed; inset: 0; z-index: 0; pointer-events: none;
    background: radial-gradient(40% 25% at 10% 20%, rgba(124,58,237,0.03), transparent),
                radial-gradient(30% 20% at 90% 80%, rgba(0,255,213,0.02), transparent);
    mix-blend-mode: screen;
  }

  /* ---------- Container ---------- */
  .container{ max-width:1200px; margin:0 auto; position:relative; z-index:5; }

  /* ---------- Header ---------- */
  .header{
    display:flex; align-items:center; justify-content:space-between; gap:12px;
    background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:16px; padding:16px; border:1px solid var(--glass-border);
    box-shadow: 0 8px 32px rgba(2,8,20,0.6);
    position:relative; overflow:hidden;
    backdrop-filter: blur(10px) saturate(180%);
    margin-bottom: 16px;
  }

  /* ---------- Enhanced Gold Logo ---------- */
  .logo-premium{
    width:100px; height:50px; position:relative; display:flex; align-items:center; justify-content:center;
  }
  .logo-sparkle{
    position:absolute; width:100%; height:100%; 
    background: radial-gradient(circle at 30% 30%, rgba(255,215,0,0.3), transparent 50%),
                radial-gradient(circle at 70% 70%, rgba(59,130,246,0.2), transparent 50%);
    animation: sparkle 4s infinite alternate;
  }
  .logo-text{
    font-family: 'Arial Black', sans-serif; font-size:28px; font-weight:900;
    background: linear-gradient(45deg, #ffd700, #3b82f6, #ffd700);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
    background-clip: text;
    text-shadow: 0 0 20px rgba(255,215,0,0.3);
    letter-spacing: 2px;
  }
  .logo-sub{
    position:absolute; bottom:-8px; font-size:10px; color:var(--muted); 
    background: rgba(59,130,246,0.1); padding:2px 6px; border-radius:4px;
    border:1px solid rgba(59,130,246,0.2);
  }

  @keyframes sparkle{
    0%,100%{ opacity:0.3; transform:scale(1); }
    50%{ opacity:0.7; transform:scale(1.05); }
  }

  /* ---------- Status / language ---------- */
  .status-ind{ display:flex; gap:10px; align-items:center }
  .status-dot{ width:12px; height:12px; border-radius:50%; background:var(--danger); box-shadow:0 0 10px rgba(239,68,68,0.3) }
  .status-dot.connected{ background:var(--success); box-shadow:0 0 15px rgba(16,185,129,0.3) }
  .network-text{ font-weight:700; color:var(--muted) }

  .lang-switch{ display:flex; gap:6px; align-items:center }
  .lang-btn{ padding:6px 10px; border-radius:8px; border:1px solid var(--glass-border); cursor:pointer; background:transparent; color:var(--muted); font-weight:700; font-size:12px }
  .lang-btn.active{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:white; box-shadow:0 4px 15px rgba(59,130,246,0.2) }

  /* ---------- Contract Links ---------- */
  .contract-links{
    display:flex; gap:10px; margin:10px 0; flex-wrap:wrap; justify-content:center;
  }
  .contract-btn{
    padding:8px 12px; border-radius:8px; background:rgba(59,130,246,0.08); 
    border:1px solid rgba(59,130,246,0.15); color:var(--primary); 
    text-decoration:none; font-size:13px; font-weight:700; display:flex; 
    align-items:center; gap:6px; transition:all 0.2s;
  }
  .contract-btn:hover{
    background:rgba(59,130,246,0.15); transform:translateY(-1px);
    box-shadow:0 6px 15px rgba(59,130,246,0.15);
  }

  /* ---------- Tabs ---------- */
  .tabs{ display:flex; gap:6px; margin:12px 0; flex-wrap:wrap; z-index:5; }
  .tab-btn{ padding:10px 14px; border-radius:10px; background:transparent; border:1px solid var(--glass-border); color:var(--muted); cursor:pointer; font-weight:700; transition:all 0.2s }
  .tab-btn.active{ background: linear-gradient(90deg, rgba(59,130,246,0.12), rgba(139,92,246,0.06)); color:var(--primary); box-shadow: 0 6px 20px rgba(59,130,246,0.1); border-color:rgba(59,130,246,0.3); }

  /* ---------- Stats Grid ---------- */
  .stats-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(200px,1fr)); gap:12px; margin:12px 0; z-index:5; }
  .stat-box{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    padding:16px; border-radius:14px; border:1px solid var(--glass-border);
    box-shadow: 0 8px 25px rgba(2,8,20,0.6), inset 0 1px 0 rgba(255,255,255,0.01);
    position:relative; overflow:hidden; backdrop-filter: blur(8px) saturate(180%);
    transition: transform .3s ease;
  }
  .stat-box:hover { transform: translateY(-4px); }
  .stat-label{ color:var(--muted); font-size:13px; margin-bottom:8px; }
  .stat-value{ font-size:18px; font-weight:900; color:#dff5ff; }

  /* ---------- Commission Display in Actions ---------- */
  .commission-display{
    background: rgba(59,130,246,0.08); padding:12px; border-radius:10px;
    border:1px solid rgba(59,130,246,0.2); margin-bottom:15px;
    display:flex; justify-content:space-between; align-items:center;
  }
  .commission-label{ color:var(--muted); font-weight:700; }
  .commission-value{ color:var(--primary); font-size:20px; font-weight:900; }

  /* ---------- Grid Layout ---------- */
  .grid-2{ display:grid; grid-template-columns:1fr 1fr; gap:15px; margin-top:10px; z-index:5; }
  .card{ 
    padding:16px; border-radius:14px; border:1px solid var(--glass-border); 
    background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); 
    box-shadow: 0 8px 25px rgba(5,10,25,0.6); backdrop-filter: blur(8px);
  }

  /* ---------- Tree ---------- */
  .tree-container{ max-height:400px; overflow:auto; padding:10px; border-radius:10px; background:rgba(12,16,28,0.6); }
  .node{ padding:10px; border-radius:8px; margin-bottom:8px; background: rgba(12,16,28,0.8); border:1px solid rgba(59,130,246,0.1); display:flex; justify-content:space-between; align-items:center; gap:10px; }
  .meta{ color:var(--muted); font-size:12px; }

  /* ---------- Buttons ---------- */
  .btn{ padding:12px 16px; border-radius:10px; border:none; cursor:pointer; font-weight:800; transition:all 0.2s }
  .btn-primary{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:white; box-shadow: 0 6px 20px rgba(59,130,246,0.2); }
  .btn-success{ background: linear-gradient(90deg,var(--success),#34d399); color:#031612; }
  .btn-danger{ background: linear-gradient(90deg,var(--danger),#f87171); color:#2b0e0e; }
  .btn.disabled{ opacity:0.4; pointer-events:none; }

  .btn-group{ display:grid; grid-template-columns:repeat(auto-fit,minmax(140px,1fr)); gap:8px }

  /* ---------- Countdown ---------- */
  .countdown{ display:flex; align-items:center; gap:10px; justify-content:center; padding:12px; border-radius:12px; background: linear-gradient(90deg, rgba(59,130,246,0.04), rgba(124,58,237,0.03)); border:1px solid var(--glass-border); font-weight:900; }
  .time-segment{ display:flex; flex-direction:column; align-items:center; padding:6px 10px; border-radius:8px; background: rgba(255,255,255,0.02); min-width:60px; }
  .time-value{ font-size:16px; color:#e6f8ff; font-weight:900; }
  .time-label{ color:var(--muted); font-size:11px; }

  /* ---------- Form ---------- */
  .form-group { margin-bottom: 14px; }
  .form-label { display: block; margin-bottom: 6px; color: var(--muted); font-weight: 700; font-size: 14px; }
  .form-input { width: 100%; padding: 12px; border-radius: 8px; background: rgba(255,255,255,0.05); border: 1px solid var(--glass-border); color: white; font-size: 16px; }
  .form-input:focus { outline: none; border-color: var(--primary); }

  /* ---------- Loading ---------- */
  .loading{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.7); z-index:9999; align-items:center; justify-content:center }
  .spinner{ width:60px; height:60px; border-radius:50%; border:4px solid rgba(255,255,255,0.1); border-top-color:var(--primary); animation: spin 1s linear infinite; }
  @keyframes spin{ to{ transform: rotate(360deg) } }

  /* ---------- Footer ---------- */
  footer{ margin-top:15px; text-align:center; color:var(--muted); font-size:12px; z-index:5; position:relative; }

  /* ---------- Responsive ---------- */
  @media (max-width: 768px){
    .grid-2{ grid-template-columns:1fr }
    .stats-grid{ grid-template-columns:1fr 1fr }
    .header{ flex-direction:column; align-items:stretch; gap:10px }
    .logo-premium{ margin:0 auto }
  }

  @media (max-width: 480px){
    .stats-grid{ grid-template-columns:1fr }
    .btn-group{ grid-template-columns:1fr }
    body{ padding:10px }
  }
</style>
</head>
<body>
  <!-- Simple Glow -->
  <div class="simple-glow"></div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div style="display:flex;align-items:center;gap:12px">
        <!-- Enhanced Gold Logo -->
        <div class="logo-premium">
          <div class="logo-sparkle"></div>
          <div class="logo-text">SPS</div>
          <div class="logo-sub">PREMIUM</div>
        </div>

        <div class="status-ind">
          <div id="statusDot" class="status-dot"></div>
          <div id="networkStatus" class="network-text">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:10px">
        <div class="lang-switch">
          <button id="btn-fa" class="lang-btn">FA</button>
          <button id="btn-en" class="lang-btn">EN</button>
        </div>
        <div id="connectArea">
          <button id="connectBtn" class="btn-primary btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
        </div>
      </div>
    </div>

    <!-- Contract Links -->
    <div class="contract-links">
      <a href="https://polygonscan.com/address/0x7a7b06D49129B34976D07B3854d4D72D01588191" 
         target="_blank" class="contract-btn">
         ğŸ“„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ SPS
      </a>
      <a href="https://polygonscan.com/address/0x82F7dBe1792436d15bdA22bB3340bD3f45D614Fa#code" 
         target="_blank" class="contract-btn">
         ğŸ’ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ P-Token
      </a>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
      <button class="tab-btn" id="registerTabBtn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
      <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
      <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" onclick="showTab('admin')" id="adminTabBtn" style="display:none">Ù…Ø¯ÛŒØ±ÛŒØª</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboardTab">
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
          <div class="stat-value" id="poolBalance">0 MATIC</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
          <div class="stat-value" id="minerPool">0 pToken</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
          <div class="stat-value" id="specialPool">0 MATIC</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
          <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3>ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
          <div id="userInfo">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</div>
        </div>
        <div class="card">
          <h3>ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ</h3>
          <div class="tree-container" id="treeContainer">
            <div class="node">ğŸ”„ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Register (Hidden for users with ID) -->
    <div id="registerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
          <div id="registerDisabled" style="display:none; padding:20px; text-align:center; color:var(--muted);">
            <div style="font-size:48px; margin-bottom:10px">âœ…</div>
            <div style="font-weight:700; margin-bottom:10px">Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!</div>
            <div>Ù†ÛŒØ§Ø²ÛŒ Ø¨Ù‡ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…Ø¬Ø¯Ø¯ Ù†Ø¯Ø§Ø±ÛŒØ¯.</div>
          </div>
          <div id="registerForm">
            <div class="form-group">
              <label class="form-label">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label>
              <input id="uplineCode" class="form-input" type="number" placeholder="1"/>
            </div>
            <div class="form-group">
              <label class="form-label">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
              <select id="position" class="form-input">
                <option value="true">Ú†Ù¾</option>
                <option value="false">Ø±Ø§Ø³Øª</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="register()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
          </div>
          <div id="registerResult" style="margin-top:12px"></div>
        </div>
        <div class="card">
          <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
          <div id="registerInfo">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
        </div>
      </div>
    </div>

    <!-- Miner -->
    <div id="minerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>â›ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div class="form-group">
            <label class="form-label">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
            <input id="contribution" class="form-input" placeholder="0.1"/>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="contribute()">Ù…Ø´Ø§Ø±Ú©Øª</button>
            <button class="btn btn-primary" onclick="buyTokens()">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†</button>
            <button class="btn btn-success" onclick="distribute()">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
          </div>
          <div id="minerResult" style="margin-top:12px"></div>
        </div>
        <div class="card">
          <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div id="minerInfo">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§</div>
        </div>
      </div>
    </div>

    <!-- Actions (With Commission Display) -->
    <div id="actionsTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>ğŸ’¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
          
          <!-- Commission Display -->
          <div class="commission-display" id="commissionDisplay" style="display:none">
            <div class="commission-label">ØªØ¹Ø¯Ø§Ø¯ Ù¾ÙˆØ±Ø³Ø§Ù†Øªâ€ŒÙ‡Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØªÛŒ:</div>
            <div class="commission-value" id="userCommissions">0</div>
          </div>

          <div class="countdown" style="margin-bottom:12px">
            <div style="font-weight:700;margin-right:12px">Ø¢Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª:</div>
            <div id="poolTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="countdown" style="margin-bottom:12px">
            <div style="font-weight:700;margin-right:12px">Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ:</div>
            <div id="specialTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="btn-group" style="margin-top:10px">
            <button id="withdrawMainBtn" class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ</button>
            <button id="withdrawSpecialBtn" class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
          </div>
          <div id="withdrawResult" style="margin-top:12px"></div>
        </div>
        <div class="card">
          <h3>ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
          <div id="withdrawInfo">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
          <div class="form-group">
            <label class="form-label">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
            <input id="newFee" class="form-input" placeholder="300000000000000000000"/>
          </div>
          <button class="btn btn-danger" onclick="updateFee()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯</button>
          <div id="adminResult"></div>
        </div>
        <div class="card">
          <h3>ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</h3>
          <div class="form-group">
            <label class="form-label">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§)</label>
            <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
          </div>
          <button class="btn btn-danger" onclick="removeMiners()">Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</button>
        </div>
      </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div></div>

    <footer>âœ¨ SPS Network Premium Edition â€¢ Powered by Polygon</footer>
  </div>

<script>
/* ================= OPTIMIZED CODE ================= */

/* ================= TRANSLATIONS ================= */
const translations = {
  fa: { dashboard:"Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯", register:"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…", miner:"Ù…Ø§ÛŒÙ†Ø±", actions:"Ø¹Ù…Ù„ÛŒØ§Øª", admin:"Ù…Ø¯ÛŒØ±ÛŒØª",
        connect_wallet:"Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„" },
  en: { dashboard:"Dashboard", register:"Register", miner:"Miner", actions:"Operations", admin:"Admin",
        connect_wallet:"Connect Wallet" }
};
let lang = localStorage.getItem('sps_lang') || 'fa';
function t(k){ return translations[lang]?.[k] || k; }

/* ================= CONSTANTS ================= */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
const POLYGON_CHAIN_ID = "0x89";
const ENTRY_FEE = "300000000000000000000";

const CONTRACT_ABI = [
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"eligibleSpecialUserCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

/* ================= STATE ================= */
let provider, signer, contract, userAddress, isOwner = false, userHasId = false;

/* ================= OPTIMIZED UI FUNCTIONS ================= */
function showStatus(message, targetId = 'userInfo', type = 'info') {
  const el = document.getElementById(targetId);
  if (el) {
    el.innerHTML = message;
    el.style.color = type === 'error' ? 'var(--danger)' : type === 'success' ? 'var(--success)' : 'white';
  }
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

/* ================= COMMISSION DISPLAY ================= */
async function updateCommissionDisplay() {
  if (!contract || !userAddress) return;
  
  try {
    const userInfo = await contract.getUserInfo(userAddress);
    const commissionCount = Number(userInfo[6]); // balanceCount = ØªØ¹Ø¯Ø§Ø¯ Ù¾ÙˆØ±Ø³Ø§Ù†Øªâ€ŒÙ‡Ø§
    
    const commissionDisplay = document.getElementById('commissionDisplay');
    const commissionValue = document.getElementById('userCommissions');
    
    if (commissionCount > 0) {
      commissionDisplay.style.display = 'flex';
      commissionValue.textContent = commissionCount;
    } else {
      commissionDisplay.style.display = 'none';
    }
  } catch (error) {
    console.log('Could not load commission data:', error);
  }
}

/* ================= REGISTER TAB CONTROL ================= */
async function checkUserRegistration() {
  if (!contract || !userAddress) return;
  
  try {
    const userInfo = await contract.getUserInfo(userAddress);
    const userId = Number(userInfo[0]);
    
    userHasId = userId > 0;
    const registerTabBtn = document.getElementById('registerTabBtn');
    const registerForm = document.getElementById('registerForm');
    const registerDisabled = document.getElementById('registerDisabled');
    
    if (userHasId) {
      // Ú©Ø§Ø±Ø¨Ø± Ø¯Ø§Ø±Ø§ÛŒ ID Ø§Ø³Øª
      registerTabBtn.style.display = 'none';
      if (registerForm) registerForm.style.display = 'none';
      if (registerDisabled) registerDisabled.style.display = 'block';
      
      // Ø§Ú¯Ø± Ø¯Ø± ØªØ¨ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù‡Ø³ØªÛŒÙ…ØŒ Ø¨Ù‡ Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯ Ø¨Ø±Ùˆ
      if (document.getElementById('registerTab').style.display !== 'none') {
        showTab('dashboard');
      }
    } else {
      // Ú©Ø§Ø±Ø¨Ø± Ø¨Ø¯ÙˆÙ† ID Ø§Ø³Øª
      registerTabBtn.style.display = 'block';
      if (registerForm) registerForm.style.display = 'block';
      if (registerDisabled) registerDisabled.style.display = 'none';
    }
  } catch (error) {
    userHasId = false;
  }
}

/* ================= LANGUAGE SWITCHER ================= */
function initLanguage() {
  document.getElementById('btn-fa').onclick = () => setLanguage('fa');
  document.getElementById('btn-en').onclick = () => setLanguage('en');
  
  if (lang === 'fa') {
    document.getElementById('btn-fa').classList.add('active');
  } else {
    document.getElementById('btn-en').classList.add('active');
  }
}

function setLanguage(newLang) {
  lang = newLang;
  localStorage.setItem('sps_lang', lang);
  
  document.documentElement.setAttribute('dir', lang === 'en' ? 'ltr' : 'rtl');
  
  // Update active buttons
  document.getElementById('btn-fa').classList.remove('active');
  document.getElementById('btn-en').classList.remove('active');
  document.getElementById(`btn-${newLang}`).classList.add('active');
  
  // Update connect button
  document.getElementById('connectBtn').textContent = t('connect_wallet');
  
  // Update tab names
  const tabNames = ['dashboard', 'register', 'miner', 'actions', 'admin'];
  tabNames.forEach((tab, index) => {
    const btn = document.querySelectorAll('.tab-btn')[index];
    if (btn) btn.textContent = t(tab);
  });
}

/* ================= TRANSACTION HANDLER ================= */
async function handleTx(txPromise, targetId) {
  try {
    showLoading(true);
    const tx = await txPromise;
    
    showStatus(`â³ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯... <a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" style="color:var(--primary)">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>`, targetId);
    
    const receipt = await tx.wait();
    showStatus(`âœ… ØªØ±Ø§Ú©Ù†Ø´ ØªØ§ÛŒÛŒØ¯ Ø´Ø¯! <a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" style="color:var(--success)">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>`, targetId, 'success');
    
    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù…Ø¬Ø¯Ø¯ Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§
    await loadDashboardData();
    
    return receipt;
  } catch (error) {
    showStatus(`âŒ Ø®Ø·Ø§: ${error.message || 'ØªØ±Ø§Ú©Ù†Ø´ Ù†Ø§Ù…ÙˆÙÙ‚'}`, targetId, 'error');
    throw error;
  } finally {
    showLoading(false);
  }
}

/* ================= CORE FUNCTIONS ================= */
async function register() {
  if (userHasId) {
    alert('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!');
    return;
  }
  
  const uplineCode = document.getElementById('uplineCode').value;
  const position = document.getElementById('position').value === 'true';
  
  if (!uplineCode) {
    alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  try {
    const txPromise = contract.register(uplineCode, position, { value: ENTRY_FEE });
    await handleTx(txPromise, 'registerResult');
    await checkUserRegistration();
  } catch (error) {
    console.error('Register error:', error);
  }
}

async function contribute() {
  const amount = document.getElementById('contribution').value;
  if (!amount || amount <= 0) {
    alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  try {
    const txPromise = contract.contributeToMinerPool({ value: ethers.parseEther(amount) });
    await handleTx(txPromise, 'minerResult');
  } catch (error) {
    console.error('Contribute error:', error);
  }
}

async function buyTokens() {
  try {
    const txPromise = contract.buyMinerTokens();
    await handleTx(txPromise, 'minerResult');
  } catch (error) {
    console.error('Buy tokens error:', error);
  }
}

async function distribute() {
  try {
    const txPromise = contract.distributeMinerTokens();
    await handleTx(txPromise, 'minerResult');
  } catch (error) {
    console.error('Distribute error:', error);
  }
}

async function withdrawPool() {
  try {
    const txPromise = contract.withdrawPool();
    await handleTx(txPromise, 'withdrawResult');
  } catch (error) {
    console.error('Withdraw pool error:', error);
  }
}

async function withdrawSpecial() {
  try {
    const txPromise = contract.withdrawSpecials();
    await handleTx(txPromise, 'withdrawResult');
  } catch (error) {
    console.error('Withdraw special error:', error);
  }
}

async function updateFee() {
  const newFee = document.getElementById('newFee').value;
  if (!newFee) {
    alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  try {
    const txPromise = contract.updateEntryFee(newFee);
    await handleTx(txPromise, 'adminResult');
  } catch (error) {
    console.error('Update fee error:', error);
  }
}

async function removeMiners() {
  const addressesText = document.getElementById('addresses').value;
  if (!addressesText) {
    alert('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
    return;
  }
  
  const addresses = addressesText.split(',').map(addr => addr.trim()).filter(addr => addr.length > 0);
  if (addresses.length === 0) {
    alert('Ø¢Ø¯Ø±Ø³ Ù…Ø¹ØªØ¨Ø±ÛŒ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª');
    return;
  }
  
  try {
    const txPromise = contract.batchRemoveMiners(addresses);
    await handleTx(txPromise, 'adminResult');
  } catch (error) {
    console.error('Remove miners error:', error);
  }
}

/* ================= TIMERS ================= */
let poolTimerInterval = null;
let specialTimerInterval = null;

function startPoolTimer(lastWithdrawUnix = 0, cycleDuration = 0) {
  if (poolTimerInterval) clearInterval(poolTimerInterval);
  
  function updateTimer() {
    const now = Math.floor(Date.now() / 1000);
    const nextTime = lastWithdrawUnix + cycleDuration;
    const remaining = Math.max(0, nextTime - now);
    
    const container = document.getElementById('poolTimerSegments');
    if (!container) return;
    
    if (remaining === 0) {
      container.innerHTML = '<div style="color:var(--success);font-weight:700">Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª!</div>';
      document.getElementById('withdrawMainBtn').classList.remove('disabled');
    } else {
      const days = Math.floor(remaining / 86400);
      const hours = Math.floor((remaining % 86400) / 3600);
      const minutes = Math.floor((remaining % 3600) / 60);
      const seconds = remaining % 60;
      
      container.innerHTML = `
        <div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
        <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
        <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
      `;
      document.getElementById('withdrawMainBtn').classList.add('disabled');
    }
  }
  
  updateTimer();
  poolTimerInterval = setInterval(updateTimer, 1000);
}

function startSpecialTimer() {
  if (specialTimerInterval) clearInterval(specialTimerInterval);
  
  function updateSpecialTimer() {
    const now = new Date();
    const target = new Date(now);
    
    // Ù‡Ø± Ù…Ø§Ù‡ Ø±ÙˆØ² 3
    target.setUTCDate(3);
    target.setUTCHours(0, 0, 0, 0);
    
    if (now.getUTCDate() >= 3) {
      target.setUTCMonth(target.getUTCMonth() + 1);
    }
    
    const diff = Math.max(0, Math.floor((target - now) / 1000));
    
    const container = document.getElementById('specialTimerSegments');
    if (!container) return;
    
    const days = Math.floor(diff / 86400);
    const hours = Math.floor((diff % 86400) / 3600);
    const minutes = Math.floor((diff % 3600) / 60);
    
    container.innerHTML = `
      <div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
      <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
      <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
    `;
  }
  
  updateSpecialTimer();
  specialTimerInterval = setInterval(updateSpecialTimer, 60000); // Ù‡Ø± Ø¯Ù‚ÛŒÙ‚Ù‡ Ø¢Ù¾Ø¯ÛŒØª
}

/* ================= DASHBOARD LOADER ================= */
async function loadDashboardData() {
  if (!contract) return;
  
  try {
    const [poolBal, minerBal, specialBal, entryFee, lastWithdraw, cycleDuration] = await Promise.all([
      contract.poolBalance().catch(() => 0),
      contract.minerTokenPool().catch(() => 0),
      contract.specialRewardPool().catch(() => 0),
      contract.ENTRY_FEE().catch(() => ENTRY_FEE),
      contract.lastPoolWithdrawTime().catch(() => 0),
      contract.CYCLE_DURATION().catch(() => 0)
    ]);
    
    // Update stats
    document.getElementById('poolBalance').textContent = ethers.formatEther(poolBal).substring(0, 10) + ' MATIC';
    document.getElementById('minerPool').textContent = ethers.formatEther(minerBal).substring(0, 10) + ' pToken';
    document.getElementById('specialPool').textContent = ethers.formatEther(specialBal).substring(0, 10) + ' MATIC';
    document.getElementById('entryFeeDisplay').textContent = ethers.formatEther(entryFee) + ' MATIC';
    
    // Start timers
    startPoolTimer(Number(lastWithdraw), Number(cycleDuration));
    startSpecialTimer();
    
    // Load user info
    if (userAddress) {
      const userInfo = await contract.getUserInfo(userAddress).catch(() => null);
      if (userInfo) {
        const userId = Number(userInfo[0]);
        const isMiner = userInfo[10];
        const totalRewards = ethers.formatEther(userInfo[8]);
        
        showStatus(`
          <div><strong>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± #${userId}</strong></div>
          <div>ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${userInfo[6]}</div>
          <div>ğŸ Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡: ${userInfo[7]}</div>
          <div>â›ï¸ Ù…Ø§ÛŒÙ†Ø±: ${isMiner ? 'âœ…' : 'âŒ'}</div>
          <div>ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø¯Ø§Ø´: ${totalRewards} MATIC</div>
        `, 'userInfo', 'success');
        
        // Check if owner
        const owner = await contract.owner().catch(() => null);
        if (owner && owner.toLowerCase() === userAddress.toLowerCase()) {
          isOwner = true;
          document.getElementById('adminTabBtn').style.display = 'block';
        }
        
        // Update commission display
        await updateCommissionDisplay();
        
        // Check registration status
        await checkUserRegistration();
      }
    }
    
  } catch (error) {
    console.error('Load dashboard error:', error);
  }
}

/* ================= CONNECT WALLET ================= */
async function connectWallet() {
  if (typeof window.ethereum === 'undefined') {
    showStatus('âŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø§Ù†Ù†Ø¯ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯', 'userInfo', 'error');
    return;
  }
  
  try {
    showLoading(true);
    
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    
    // Check chain
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId !== POLYGON_CHAIN_ID) {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: POLYGON_CHAIN_ID }]
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: POLYGON_CHAIN_ID,
              chainName: 'Polygon Mainnet',
              nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
              rpcUrls: ['https://polygon-rpc.com'],
              blockExplorerUrls: ['https://polygonscan.com']
            }]
          });
        }
      }
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    // Initialize provider and contract
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    
    // Update UI
    document.getElementById('connectArea').innerHTML = `
      <div style="background:rgba(59,130,246,0.1);color:var(--primary);padding:8px 12px;border-radius:8px;font-weight:700;border:1px solid rgba(59,130,246,0.3)">
        âœ… ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}
      </div>
    `;
    
    // Update status
    document.getElementById('statusDot').classList.add('connected');
    document.getElementById('networkStatus').textContent = lang === 'en' ? 'Connected' : 'Ù…ØªØµÙ„';
    
    // Load data
    await loadDashboardData();
    
    showStatus('âœ… Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù…ØªØµÙ„ Ø´Ø¯', 'userInfo', 'success');
    
    // Listen for changes
    window.ethereum.on('accountsChanged', () => window.location.reload());
    window.ethereum.on('chainChanged', () => window.location.reload());
    
  } catch (error) {
    showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'userInfo', 'error');
  } finally {
    showLoading(false);
  }
}

/* ================= TAB MANAGEMENT ================= */
function showTab(tabName) {
  // Hide all tabs
  ['dashboard', 'register', 'miner', 'actions', 'admin'].forEach(tab => {
    document.getElementById(tab + 'Tab').style.display = 'none';
  });
  
  // Remove active class from all tabs
  document.querySelectorAll('.tab-btn').forEach(btn => {
    btn.classList.remove('active');
  });
  
  // Show selected tab
  document.getElementById(tabName + 'Tab').style.display = 'block';
  
  // Add active class to selected tab
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.textContent.trim() === t(tabName)) {
      btn.classList.add('active');
    }
  });
  
  // Special handling for register tab
  if (tabName === 'register' && userHasId) {
    showTab('dashboard');
    alert('Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯!');
    return;
  }
  
  // Load data for dashboard
  if (tabName === 'dashboard') {
    loadDashboardData();
  }
}

/* ================= INITIALIZATION ================= */
window.onload = function() {
  // Initialize language
  initLanguage();
  
  // Set up connect button
  document.getElementById('connectBtn').onclick = connectWallet;
  
  // Auto-connect if previously connected
  if (typeof window.ethereum !== 'undefined') {
    window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
      if (accounts.length > 0) {
        setTimeout(() => connectWallet(), 500);
      }
    });
  }
  
  // Initialize with dashboard
  showTab('dashboard');
};
</script>
</body>
</html>