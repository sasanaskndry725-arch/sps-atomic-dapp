<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPS DApp â€” Ultra Release (Premium + Radial Tree)</title>

<!-- ethers.js (logic unchanged) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<style>
:root{
  --bg-1:#040615; --bg-2:#071029;
  --muted:#9fb3cf; --primary:#3b82f6; --accent:#8b5cf6;
  --neon:#00ffd5; --neon-2:#7c3aed; --success:#10b981; --danger:#ef4444;
  --glass-border: rgba(255,255,255,0.04);
}
*{box-sizing:border-box;margin:0;padding:0}
html[dir="rtl"]{direction:rtl} html[dir="ltr"]{direction:ltr}
body{
  font-family: Inter, "Segoe UI", Tahoma, Arial, sans-serif;
  background:
    radial-gradient(800px 320px at 10% 10%, rgba(139,92,246,0.03), transparent),
    radial-gradient(700px 280px at 90% 90%, rgba(0,255,213,0.02), transparent),
    linear-gradient(180deg,var(--bg-1) 0%,var(--bg-2) 100%);
  color:#e6eef8; min-height:100vh; padding:20px; -webkit-font-smoothing:antialiased;
}

/* Canvas layers */
#neuralWave{position:fixed;inset:0;z-index:0;pointer-events:none;mix-blend-mode:screen}
#neonParticles, #confetti{position:fixed;inset:0;z-index:0;pointer-events:none}
#confetti{z-index:12000;display:none}

/* Layout */
.container{max-width:1200px;margin:0 auto;position:relative;z-index:5}
.header{
  display:flex;align-items:center;justify-content:space-between;gap:12px;
  background: linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
  border-radius:12px;padding:14px;border:1px solid var(--glass-border);
  box-shadow:0 12px 40px rgba(2,8,20,0.6);backdrop-filter:blur(6px) saturate(120%);
}

/* Logo */
.logo-3d{width:96px;height:46px;perspective:1000px;display:flex;align-items:center;justify-content:center}
.logo-card{width:96px;height:46px;display:flex;align-items:center;justify-content:center;border-radius:10px;position:relative;transform-style:preserve-3d;transition:transform .7s}
.logo-face{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;backface-visibility:hidden}
.logo-face.front svg{width:78px;height:28px}
.logo-face.back{transform:rotateY(180deg);font-weight:900;font-size:20px;color:var(--neon);text-shadow:0 0 12px rgba(0,255,213,0.18)}
.logo-glow{position:absolute;inset:-20%;z-index:-1;filter:blur(28px);opacity:0.6;border-radius:14px;background:
  radial-gradient(circle at 20% 30%, rgba(59,130,246,0.12), transparent 20%),
  radial-gradient(circle at 80% 70%, rgba(124,58,237,0.10), transparent 20%),
  radial-gradient(circle at 50% 50%, rgba(0,255,213,0.06), transparent 30%)}
@keyframes logoPulse{0%{transform:scale(0.985)}50%{transform:scale(1.02)}100%{transform:scale(0.985)}}
.logo-card.pulse{animation:logoPulse 3.6s ease-in-out infinite}

/* Status and language */
.status-ind{display:flex;gap:10px;align-items:center}
.status-dot{width:12px;height:12px;border-radius:50%;background:var(--danger);box-shadow:0 0 10px rgba(239,68,68,0.2)}
.status-dot.connected{background:var(--success);box-shadow:0 0 18px rgba(16,185,129,0.14)}
.network-text{font-weight:700;color:var(--muted)}
.lang-switch{display:flex;gap:8px;align-items:center}
.lang-btn{padding:8px 10px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);cursor:pointer;background:transparent;color:var(--muted);font-weight:700}
.lang-btn.active{background:linear-gradient(90deg,var(--primary),var(--accent));color:#041426;box-shadow:0 8px 26px rgba(59,130,246,0.12)}

/* Tabs */
.tabs{display:flex;gap:8px;margin:16px 0;flex-wrap:wrap;z-index:5}
.tab-btn{padding:10px 12px;border-radius:8px;background:transparent;border:1px solid rgba(255,255,255,0.02);color:var(--muted);cursor:pointer;font-weight:700}
.tab-btn.active{background:linear-gradient(90deg, rgba(59,130,246,0.12), rgba(139,92,246,0.06));color:var(--primary);box-shadow:0 10px 30px rgba(59,130,246,0.06)}

/* Cards */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:16px;margin:14px 0;z-index:5}
.stat-box{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:16px;border-radius:14px;border:1px solid var(--glass-border);box-shadow:0 12px 30px rgba(2,8,20,0.6);position:relative;overflow:hidden;backdrop-filter:blur(6px)}
.stat-label{color:var(--muted);font-size:13px;margin-bottom:8px}
.stat-value{font-size:18px;font-weight:900;color:#dff5ff;text-shadow:0 6px 18px rgba(59,130,246,0.06)}
.stat-box:hover{transform:translateY(-6px);transition:transform .28s}

/* Grid layout */
.grid-2{display:grid;grid-template-columns:1fr 1fr;gap:18px;margin-top:12px;z-index:5}
.card{padding:14px;border-radius:12px;border:1px solid var(--glass-border);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));box-shadow:0 12px 30px rgba(5,10,25,0.6);backdrop-filter:blur(6px)}
.help{color:var(--muted);margin-top:8px;font-size:13px}

/* Buttons */
.btn{padding:12px;border-radius:10px;border:none;cursor:pointer;font-weight:800}
.btn-primary{background:linear-gradient(90deg,var(--primary),var(--accent));color:white;box-shadow:0 12px 30px rgba(59,130,246,0.08)}
.btn-success{background:linear-gradient(90deg,var(--success),#34d399);color:#031612}
.btn-danger{background:linear-gradient(90deg,var(--danger),#f87171);color:#2b0e0e}
.btn.disabled{opacity:0.45;pointer-events:none;filter:grayscale(0.4)}
.btn-group{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px}

/* Countdown */
.countdown{display:flex;align-items:center;gap:12px;justify-content:center;padding:12px;border-radius:12px;background:linear-gradient(90deg, rgba(59,130,246,0.04), rgba(124,58,237,0.03));border:1px solid rgba(255,255,255,0.02);box-shadow:0 12px 30px rgba(11,26,43,0.6);font-weight:900}
.time-segment{display:flex;flex-direction:column;align-items:center;padding:8px 12px;border-radius:8px;background:rgba(255,255,255,0.01);min-width:64px}
.time-value{font-size:18px;color:#e6f8ff;font-weight:900;text-shadow:0 8px 20px rgba(59,130,246,0.08)}
.time-label{color:var(--muted);font-size:12px}

/* Loading */
.loading{display:none;position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:9999;align-items:center;justify-content:center}
.spinner{width:80px;height:80px;border-radius:50%;border:6px solid rgba(255,255,255,0.04);border-top-color:var(--neon);animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}

/* Trust toast */
.trust-toast{
  position:fixed;left:50%;transform:translateX(-50%);bottom:28px;background:linear-gradient(90deg,rgba(0,0,0,0.6),rgba(255,255,255,0.02));padding:12px 18px;border-radius:12px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 40px rgba(2,8,20,0.6);z-index:13000;display:flex;gap:12px;align-items:center;opacity:0;transition:opacity .28s,transform .28s
}
.trust-toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
.trust-toast .txlink{color:#9ecbff;text-decoration:none;font-weight:800}

/* Radial Tree container */
#radialTreeWrap{width:100%;height:520px;background:linear-gradient(180deg, rgba(255,255,255,0.005), transparent);border-radius:12px;border:1px solid var(--glass-border);position:relative;overflow:hidden}
#radialSVG{width:100%;height:100%}
.node-circle{cursor:pointer;transition:transform .18s}
.node-circle:hover{transform:scale(1.06)}

/* small labels */
.node-label{font-size:12px;fill:#e6eef8;font-weight:700;text-shadow:0 2px 6px rgba(0,0,0,0.6)}
.node-meta{font-size:11px;fill:var(--muted)}

/* responsive */
@media (max-width:980px){.grid-2{grid-template-columns:1fr}.header{flex-direction:column;align-items:flex-start}.logo-3d{margin-bottom:8px}}
</style>
</head>
<body>
  <!-- visuals -->
  <div id="neuralWave"></div>
  <canvas id="neonParticles"></canvas>
  <canvas id="confetti"></canvas>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div style="display:flex;align-items:center;gap:14px">
        <div class="logo-3d" aria-hidden="true">
          <div id="logoCard" class="logo-card pulse" role="img" aria-label="SPS Logo">
            <div class="logo-face front" id="logoFront">
              <svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <defs>
                  <linearGradient id="g1" x1="0" x2="1"><stop offset="0" stop-color="#3b82f6"/><stop offset="1" stop-color="#8b5cf6"/></linearGradient>
                  <filter id="neon" x="-50%" y="-50%" width="200%" height="200%"><feGaussianBlur stdDeviation="6" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
                </defs>
                <g filter="url(#neon)"><text x="50%" y="55%" text-anchor="middle" font-family="Inter, Tahoma, Arial" font-weight="800" font-size="36" fill="url(#g1)" style="letter-spacing:2px">SPS</text></g>
              </svg>
            </div>
            <div class="logo-face back" id="logoBack" aria-hidden="true">$</div>
            <div class="logo-glow" aria-hidden="true"></div>
          </div>
        </div>

        <div class="status-ind" aria-hidden="true">
          <div id="statusDot" class="status-dot"></div>
          <div id="networkStatus" class="network-text">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="lang-switch" role="tablist" aria-label="Language switch">
          <button id="btn-fa" class="lang-btn">FA</button>
          <button id="btn-en" class="lang-btn">EN</button>
        </div>
        <div id="connectArea">
          <button id="connectBtn" class="btn-primary btn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
        </div>
      </div>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
      <button class="tab-btn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
      <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
      <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn" onclick="showTab('admin')" id="adminTab" style="display:none">Ù…Ø¯ÛŒØ±ÛŒØª</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboardTab">
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label" id="label-poolBalance">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
          <div class="stat-value" id="poolBalance">0 MATIC</div>
        </div>

        <div class="stat-box">
          <div class="stat-label" id="label-minerPool">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
          <div class="stat-value" id="minerPool">0 pToken</div>
          <div style="margin-top:8px;color:var(--muted);font-size:13px" id="ptokenPriceInfo">Ù‚ÛŒÙ…Øª pToken: â€”</div>
        </div>

        <div class="stat-box">
          <div class="stat-label" id="label-specialPool">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
          <div class="stat-value" id="specialPool">0 MATIC</div>
        </div>

        <div class="stat-box">
          <div class="stat-label" id="label-entryFee">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
          <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3 id="h-userinfo">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
          <div id="userInfo" class="status info">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</div>
          <div class="help" id="help-userinfo">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ùˆ Ù„ÛŒÙ†Ú© ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø¯Ø± Ø§ÛŒÙ†Ø¬Ø§ Ù†Ø´Ø§Ù† Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</div>
          <div style="margin-top:10px" id="contractLinks" class="help">
            <!-- clickable contract links inserted here -->
          </div>
        </div>

        <div class="card">
          <h3 id="h-tree">ğŸŒŒ Ù†Ù‚Ø´Ù‡ Ø´Ø¨Ú©Ù‡ (Galaxy Radial)</h3>
          <div id="radialTreeWrap">
            <svg id="radialSVG" viewBox="0 0 1000 520" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
          <div class="help" id="help-tree">Ù†Ù…Ø§ÛŒØ´ ØªÙ…Ø§Ù… Ù†ÙˆØ¯Ù‡Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ù„Ø§ÛŒÙ‡â€ŒØ§ÛŒ â€” Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ù†ÙˆØ¯ Ø¨Ø±Ø§ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨ÛŒØ´ØªØ±.</div>
        </div>
      </div>
    </div>

    <!-- Register -->
    <div id="registerTab" style="display:none">
      <div class="grid-2">
        <div class="card" id="registerCard">
          <h3 id="h-register">ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
          <div class="form-group">
            <label class="form-label" id="label-upline">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label>
            <input id="uplineCode" class="form-input" type="number" placeholder="1"/>
          </div>
          <div class="form-group">
            <label class="form-label" id="label-position">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
            <select id="position" class="form-input">
              <option value="true">Ú†Ù¾</option>
              <option value="false">Ø±Ø§Ø³Øª</option>
            </select>
          </div>
          <button class="btn btn-primary" onclick="register()" id="btn-register">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
          <div id="registerResult"></div>
        </div>

        <div class="card">
          <h3 id="h-reginfo">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
          <div id="registerInfo" class="status info">Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯</div>
        </div>
      </div>
    </div>

    <!-- Miner -->
    <div id="minerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-miner">â›ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div class="form-group">
            <label class="form-label" id="label-contribution">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
            <input id="contribution" class="form-input" placeholder="0.1"/>
          </div>

          <div style="margin:8px 0;color:var(--muted)" id="ptokenPriceDisplay">Ù‚ÛŒÙ…Øª pToken: â€”</div>

          <div class="btn-group">
            <button class="btn btn-success" onclick="contribute()" id="btn-contrib">Ù…Ø´Ø§Ø±Ú©Øª</button>
            <button class="btn btn-primary" onclick="buyTokens()" id="btn-buy">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±</button>
            <button class="btn btn-success" onclick="distribute()" id="btn-distrib">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
          </div>

          <div id="minerResult" style="margin-top:12px"></div>
        </div>

        <div class="card">
          <h3 id="h-minerinfo">ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div id="minerInfo" class="status info">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§</div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div id="actionsTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-actions">ğŸ’¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>

          <div class="countdown" style="margin-bottom:12px">
            <div style="font-weight:700;margin-right:12px" id="poolTimerLabel">Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª</div>
            <div id="poolTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="countdown" style="margin-bottom:12px">
            <div style="font-weight:700;margin-right:12px" id="specialTimerLabel">Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ</div>
            <div id="specialTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="btn-group" style="margin-top:10px">
            <button id="withdrawMainBtn" class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ</button>
            <button id="withdrawSpecialBtn" class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
          </div>

          <div id="withdrawResult" style="margin-top:12px"></div>
        </div>

        <div class="card">
          <h3 id="h-withdrawinfo">ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
          <div id="withdrawInfo" class="status info">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§</div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3 id="h-admin">âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
          <div class="form-group">
            <label class="form-label" id="label-newFee">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
            <input id="newFee" class="form-input" placeholder="300000000000000000000"/>
          </div>
          <button class="btn btn-danger" onclick="updateFee()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯</button>
          <div id="adminResult"></div>
        </div>

        <div class="card">
          <h3 id="h-admin2">ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</h3>
          <div class="form-group">
            <label class="form-label" id="label-addresses">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§)</label>
            <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
          </div>
          <button class="btn btn-danger" onclick="removeMiners()">Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</button>
        </div>
      </div>
    </div>

    <div class="loading" id="loading"><div class="spinner"></div></div>

    <footer id="footerText" style="z-index:5;position:relative;margin-top:20px;text-align:center;color:var(--muted);font-size:13px">
      SPS Network â€¢ Polygon Mainnet
    </footer>
  </div>

  <!-- Trust toast (shows after confirmed tx) -->
  <div id="trustToast" class="trust-toast" role="status" aria-live="polite">
    <div id="trustIcon">âœ…</div>
    <div id="trustMessage" style="min-width:220px">ØªØ±Ø§Ú©Ù†Ø´ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯</div>
    <a id="trustLink" class="txlink" href="#" target="_blank" rel="noreferrer">View on Polygonscan</a>
  </div>

<script>
/* ================= TRANSLATIONS (Professional A) ================= */
const translations = {
  fa: { dashboard:"Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯", register:"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…", miner:"Ù…Ø§ÛŒÙ†Ø±", actions:"Ø¹Ù…Ù„ÛŒØ§Øª", admin:"Ù…Ø¯ÛŒØ±ÛŒØª",
        connect_wallet:"Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„", pool_balance:"Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±", miner_pool:"Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±",
        special_pool:"Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡", entry_fee:"Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯", user_info:"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ",
        tree_title:"Ù†Ù‚Ø´Ù‡ Ø´Ø¨Ú©Ù‡", register_label:"Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†", position:"Ù…ÙˆÙ‚Ø¹ÛŒØª",
        contribution:"Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)", buy_miner:"Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±", distribute:"ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§",
        withdraw_pool:"Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ", withdraw_special:"Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡",
        last_pool_label:"Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª", special_label:"Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ",
        registration_fee_text:"Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)", miner_info:"Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§", view_contract:"Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯" },
  en: { dashboard:"Dashboard", register:"Register", miner:"Miner", actions:"Operations", admin:"Admin",
        connect_wallet:"Connect Wallet", pool_balance:"Pool Balance", miner_pool:"Miner Pool",
        special_pool:"Special Reward", entry_fee:"Entry Fee", user_info:"User Info",
        tree_title:"Network Map", register_label:"Upline Code", position:"Position",
        contribution:"Contribution (MATIC)", buy_miner:"Buy Miner Token", distribute:"Distribute Tokens",
        withdraw_pool:"Withdraw Main Pool", withdraw_special:"Withdraw Special",
        last_pool_label:"Last Withdraw", special_label:"Next Special Withdraw",
        registration_fee_text:"Register (300 MATIC)", miner_info:"Your Miner Info", view_contract:"View Contract" }
};
let lang = localStorage.getItem('sps_lang') || 'fa';
function t(k){ return translations[lang] && translations[lang][k] ? translations[lang][k] : k; }

/* ================= CONSTANTS & ABI (NO LOGIC CHANGE) ================= */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
const PTOKEN_CONTRACT = "0x82F7dBe1792436d15bdA22bB3340bD3f45D614Fa";
const POLYGON_CHAIN_ID = "0x89";
const ENTRY_FEE = "300000000000000000000"; // 300 MATIC

const CONTRACT_ABI = [
  /* Full ABI kept as before - unchanged logic */
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},
  {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"eligibleSpecialUserCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"specialPointCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

/* ================= STATE ================= */
let provider, signer, contract, userAddress, isOwner=false;
let radialNodes = {}; // id -> node {id,left,right,leftCount,rightCount}
let radialEdges = []; // edges pairs
let userIdGlobal = 0;

/* ================= UI HELPERS ================= */
function showStatus(message, type='info', targetId='userInfo'){
  const el = document.getElementById(targetId);
  if(!el) return console.log('missing',targetId);
  el.className = `status ${type}`;
  el.innerHTML = message;
}
function showLoading(show){ const el=document.getElementById('loading'); if(el) el.style.display = show ? 'flex' : 'none'; }
function showPending(txHash,targetId){
  const link = `https://polygonscan.com/tx/${txHash}`;
  const el=document.getElementById(targetId);
  if(el) el.innerHTML = `<div class="status info">â³ Transaction sent â€” pending...<div style="margin-top:8px"><a href="${link}" target="_blank" class="txlink">View on Polygonscan</a></div></div>`;
}
function showTransactionLink(txHash,targetId){
  const link = `https://polygonscan.com/tx/${txHash}`;
  const el=document.getElementById(targetId);
  if(el) el.innerHTML = `<div class="status success">âœ… Transaction mined<div style="margin-top:8px"><a href="${link}" target="_blank" class="txlink">View on Polygonscan</a></div></div>`;
  // Show trust toast
  setTimeout(()=> showTrustToast(txHash), 250);
}

/* ============== Trust toast ============== */
let trustTimeout = null;
function showTrustToast(txHash){
  const toast = document.getElementById('trustToast');
  const link = `https://polygonscan.com/tx/${txHash}`;
  document.getElementById('trustLink').href = link;
  document.getElementById('trustMessage').textContent = lang==='en' ? `Transaction confirmed: ${txHash.substring(0,10)}...` : `ØªØ±Ø§Ú©Ù†Ø´ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯: ${txHash.substring(0,10)}...`;
  toast.classList.add('show');
  if(trustTimeout) clearTimeout(trustTimeout);
  trustTimeout = setTimeout(()=> { toast.classList.remove('show'); }, 8000);
}

/* ============== Confetti ============== */
const confettiCanvas = document.getElementById('confetti');
const confettiCtx = confettiCanvas.getContext ? confettiCanvas.getContext('2d') : null;
let confettiPieces = [];
function resizeConfetti(){ if(confettiCanvas){ confettiCanvas.width=window.innerWidth; confettiCanvas.height=window.innerHeight; } }
window.addEventListener('resize', resizeConfetti);
function spawnConfetti(){
  if(!confettiCtx) return;
  confettiCanvas.style.display='block';
  for(let i=0;i<120;i++){
    confettiPieces.push({x:Math.random()*confettiCanvas.width,y:-Math.random()*confettiCanvas.height,vx:(Math.random()-0.5)*6,vy:2+Math.random()*6,size:6+Math.random()*8,color:['#3b82f6','#8b5cf6','#00ffd5','#ffb86b'][Math.floor(Math.random()*4)],rot:Math.random()*360,rotV:(Math.random()-0.5)*10});
  }
  function draw(){
    confettiCtx.clearRect(0,0,confettiCanvas.width,confettiCanvas.height);
    confettiPieces.forEach((p,i)=>{
      confettiCtx.save(); confettiCtx.translate(p.x,p.y); confettiCtx.rotate(p.rot*Math.PI/180);
      confettiCtx.fillStyle=p.color; confettiCtx.fillRect(-p.size/2,-p.size/2,p.size,p.size*0.6); confettiCtx.restore();
      p.x+=p.vx; p.y+=p.vy; p.rot+=p.rotV;
      if(p.y>confettiCanvas.height+50) confettiPieces.splice(i,1);
    });
    if(confettiPieces.length>0) requestAnimationFrame(draw); else confettiCanvas.style.display='none';
  }
  draw();
}

/* ============== Neon Particles (premium) ============== */
const neonCanvas = document.getElementById('neonParticles');
const neonCtx = neonCanvas.getContext ? neonCanvas.getContext('2d') : null;
let neonParticles = [];
function resizeNeon(){ if(neonCanvas){ neonCanvas.width=window.innerWidth; neonCanvas.height=window.innerHeight; } }
window.addEventListener('resize', resizeNeon);
function initNeonParticles(count=70){
  neonParticles=[];
  for(let i=0;i<count;i++) neonParticles.push({x:Math.random()*window.innerWidth,y:Math.random()*window.innerHeight,r:1+Math.random()*3,vx:(Math.random()-0.5)*0.25,vy:(Math.random()-0.5)*0.45,hue:200+Math.random()*120,alpha:0.06+Math.random()*0.24,pulse:Math.random()*2+0.8,t:Math.random()*1000});
}
function drawNeon(){
  if(!neonCtx) return;
  neonCtx.clearRect(0,0,neonCanvas.width,neonCanvas.height);
  neonParticles.forEach(p=>{
    p.t+=0.01; p.x+=p.vx+Math.sin(p.t*0.4)*0.15; p.y+=p.vy+Math.cos(p.t*0.3)*0.12;
    if(p.x<-60) p.x=neonCanvas.width+60; if(p.x>neonCanvas.width+60) p.x=-60;
    if(p.y<-60) p.y=neonCanvas.height+60; if(p.y>neonCanvas.height+60) p.y=-60;
    const glowR = p.r*8 + Math.abs(Math.sin(p.t))*6;
    const g = neonCtx.createRadialGradient(p.x,p.y,0,p.x,p.y,glowR*1.6);
    g.addColorStop(0, `hsla(${p.hue},100%,65%,${p.alpha})`);
    g.addColorStop(1, `hsla(${(p.hue+40)%360},80%,55%,${p.alpha*0.06})`);
    neonCtx.fillStyle=g; neonCtx.beginPath(); neonCtx.arc(p.x,p.y,glowR,0,Math.PI*2); neonCtx.fill();
    neonCtx.fillStyle=`hsla(${p.hue},100%,70%,0.9)`; neonCtx.beginPath(); neonCtx.arc(p.x,p.y,p.r*(1+Math.abs(Math.sin(p.t))*0.6),0,Math.PI*2); neonCtx.fill();
  });
  requestAnimationFrame(drawNeon);
}
function startVisuals(){ resizeConfetti(); resizeNeon(); initNeonParticles(70); drawNeon(); }

/* ============== Language switcher ============== */
document.getElementById('btn-fa').onclick = ()=>{ lang='fa'; localStorage.setItem('sps_lang','fa'); document.getElementById('btn-fa').classList.add('active'); document.getElementById('btn-en').classList.remove('active'); setLanguage(); };
document.getElementById('btn-en').onclick = ()=>{ lang='en'; localStorage.setItem('sps_lang','en'); document.getElementById('btn-en').classList.add('active'); document.getElementById('btn-fa').classList.remove('active'); setLanguage(); };
if(lang==='fa') document.getElementById('btn-fa').classList.add('active'); else document.getElementById('btn-en').classList.add('active');

function setLanguage(){
  document.documentElement.setAttribute('dir', lang==='en' ? 'ltr' : 'rtl');
  const tabBtns = document.querySelectorAll('.tab-btn');
  if(lang==='fa'){ tabBtns[0].textContent = translations.fa.dashboard; tabBtns[1].textContent = translations.fa.register; tabBtns[2].textContent = translations.fa.miner; tabBtns[3].textContent = translations.fa.actions; tabBtns[4].textContent = translations.fa.admin; }
  else { tabBtns[0].textContent = translations.en.dashboard; tabBtns[1].textContent = translations.en.register; tabBtns[2].textContent = translations.en.miner; tabBtns[3].textContent = translations.en.actions; tabBtns[4].textContent = translations.en.admin; }

  document.getElementById('connectBtn').textContent = t('connect_wallet');
  document.getElementById('label-poolBalance').textContent = t('pool_balance');
  document.getElementById('label-minerPool').textContent = t('miner_pool');
  document.getElementById('label-specialPool').textContent = t('special_pool');
  document.getElementById('label-entryFee').textContent = t('entry_fee');
  document.getElementById('h-userinfo').textContent = t('user_info');
  document.getElementById('h-tree').textContent = t('tree_title');
  document.getElementById('label-upline').textContent = t('register_label');
  document.getElementById('label-position').textContent = t('position');
  document.getElementById('btn-register').textContent = t('registration_fee_text');
  document.getElementById('label-contribution').textContent = t('contribution');
  document.getElementById('btn-buy').textContent = t('buy_miner');
  document.getElementById('btn-distrib').textContent = t('distribute');
  document.getElementById('poolTimerLabel').textContent = `${t('last_pool_label')}:`;
  document.getElementById('specialTimerLabel').textContent = t('special_label');
  document.getElementById('h-actions').textContent = (lang==='en' ? 'Operations' : 'Ø¹Ù…Ù„ÛŒØ§Øª');
  document.getElementById('footerText').textContent = lang==='en' ? `SPS Network â€¢ Contract: ${CONTRACT_ADDRESS} â€¢ Polygon Mainnet` : `SPS Network â€¢ Contract: ${CONTRACT_ADDRESS} â€¢ Polygon Mainnet`;
}

/* ============== TX Handler (with trust popup and confetti) ============== */
async function handleTx(txPromise,targetId){
  try{
    showLoading(true);
    const tx = await txPromise;
    showPending(tx.hash,targetId);
    const receipt = await tx.wait();
    showTransactionLink(tx.hash,targetId);
    spawnConfetti();
    return receipt;
  }catch(err){
    const el=document.getElementById(targetId);
    if(el) el.innerHTML = `<div class="status error">âŒ ${err.message}</div>`;
    throw err;
  }finally{ showLoading(false); }
}

/* ============== Pre-checks before withdraw ============== */
async function canWithdrawPool(){
  try{
    if(!contract) return {ok:false, reason: lang==='en' ? 'Contract not initialized' : 'Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª'};
    const withdrawable = await contract.isPoolWithdrawable().catch(()=>false);
    if(!withdrawable) return {ok:false, reason: lang==='en' ? 'Pool is not withdrawable now' : 'Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª'};
    const poolBal = await contract.poolBalance().catch(()=>0);
    if(Number(poolBal) === 0) return {ok:false, reason: lang==='en' ? 'Pool balance is zero' : 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø± ØµÙØ± Ø§Ø³Øª'};
    const eligibleCount = await contract.eligiblePoolUserCount().catch(()=>0);
    if(Number(eligibleCount) === 0) return {ok:false, reason: lang==='en' ? 'No eligible users in this pool' : 'Ø¯Ø± Ø§ÛŒÙ† Ø¯ÙˆØ±Ù‡ Ú©Ø§Ø±Ø¨Ø±ÛŒ ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ· Ù†ÛŒØ³Øª'};
    return {ok:true, reason: ''};
  }catch(e){ console.error('canWithdrawPool error', e); return {ok:false, reason: lang==='en' ? 'Pre-check failed' : 'Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯'}; }
}

/* ============== CORE ACTIONS (unchanged logic) ============== */
async function register(){
  const uplineCode = document.getElementById('uplineCode').value;
  const position = document.getElementById('position').value === 'true';
  if(!uplineCode){ alert(lang==='en'?'Please enter upline code':'Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  try{
    showStatus('ğŸ”„ '+(lang==='en'?'Registering...':'Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...'), 'info', 'registerResult');
    const txPromise = contract.register(uplineCode, position, { value: ENTRY_FEE });
    const receipt = await handleTx(txPromise, 'registerResult');
    showStatus('âœ… '+(lang==='en'?'Registration successful':'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚'), 'success', 'registerResult');
    await loadDashboard();
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'registerResult'); }
}

async function contribute(){
  const amount = document.getElementById('contribution').value;
  if(!amount || amount <= 0){ alert(lang==='en'?'Enter valid amount':'Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  try{
    showStatus('ğŸ”„ '+(lang==='en'?'Sending contribution...':'Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø´Ø§Ø±Ú©Øª...'), 'info', 'minerResult');
    const txPromise = contract.contributeToMinerPool({ value: ethers.parseEther(amount) });
    await handleTx(txPromise, 'minerResult');
    showStatus('âœ… '+(lang==='en'?'Contribution success':'Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult');
    await loadDashboard();
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'minerResult'); }
}

async function buyTokens(){
  try{
    showStatus('ğŸ”„ '+(lang==='en'?'Buying tokens...':'Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†...'), 'info', 'minerResult');
    const txPromise = contract.buyMinerTokens();
    await handleTx(txPromise, 'minerResult');
    showStatus('âœ… '+(lang==='en'?'Purchase successful':'Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult');
    await loadDashboard();
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'minerResult'); }
}

async function distribute(){
  try{
    showStatus('ğŸ”„ '+(lang==='en'?'Distributing tokens...':'Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§...'), 'info', 'minerResult');
    const txPromise = contract.distributeMinerTokens();
    await handleTx(txPromise, 'minerResult');
    showStatus('âœ… '+(lang==='en'?'Distributed':'ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'minerResult');
    await loadDashboard();
  }catch(err){ showStatus('âŒ '+err.message, 'error', 'minerResult'); }
}

/* ============== Withdraws ============== */
async function withdrawPool(){
  try{
    showStatus('ğŸ”„ '+(lang==='en'?'Checking pool withdraw conditions...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø±Ø§ÛŒØ· Ø¨Ø±Ø¯Ø§Ø´Øª...'), 'info', 'withdrawResult');
    const check = await canWithdrawPool();
    if(!check.ok){
      showStatus(`â›” ${check.reason}`, 'error', 'withdrawResult');
      const btn=document.getElementById('withdrawMainBtn'); btn.classList.add('disabled'); setTimeout(()=>btn.classList.remove('disabled'),4000);
      return;
    }
    showStatus('ğŸ”„ '+(lang==='en'?'Withdrawing main pool...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±...'), 'info', 'withdrawResult');
    const txPromise = contract.withdrawPool();
    await handleTx(txPromise, 'withdrawResult');
    showStatus('âœ… '+(lang==='en'?'Withdraw success':'Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯'), 'success', 'withdrawResult');
    await loadDashboard();
  }catch(err){ console.error('withdrawPool error', err); showStatus('âŒ '+(err && err.message ? err.message : (lang==='en'?'Withdraw failed':'Ø¨Ø±Ø¯Ø§Ø´Øª Ù†Ø§Ù…ÙˆÙÙ‚')) , 'error', 'withdrawResult'); }
}

async function withdrawSpecial(){
  try{
    const eligible = await contract.eligibleSpecialUserCount().catch(()=>0);
    if(Number(eligible) === 0){
      showStatus((lang==='en'?'No eligible special rewards for you at this time':'Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ Ø¨Ø±Ø§ÛŒ Ø´Ù…Ø§ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯'), 'error', 'withdrawResult');
      const btn=document.getElementById('withdrawSpecialBtn'); btn.classList.add('disabled'); setTimeout(()=>btn.classList.remove('disabled'),4000);
      return;
    }
    showStatus('ğŸ”„ '+(lang==='en'?'Withdrawing special...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡...'), 'info', 'withdrawResult');
    const txPromise = contract.withdrawSpecials();
    await handleTx(txPromise, 'withdrawResult');
    showStatus('âœ… '+(lang==='en'?'Special withdrawn':'Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø¯Ø§Ø´Øª Ø´Ø¯'), 'success', 'withdrawResult');
    await loadDashboard();
  }catch(err){ console.error('withdrawSpecial error', err); showStatus('âŒ '+(err.message || (lang==='en'?'Special withdraw failed':'Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ù†Ø§Ù…ÙˆÙÙ‚')), 'error', 'withdrawResult'); }
}

/* ============== Timers (in Actions tab) ============== */
let poolTimerInterval=null, specialTimerInterval=null;
function startPoolTimer(lastWithdrawUnix=0, cycleDurationSec=0){
  if(poolTimerInterval) clearInterval(poolTimerInterval);
  function render(){
    const now=Math.floor(Date.now()/1000);
    const nextUnlock=(lastWithdrawUnix && cycleDurationSec) ? (lastWithdrawUnix + cycleDurationSec) : 0;
    let remaining = nextUnlock > now ? nextUnlock - now : 0;
    const lastDate = lastWithdrawUnix ? new Date(lastWithdrawUnix*1000).toUTCString() : 'â€”';
    document.getElementById('poolTimerLabel').textContent = `${t('last_pool_label')}: ${ lastWithdrawUnix ? lastDate : 'â€”' }`;
    const segContainer=document.getElementById('poolTimerSegments');
    const withdrawBtn=document.getElementById('withdrawMainBtn');
    if(remaining===0){ segContainer.innerHTML=`<div style="font-weight:700;color:var(--success)">${lang==='en'?'Withdrawable Now':'Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ú©Ù†ÙˆÙ†'}</div>`; withdrawBtn.classList.remove('disabled');}
    else {
      const days=Math.floor(remaining/86400); remaining%=86400; const hours=Math.floor(remaining/3600); remaining%=3600; const minutes=Math.floor(remaining/60); const seconds=remaining%60;
      segContainer.innerHTML = `<div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
        <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
        <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
        <div class="time-segment"><div class="time-value">${String(seconds).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Sec':'Ø«Ø§Ù†ÛŒÙ‡'}</div></div>`;
      withdrawBtn.classList.add('disabled');
    }
  }
  render(); poolTimerInterval=setInterval(render,1000);
}
function startSpecialTimer(){
  if(specialTimerInterval) clearInterval(specialTimerInterval);
  function renderSpecial(){
    const now=new Date(); const year=now.getUTCFullYear(); const month=now.getUTCMonth(); const day=now.getUTCDate();
    let target;
    if(day<3 || (day===3 && now.getUTCHours()<24)) target=new Date(Date.UTC(year,month,3,0,0,0));
    else target=new Date(Date.UTC(year,month+1,3,0,0,0));
    let diff=Math.floor((target-now)/1000); if(diff<0) diff=0;
    const days=Math.floor(diff/86400); diff%=86400; const hours=Math.floor(diff/3600); diff%=3600; const minutes=Math.floor(diff/60); const seconds=diff%60;
    const seg=document.getElementById('specialTimerSegments');
    seg.innerHTML = `<div class="time-segment"><div class="time-value">${String(days).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>
      <div class="time-segment"><div class="time-value">${String(hours).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Hours':'Ø³Ø§Ø¹Øª'}</div></div>
      <div class="time-segment"><div class="time-value">${String(minutes).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Min':'Ø¯Ù‚ÛŒÙ‚Ù‡'}</div></div>
      <div class="time-segment"><div class="time-value">${String(seconds).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Sec':'Ø«Ø§Ù†ÛŒÙ‡'}</div></div>`;
  }
  renderSpecial(); specialTimerInterval=setInterval(renderSpecial,1000);
}

/* ============== Radial Tree (Galaxy Orbit) ============== */
/*
  Approach:
  - BFS from user's id using contract.getUserDirects(id) to gather all reachable nodes.
  - Keep nodes map { id, leftId, rightId, leftCount, rightCount } and edges.
  - Render using SVG: center is user, nodes placed in concentric rings by depth.
  - Add a slow rotation animation on a <g> wrapper to produce orbit effect.
*/
const radialSVG = document.getElementById('radialSVG');

async function gatherTree(startId, maxNodes=2000){
  radialNodes = {}; radialEdges = [];
  const q=[{id:startId, depth:0}];
  radialNodes[startId] = { id:startId, left:0, right:0, leftCount:0, rightCount:0, depth:0 };
  let idx=0;
  while(q.length && Object.keys(radialNodes).length < maxNodes){
    const cur=q.shift();
    try{
      const directs = await contract.getUserDirects(cur.id).catch(()=>[0,0]);
      const leftId = Number(directs[0]) || 0; const rightId = Number(directs[1]) || 0;
      // fetch counts from special info if available
      const info = await contract._getSpecialUserInfoForMigrateToNewFork(cur.id).catch(()=>null);
      const leftCount = info ? Number(info[2]) : 0; const rightCount = info ? Number(info[3]) : 0;
      radialNodes[cur.id] = { id:cur.id, left:leftId, right:rightId, leftCount, rightCount, depth:cur.depth };
      if(leftId && !radialNodes[leftId]){ radialNodes[leftId] = { id:leftId, left:0, right:0, leftCount:0, rightCount:0, depth:cur.depth+1 }; q.push({id:leftId, depth:cur.depth+1}); radialEdges.push([cur.id,leftId]); }
      if(rightId && !radialNodes[rightId]){ radialNodes[rightId] = { id:rightId, left:0, right:0, leftCount:0, rightCount:0, depth:cur.depth+1 }; q.push({id:rightId, depth:cur.depth+1}); radialEdges.push([cur.id,rightId]); }
      // stop if very deep to avoid freezing
      idx++; if(idx>4000) break;
    }catch(e){ console.error('gatherTree err', e); break; }
  }
  // second pass: populate counts for nodes we added
  const ids = Object.keys(radialNodes).map(x=>Number(x));
  for(const id of ids.slice(0,1000)){
    try{
      const info = await contract._getSpecialUserInfoForMigrateToNewFork(id).catch(()=>null);
      if(info){ radialNodes[id].leftCount = Number(info[2]); radialNodes[id].rightCount = Number(info[3]); }
    }catch(e){}
  }
  return {nodes:radialNodes, edges:radialEdges};
}

function renderRadial(nodes, edges, centerLabel){
  // clear svg
  while(radialSVG.firstChild) radialSVG.removeChild(radialSVG.firstChild);
  const W = radialSVG.viewBox.baseVal.width || 1000;
  const H = radialSVG.viewBox.baseVal.height || 520;
  const cx = W/2; const cy = H/2;
  // group with rotation animation
  const gOrbit = document.createElementNS('http://www.w3.org/2000/svg','g');
  gOrbit.setAttribute('id','gOrbit');
  radialSVG.appendChild(gOrbit);

  // bucket nodes by depth
  const byDepth = {};
  let maxDepth = 0;
  for(const k in nodes){ const n=nodes[k]; maxDepth = Math.max(maxDepth, n.depth); if(!byDepth[n.depth]) byDepth[n.depth]=[]; byDepth[n.depth].push(n); }
  const rings = Math.max(1, maxDepth+1);
  const ringGap = Math.min(160, Math.floor((Math.min(W,H)/2 - 60) / (rings+1)));
  // draw edges as lines
  edges.forEach(e=>{
    const a = nodes[e[0]]; const b = nodes[e[1]];
    if(!a||!b) return;
    // positions will be computed after nodes placed - so we'll store edge references to connect later
  });

  // compute positions for nodes per depth
  const positions = {};
  for(let depth=0; depth<=maxDepth; depth++){
    const list = byDepth[depth] || [];
    const r = 40 + depth * ringGap;
    const count = list.length;
    for(let i=0;i<count;i++){
      // distribute nodes evenly on circle
      const angle = (2*Math.PI) * (i / Math.max(1,count));
      const x = cx + r * Math.cos(angle);
      const y = cy + r * Math.sin(angle);
      positions[list[i].id] = {x,y,angle,depth};
    }
  }
  // center node (depth 0) ensure center
  if(byDepth[0] && byDepth[0].length>0){
    const root = byDepth[0][0];
    positions[root.id] = {x:cx,y:cy,angle:0,depth:0};
  }

  // draw edges lines now
  edges.forEach(e=>{
    const a = positions[e[0]]; const b = positions[e[1]];
    if(!a||!b) return;
    const line = document.createElementNS('http://www.w3.org/2000/svg','line');
    line.setAttribute('x1',a.x); line.setAttribute('y1',a.y); line.setAttribute('x2',b.x); line.setAttribute('y2',b.y);
    line.setAttribute('stroke','rgba(124,58,237,0.12)'); line.setAttribute('stroke-width','1.6'); line.setAttribute('stroke-linecap','round');
    gOrbit.appendChild(line);
  });

  // draw nodes
  for(const idStr in nodes){
    const id = Number(idStr); const n = nodes[id];
    const pos = positions[id];
    if(!pos) continue;
    const gNode = document.createElementNS('http://www.w3.org/2000/svg','g');
    gNode.setAttribute('transform',`translate(${pos.x},${pos.y})`);
    gNode.setAttribute('data-id',id);
    // circle
    const circle = document.createElementNS('http://www.w3.org/2000/svg','circle');
    const radius = (n.depth===0) ? 18 : 12;
    circle.setAttribute('r', radius);
    circle.setAttribute('class','node-circle');
    // color by depth
    const hue = 200 + (n.depth * 20) % 140;
    const fill = (n.depth===0) ? 'url(#rootGrad)' : `rgba(124,58,237,0.18)`;
    circle.setAttribute('fill', fill);
    circle.setAttribute('stroke','rgba(255,255,255,0.04)'); circle.setAttribute('stroke-width','1.2');
    gNode.appendChild(circle);

    // label (id)
    const label = document.createElementNS('http://www.w3.org/2000/svg','text');
    label.setAttribute('class','node-label');
    label.setAttribute('text-anchor','middle');
    label.setAttribute('y','-22');
    label.textContent = `#${id}`;
    gNode.appendChild(label);

    // meta (counts)
    const meta = document.createElementNS('http://www.w3.org/2000/svg','text');
    meta.setAttribute('class','node-meta');
    meta.setAttribute('text-anchor','middle');
    meta.setAttribute('y','24');
    meta.textContent = `${lang==='en' ? 'L:' : 'Ú†Ù¾:'}${n.left ? '#'+n.left : 'â€”'} ${lang==='en' ? 'R:' : 'Ø±Ø§Ø³Øª:'}${n.right ? '#'+n.right : 'â€”'}`;
    gNode.appendChild(meta);

    // click handler
    gNode.style.cursor='pointer';
    gNode.addEventListener('click', ()=> {
      // show simple modal-like info: display in userInfo area
      const html = `<strong>ğŸ‘¤ ${lang==='en'?'User #':'Ú©Ø§Ø±Ø¨Ø± #'}${id}</strong><br>
        ${lang==='en'?'Left ID':'Ú†Ù¾'}: ${n.left ? '#'+n.left : 'â€”'} &nbsp; ${lang==='en'?'Right ID':'Ø±Ø§Ø³Øª'}: ${n.right ? '#'+n.right : 'â€”'}<br>
        ${lang==='en'?'Left Count':'ØªØ¹Ø¯Ø§Ø¯ Ú†Ù¾'}: ${n.leftCount} &nbsp; ${lang==='en'?'Right Count':'ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§Ø³Øª'}: ${n.rightCount}`;
      showStatus(html,'success','userInfo');
    });

    gOrbit.appendChild(gNode);
  }

  // add defs for root gradient
  const defs = document.createElementNS('http://www.w3.org/2000/svg','defs');
  const grad = document.createElementNS('http://www.w3.org/2000/svg','radialGradient');
  grad.setAttribute('id','rootGrad');
  const stop1 = document.createElementNS('http://www.w3.org/2000/svg','stop'); stop1.setAttribute('offset','0%'); stop1.setAttribute('stop-color','#3b82f6'); const stop2=document.createElementNS('http://www.w3.org/2000/svg','stop'); stop2.setAttribute('offset','100%'); stop2.setAttribute('stop-color','#8b5cf6');
  grad.appendChild(stop1); grad.appendChild(stop2); defs.appendChild(grad);
  radialSVG.insertBefore(defs, radialSVG.firstChild);

  // animate rotation (slow)
  let angle = 0;
  const rotateSpeed = 0.02; // degrees per frame - very slow
  function rotateFrame(){
    angle = (angle + rotateSpeed) % 360;
    gOrbit.setAttribute('transform',`rotate(${angle} ${W/2} ${H/2})`);
    requestAnimationFrame(rotateFrame);
  }
  rotateFrame();
}

/* ============== Gather + Render wrapper ============== */
async function loadRadialForUser(userId){
  try{
    // show loading placeholder
    const svg = document.getElementById('radialSVG');
    svg.innerHTML = `<text x="50%" y="50%" fill="#9fb3cf" text-anchor="middle">${lang==='en'?'Loading network map...':'Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù‚Ø´Ù‡ Ø´Ø¨Ú©Ù‡...'}</text>`;
    const result = await gatherTree(userId, 2000);
    renderRadial(result.nodes, result.edges);
  }catch(e){ console.error('loadRadialForUser', e); radialSVG.innerHTML = `<text x="50%" y="50%" fill="#ffb3b3" text-anchor="middle">${lang==='en'?'Error loading map':'Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ù†Ù‚Ø´Ù‡'}</text>`; }
}

/* ============== Dashboard loader (including pToken price & contract links) ============== */
async function loadDashboard(){
  if(!contract) return;
  try{
    const [poolBalance, minerPool, specialPool, entryFee, lastPoolWithdrawTime, cycleDuration, tokenPriceRaw] = await Promise.all([
      contract.poolBalance().catch(()=>0),
      contract.minerTokenPool().catch(()=>0),
      contract.specialRewardPool().catch(()=>0),
      contract.ENTRY_FEE().catch(()=>ENTRY_FEE),
      contract.lastPoolWithdrawTime().catch(()=>0),
      contract.CYCLE_DURATION().catch(()=>0),
      contract.getTokenPrice().catch(()=>0)
    ]);

    document.getElementById('poolBalance').textContent = (ethers.formatEther(poolBalance).substring(0,12) || '0') + ' MATIC';
    document.getElementById('minerPool').textContent = (ethers.formatEther(minerPool).substring(0,12) || '0') + ' pToken';
    document.getElementById('specialPool').textContent = (ethers.formatEther(specialPool).substring(0,12) || '0') + ' MATIC';
    document.getElementById('entryFeeDisplay').textContent = (ethers.formatEther(entryFee) || '0') + ' MATIC';

    // price handling: contract may return in wei or scaled units; try to format safely
    let priceText = 'â€”';
    try{
      const p = Number(ethers.formatEther(tokenPriceRaw));
      priceText = isFinite(p) ? `${p.toFixed(6)} MATIC` : 'â€”';
    }catch(e){ priceText='â€”'; }
    document.getElementById('ptokenPriceInfo').textContent = (lang==='en' ? 'pToken price: ' : 'Ù‚ÛŒÙ…Øª pToken: ') + priceText;
    document.getElementById('ptokenPriceDisplay').textContent = (lang==='en' ? 'pToken price: ' : 'Ù‚ÛŒÙ…Øª pToken: ') + priceText;

    // timers
    startPoolTimer(Number(lastPoolWithdrawTime), Number(cycleDuration));
    startSpecialTimer();

    // contract links
    const linksHtml = `<div><a href="https://polygonscan.com/address/${CONTRACT_ADDRESS}" target="_blank" rel="noreferrer" class="txlink">${lang==='en'?'Smart Contract':'Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ù‡ÙˆØ´Ù…Ù†Ø¯'}</a> Â· <a href="https://polygonscan.com/address/${PTOKEN_CONTRACT}#code" target="_blank" rel="noreferrer" class="txlink">${lang==='en'?'pToken Contract':'Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† p'}</a></div>`;
    document.getElementById('contractLinks').innerHTML = linksHtml;

    // load user info
    const userInfo = await contract.getUserInfo(userAddress).catch(()=>null);
    if(userInfo){
      const userId = Number(userInfo[0]); userIdGlobal = userId;
      if(userId && userId>0){
        // hide register tab and show active user name in its place
        document.getElementById('registerTab').style.display = 'none';
        document.getElementById('registerCard').style.display = 'none';
        showStatus(`<strong>ğŸ‘¤ ${lang==='en'?'User #':'Ú©Ø§Ø±Ø¨Ø± #'}${userId}</strong><br>ğŸ’° ${lang==='en'?'Total rewards':'Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§'}: ${ethers.formatEther(userInfo[8])} MATIC`, 'success', 'userInfo');
        // load radial map
        await loadRadialForUser(userId);
      } else {
        // no ID -> make register tab visible and prompt
        document.getElementById('registerTab').style.display = 'block';
        document.getElementById('registerCard').style.display = 'block';
        showStatus(lang==='en'?'No ID found â€” please register':'Ø´Ù…Ø§ Ù‡Ù†ÙˆØ² Ø´Ù†Ø§Ø³Ù‡ Ù†Ø¯Ø§Ø±ÛŒØ¯ â€” Ù„Ø·ÙØ§Ù‹ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯', 'info', 'userInfo');
        // empty radial map
        radialSVG.innerHTML = `<text x="50%" y="50%" fill="#9fb3cf" text-anchor="middle">${lang==='en'?'Connect and register to see your network':'Ø¨Ø±Ø§ÛŒ Ø¯ÛŒØ¯Ù† Ù†Ù‚Ø´Ù‡ØŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ ÙˆØµÙ„ Ùˆ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ú©Ù†ÛŒØ¯'}</text>`;
      }
      // owner?
      const owner = await contract.owner().catch(()=>null);
      if(owner && owner.toLowerCase() === userAddress.toLowerCase()){ isOwner=true; document.getElementById('adminTab').style.display='block'; }
    }
  }catch(e){ console.error('loadDashboard error', e); }
}

/* ============== Connect Wallet (no logic changes) ============== */
async function connectWallet(){
  if(typeof window.ethereum === 'undefined'){ showStatus('âŒ '+(lang==='en'?'Wallet (MetaMask) not found':'Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø«Ù„ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯'),'error'); return; }
  try{
    showLoading(true);
    showStatus('ğŸ”— '+(lang==='en'?'Connecting...':'Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...'), 'info');
    const accounts = await window.ethereum.request({ method:'eth_requestAccounts' });
    userAddress = accounts[0];
    const chainId = await window.ethereum.request({ method:'eth_chainId' });
    if(chainId !== POLYGON_CHAIN_ID){
      showStatus('ğŸ”„ '+(lang==='en'?'Switching to Polygon...':'ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Polygon...'),'info');
      try{ await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: POLYGON_CHAIN_ID }]}); }catch(e){ if(e.code === 4902){ await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{ chainId: POLYGON_CHAIN_ID, chainName:'Polygon Mainnet', nativeCurrency:{ name:'MATIC', symbol:'MATIC', decimals:18 }, rpcUrls:['https://polygon-rpc.com'], blockExplorerUrls:['https://polygonscan.com'] }]}); } }
      await new Promise(r=>setTimeout(r,1200));
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    document.getElementById('connectArea').innerHTML = `<div style="background:linear-gradient(90deg,#10b981,#34d399);color:#06281a;padding:10px;border-radius:8px;font-weight:700">âœ… ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}</div>`;
    updateNetworkStatus(true);
    await loadDashboard();
    showStatus('âœ… '+(lang==='en'?'Wallet connected':'Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯'), 'success');
    window.ethereum.on('accountsChanged', ()=> location.reload());
    window.ethereum.on('chainChanged', ()=> location.reload());
  }catch(err){ showStatus('âŒ '+err.message, 'error'); }finally{ showLoading(false); }
}
document.getElementById('connectBtn').onclick = connectWallet;

/* ============== Tabs ============== */
function showTab(tabName){
  const tabs = ['dashboard','register','miner','actions','admin'];
  tabs.forEach(t => { const el=document.getElementById(t+'Tab'); if(el) el.style.display='none'; });
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));
  const selected = document.getElementById(tabName + 'Tab'); if(selected) selected.style.display='block';
  document.querySelectorAll('.tab-btn').forEach(b=>{ if(b.textContent.trim() === (lang==='en'? translations.en[tabName] : translations.fa[tabName])) b.classList.add('active'); });
  if(tabName === 'dashboard') loadDashboard();
}

/* ============== Logo flip (robust) ============== */
const logoCard = document.getElementById('logoCard');
const logoFront = document.getElementById('logoFront');
const logoBack = document.getElementById('logoBack');
function showFront(){ logoFront.style.transform='rotateY(0deg)'; logoFront.style.opacity='1'; logoBack.style.transform='rotateY(180deg)'; logoBack.style.opacity='0'; logoCard.style.transform='rotateY(0deg)'; }
function showBack(){ logoFront.style.transform='rotateY(-180deg)'; logoFront.style.opacity='0'; logoBack.style.transform='rotateY(0deg)'; logoBack.style.opacity='1'; logoCard.style.transform='rotateY(180deg)'; }
function startLogoCycle(){ showFront(); setInterval(()=>{ showBack(); setTimeout(()=>showFront(),2000); },3000); }

/* ============== Init ============== */
window.onload = function(){
  startVisuals();
  startLogoCycle();
  setLanguage();
  document.getElementById('connectBtn').onclick = connectWallet;
  if(typeof window.ethereum !== 'undefined'){ window.ethereum.request({ method:'eth_accounts' }).then(accounts=>{ if(accounts.length>0) setTimeout(()=> connectWallet(),800); }); }
  resizeNeon(); resizeConfetti();
};

/* ============== Utility: network status ============== */
function updateNetworkStatus(connected){
  const dot = document.getElementById('statusDot'); const txt = document.getElementById('networkStatus');
  if(connected){ dot.classList.add('connected'); txt.textContent = lang==='en' ? 'Connected' : 'Ù…ØªØµÙ„'; }
  else { dot.classList.remove('connected'); txt.textContent = lang==='en' ? 'Disconnected' : 'Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„'; }
}
</script>
</body>
</html>
```î¨0î¨‚