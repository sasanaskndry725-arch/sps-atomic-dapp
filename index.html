<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPS Smart â€” Full DApp (with ABI)</title>

<!-- ethers v5 UMD -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<!-- Web3Modal + WalletConnect for mobile wallets (SafePal) -->
<script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<!-- d3 for tree -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  :root{
    --bg:#041022;
    --card:#0e1724;
    --accent:#7c3aed;
    --muted:#9fb0c8;
    --good:#10b981;
    --bad:#ef4444;
  }
  html,body{height:100%;margin:0;font-family: Vazirmatn, system-ui, Arial; background:linear-gradient(180deg,#031427 0%,#051022 100%); color:#e6eef8}
  /* matrix background */
  #matrix {
    position: fixed;
    inset: 0;
    z-index: 0;
    pointer-events:none;
    opacity:0.09;
    font-family:monospace;
    color:#00ff99;
    white-space: pre;
  }

  .wrap{max-width:1100px;margin:20px auto;padding:18px;position:relative;z-index:1}
  .card{background:rgba(255,255,255,0.02);border-radius:12px;padding:18px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
  header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
  h1{margin:0;font-size:22px;display:flex;align-items:center;gap:12px}
  .logo-badge{width:46px;height:46px;border-radius:10px;background:linear-gradient(135deg,#7c3aed,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:800;color:#fff;box-shadow:0 6px 18px rgba(124,58,237,0.25)}
  .muted{color:var(--muted);font-size:13px}
  .row{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
  input,select,button,textarea{padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#031426;color:#e6eef8}
  button{background:linear-gradient(90deg,#7c3aed,#00d4ff);border:none;color:white;padding:10px 12px;border-radius:8px;cursor:pointer}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06)}
  .grid{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
  pre{background:#031426;padding:12px;border-radius:8px;color:#cfe8ff;overflow:auto;font-size:13px;white-space:pre-wrap}
  .small{font-size:13px;color:var(--muted)}
  .status{padding:8px;border-radius:8px;margin-top:10px}
  .status.ok{background:rgba(16,185,129,0.08);color:var(--good)}
  .status.err{background:rgba(239,68,68,0.06);color:var(--bad)}
  footer{margin-top:16px;color:var(--muted);font-size:13px}
  #treeView{width:100%;height:420px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));overflow:hidden}
  .controls{display:flex;gap:8px;flex-wrap:wrap}
  @media(max-width:980px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
  <div id="matrix"></div>
  <div class="wrap">
    <div class="card">
      <header>
        <div style="display:flex;gap:12px;align-items:center">
          <div class="logo-badge">SPS</div>
          <div>
            <h1>SPS Smart â€” DApp Ø­Ø±ÙÙ‡â€ŒØ§ÛŒ</h1>
            <div class="muted">ÛŒÚ© DApp ØªÚ©â€ŒÙØ§ÛŒÙ„ÛŒ Ø¨Ø±Ø§ÛŒ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ØªÙˆ â€” Ú©Ø§Ù…Ù„ Ùˆ Ø¢Ù…Ø§Ø¯Ù‡</div>
          </div>
        </div>
        <div style="text-align:left;min-width:260px">
          <div id="walletShort" class="small">Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡</strong></div>
          <div style="display:flex;gap:8px;margin-top:8px" class="controls">
            <button id="connectBtn">ğŸ”— Ø§ØªØµØ§Ù„</button>
            <button id="wcBtn" class="secondary">ğŸ“± WalletConnect</button>
            <button id="disconnectBtn" class="secondary" style="display:none">ï‡¦ Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„</button>
          </div>
        </div>
      </header>

      <section style="margin-top:14px">
        <div class="grid">
          <div>
            <h3>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (Register)</h3>
            <div class="small">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…Ù‚Ø¯Ø§Ø± Ø«Ø§Ø¨Øª <strong>300 MATIC</strong> (Ù…Ø·Ø§Ø¨Ù‚Øª Ø¨Ø§ ENTRY_FEE Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ±Ø¶ Ø´Ø¯Ù‡)</div>

            <div class="row" style="margin-top:10px">
              <input id="uplineCode" placeholder="Upline code (Ø¹Ø¯Ø¯)" />
              <select id="placeSide">
                <option value="true">Ú†Ù¾</option>
                <option value="false">Ø±Ø§Ø³Øª</option>
              </select>
            </div>

            <div class="row" style="margin-top:10px">
              <button id="registerBtn">ğŸš€ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
              <button id="readFeeBtn" class="secondary">ğŸ” Ø®ÙˆØ§Ù†Ø¯Ù† ENTRY_FEE</button>
            </div>

            <div style="margin-top:8px">
              <div id="feeInfo" class="small" style="margin-top:6px;">ENTRY_FEE: â€”</div>
              <div id="regResult" style="margin-top:8px;"></div>
            </div>
          </div>

          <div>
            <h3>Ø¹Ù…Ù„ÛŒØ§Øª Ø³Ø±ÛŒØ¹</h3>
            <div class="row" style="margin-bottom:8px">
              <button id="contributeBtn">â• ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Miner Pool (payable)</button>
              <button id="buyMinerBtn">ğŸ’  buyMinerTokens()</button>
            </div>
            <div class="row">
              <button id="withdrawPoolBtn">ğŸ’¸ withdrawPool()</button>
              <button id="withdrawSpecialsBtn">ğŸ† withdrawSpecials()</button>
            </div>

            <div style="margin-top:12px">
              <h4>Ø´Ø¨Ú©Ù‡ / Ø­Ø³Ø§Ø¨</h4>
              <div id="chainInfo" class="small">Ø´Ø¨Ú©Ù‡: â€”</div>
              <div id="balanceInfo" class="small">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: â€”</div>
            </div>
          </div>
        </div>
      </section>

      <section style="margin-top:16px">
        <h3>Ø¬Ø³ØªØ¬ÙˆÛŒ Ú©Ø§Ø±Ø¨Ø± / Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
        <div class="row">
          <input id="lookupAddress" placeholder="Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ (Ø®Ø§Ù„ÛŒ = Ú©ÛŒÙ Ø´Ù…Ø§)" />
          <button id="getUserBtn">ğŸ” Ø¯Ø±ÛŒØ§ÙØª getUserInfo</button>
        </div>
        <pre id="resultBox">Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
      </section>

      <section style="margin-top:14px">
        <h3>Ø¢Ù…Ø§Ø± Miner</h3>
        <div class="row">
          <button id="minerStatsBtn">ğŸ“Š getMinerStats()</button>
          <button id="minerStatsByPercentBtn">Ùª getMinerStatsByPercent</button>
        </div>
      </section>

      <section style="margin-top:14px">
        <h3>Ø¯Ø±Ø®Øª Ø´Ø¨Ú©Ù‡ (Tree View)</h3>
        <div class="small">Ù†Ù…Ø§ÛŒØ´ Ø¯Ø±Ø®Øª Ø¯ÙˆØ¯ÙˆÛŒÛŒ Ø²ÛŒØ±Ø´Ø§Ø®Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§. Ø²ÙˆÙ… / Ø¯Ø±Ú¯ Ù‚Ø§Ø¨Ù„ Ø§Ù†Ø¬Ø§Ù… Ø§Ø³Øª.</div>
        <div style="display:flex;gap:8px;margin-top:8px">
          <button id="loadTreeBtn">ğŸ” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª Ù…Ù†</button>
          <input id="treeDepth" style="width:80px" placeholder="Ø¹Ù…Ù‚" value="3" />
        </div>
        <div id="treeView"></div>
      </section>

      <section style="margin-top:14px">
        <h3>Ù„Ø§Ú¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
        <pre id="logBox">Ø¢Ù…Ø§Ø¯Ù‡.</pre>
      </section>

      <div id="statusBox" class="status" style="display:none"></div>

      <footer>
        Ù†Ú©ØªÙ‡: Ø¨Ø±Ø§ÛŒ Ø§ØªØµØ§Ù„ SafePal Ù…ÙˆØ¨Ø§ÛŒÙ„ØŒ Ø§Ø² WalletConnect ÛŒØ§ Ù…Ø±ÙˆØ±Ú¯Ø± Ø¯Ø§Ø®Ù„ SafePal Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ÛŒØ¯.  
        Ù‚Ø¨Ù„ Ø§Ø² ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ÛŒ Ù…Ù‡Ù… Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± Ø´Ø¨Ú©Ù‡Ù” ØªØ³Øª (Mumbai) Ø¢Ø²Ù…Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.
      </footer>
    </div>
  </div>

<script>
/* ============================
   Config (Ø¢Ø¯Ø±Ø³ Ùˆ ABI Ø´Ù…Ø§)
   ============================ */

const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
document.getElementById('connectBtn').title = "Connect with MetaMask or in-app SafePal";
document.getElementById('wcBtn').title = "Connect via WalletConnect (SafePal, Trust Wallet)";

/* ==== ABI (ØªÙ…Ø§Ù…Ø§Ù‹ Ù…Ø·Ø§Ø¨Ù‚ Ø¢Ù†Ú†Ù‡ ÙØ±Ø³ØªØ§Ø¯ÛŒ) ==== */
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},{"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contributeToMinerPool","outputs[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}];

const POLYGON_CHAIN_ID = 137;
const POLYGON_CHAIN_HEX = '0x89';
const POLYGONSCAN_TX_PREFIX = 'https://polygonscan.com/tx/';

let web3Modal, walletProvider;
let provider, signer, contract;

/* UI elements */
const connectBtn = document.getElementById('connectBtn');
const wcBtn = document.getElementById('wcBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const readFeeBtn = document.getElementById('readFeeBtn');
const registerBtn = document.getElementById('registerBtn');
const getUserBtn = document.getElementById('getUserBtn');
const minerStatsBtn = document.getElementById('minerStatsBtn');
const minerStatsByPercentBtn = document.getElementById('minerStatsByPercentBtn');
const contributeBtn = document.getElementById('contributeBtn');
const buyMinerBtn = document.getElementById('buyMinerBtn');
const withdrawPoolBtn = document.getElementById('withdrawPoolBtn');
const withdrawSpecialsBtn = document.getElementById('withdrawSpecialsBtn');
const loadTreeBtn = document.getElementById('loadTreeBtn');

const walletShort = document.getElementById('walletShort');
const chainInfo = document.getElementById('chainInfo');
const balanceInfo = document.getElementById('balanceInfo');
const feeInfo = document.getElementById('feeInfo');
const resultBox = document.getElementById('resultBox');
const logBox = document.getElementById('logBox');
const statusBox = document.getElementById('statusBox');
const regResult = document.getElementById('regResult');
const treeView = document.getElementById('treeView');

function addLog(msg){
  const now = new Date().toLocaleTimeString();
  logBox.innerText = `[${now}] ${msg}\n` + logBox.innerText;
}

function setStatus(text, ok=true){
  statusBox.style.display = 'block';
  statusBox.className = 'status ' + (ok ? 'ok' : 'err');
  statusBox.innerText = text;
  setTimeout(()=>{ statusBox.style.display='none'; }, 7000);
}

/* Initialize Web3Modal for WalletConnect */
function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: {
        rpc: {
          137: "https://polygon-rpc.com"
        }
      }
    }
  };
  web3Modal = new window.Web3Modal.default({
    cacheProvider: false,
    providerOptions
  });
}

/* Ensure a read-only provider exists if not connected */
function ensureReadProvider(){
  if(!provider){
    provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
  }
}

/* Connect via injected wallet (MetaMask / SafePal in-app) */
async function connectInjected(){
  try {
    if(!window.ethereum) throw new Error('No injected wallet found');
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletShort.innerHTML = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>' + addr + '</strong>';
    disconnectBtn.style.display = 'inline-block';
    addLog('Connected (injected): ' + addr);
    await refreshNetworkAndBalance();
    setStatus('Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯');
  } catch(e){
    console.error(e);
    addLog('connectInjected error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„', false);
  }
}

/* Connect via Web3Modal (WalletConnect) */
async function connectWalletConnect(){
  try {
    walletProvider = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(walletProvider);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletShort.innerHTML = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>' + addr + '</strong>';
    disconnectBtn.style.display = 'inline-block';
    addLog('Connected (WalletConnect): ' + addr);
    await refreshNetworkAndBalance();
    setStatus('WalletConnect Ù…ØªØµÙ„ Ø´Ø¯');
    // handle disconnect
    walletProvider.on && walletProvider.on("disconnect", (code, reason) => {
      addLog('WalletConnect disconnected');
      walletProvider = null;
      provider = null;
      signer = null;
      contract = null;
      walletShort.innerText = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡';
      disconnectBtn.style.display = 'none';
    });
  } catch(e){
    console.error(e);
    addLog('connectWalletConnect error: ' + (e && e.message));
    setStatus('Ø§ØªØµØ§Ù„ WalletConnect Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯', false);
  }
}

/* Disconnect */
function disconnectWallet(){
  try {
    if(walletProvider && walletProvider.close) walletProvider.close();
  } catch(e){}
  provider = null;
  signer = null;
  contract = null;
  walletShort.innerText = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡';
  disconnectBtn.style.display = 'none';
  addLog('Disconnected');
}

/* Switch to Polygon if needed */
async function trySwitchToPolygon(){
  if(!window.ethereum) throw new Error('No injected wallet to switch');
  try {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_HEX }]});
    addLog('Switched to Polygon');
    setStatus('Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ Polygon ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
  } catch(switchError){
    // try to add chain
    if(switchError && switchError.code === 4902){
      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: POLYGON_CHAIN_HEX,
            chainName: 'Polygon Mainnet',
            nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
            rpcUrls: ['https://polygon-rpc.com'],
            blockExplorerUrls: ['https://polygonscan.com']
          }]
        });
        addLog('Polygon added to wallet');
        setStatus('Polygon Ø¨Ù‡ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
      } catch(err){ throw err; }
    } else throw switchError;
  }
}

/* refresh chain and balance */
async function refreshNetworkAndBalance(){
  try {
    if(!provider) return;
    const network = await provider.getNetwork();
    chainInfo.innerText = 'Ø´Ø¨Ú©Ù‡: ' + (network.name || network.chainId) + ' (' + network.chainId + ')';
    if(network.chainId !== POLYGON_CHAIN_ID){
      setStatus('Ø´Ø¨Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Polygon Ø¨Ø§Ø´Ø¯ â€” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ¦ÛŒÚ†...', false);
      try { await trySwitchToPolygon(); } catch(e){ addLog('Switch to polygon failed: ' + (e && e.message)); }
    }
    if(signer){
      const addr = await signer.getAddress();
      const bal = await provider.getBalance(addr);
      balanceInfo.innerText = 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ' + ethers.utils.formatEther(bal) + ' MATIC';
    }
  } catch(e){ console.error(e); }
}

/* Read ENTRY_FEE */
async function readEntryFee(){
  try {
    ensureReadProvider();
    const fee = await contract.ENTRY_FEE();
    const feeMatic = ethers.utils.formatEther(fee);
    feeInfo.innerText = `ENTRY_FEE = ${feeMatic} MATIC (${fee.toString()} wei)`;
    addLog('ENTRY_FEE read: ' + feeMatic + ' MATIC');
    return fee;
  } catch(e){
    console.error(e);
    addLog('readEntryFee error: ' + (e && e.message));
    setStatus('Ø®ÙˆØ§Ù†Ø¯Ù† ENTRY_FEE Ø®Ø·Ø§ Ø¯Ø§Ø¯', false);
    throw e;
  }
}

/* Register action: fixed 300 MATIC as requested */
async function registerAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.');
    const uplineRaw = document.getElementById('uplineCode').value.trim();
    if(!uplineRaw) return alert('Ù„Ø·ÙØ§Ù‹ upline code Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    const upline = Number(uplineRaw);
    const placeOnLeft = document.getElementById('placeSide').value === 'true';

    const valueToSend = ethers.utils.parseEther('300');

    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...');
    const tx = await contract.register(upline, placeOnLeft, { value: valueToSend });
    addLog('register tx submitted: ' + tx.hash);
    regResult.innerText = 'TX Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ' + tx.hash;
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    addLog('register confirmed: ' + tx.hash);
    setStatus('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    regResult.innerText = 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ â€” ' + tx.hash;
    await refreshNetworkAndBalance();
  } catch(e){
    console.error(e);
    addLog('register error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ' + (e && e.message), false);
    alert('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø´Ø¯: ' + (e && e.message));
  }
}

/* getUserInfo */
async function getUserInfoAction(){
  try {
    ensureReadProvider();
    let addr = document.getElementById('lookupAddress').value.trim();
    if(!addr){
      if(!signer) return alert('Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª Ùˆ Ø¢Ø¯Ø±Ø³ Ø¬Ø³ØªØ¬Ùˆ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡');
      addr = await signer.getAddress();
    }
    const info = await contract.getUserInfo(addr);
    const out = {
      id: info[0].toString(),
      uplineId: info[1].toString(),
      leftCount: info[2].toString(),
      rightCount: info[3].toString(),
      saveLeft: info[4].toString(),
      saveRight: info[5].toString(),
      balanceCount: info[6].toString(),
      specialBalanceCount: info[7].toString(),
      totalMinerRewards: info[8].toString(),
      entryPrice: ethers.utils.formatEther(info[9] || '0'),
      isMiner: info[10]
    };
    resultBox.innerText = JSON.stringify(out, null, 2);
    addLog('getUserInfo fetched for ' + addr);
  } catch(e){
    console.error(e);
    addLog('getUserInfo error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', false);
  }
}

/* getMinerStats (getMinerStats) */
async function getMinerStatsAction(){
  try {
    ensureReadProvider();
    const stats = await contract.getMinerStats();
    const out = {
      checkedOutPaidCount: stats[0].toString(),
      eligibleInProgressCount: stats[1].toString(),
      totalRemain: stats[2].toString(),
      networkerCount: stats[3].toString()
    };
    resultBox.innerText = JSON.stringify(out, null, 2);
    addLog('getMinerStats fetched');
  } catch(e){
    console.error(e);
    addLog('getMinerStats error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ø¢Ù…Ø§Ø±', false);
  }
}

/* getMinerStatsByPercent prompt */
async function getMinerStatsByPercentAction(){
  try {
    ensureReadProvider();
    const p = prompt('Ø¯Ø±ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 50):', '50');
    if(p === null) return;
    const percent = Number(p);
    if(isNaN(percent) || percent <1 || percent >100) return alert('Ø¯Ø±ØµØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 Ùˆ 100 Ø¨Ø§Ø´Ø¯');
    const res = await contract.getMinerStatsByPercent(percent);
    const out = { usersAbovePercent: res[0].toString(), totalRemaining: res[1].toString() };
    resultBox.innerText = JSON.stringify(out, null, 2);
    addLog('getMinerStatsByPercent fetched for ' + percent + '%');
  } catch(e){
    console.error(e);
    addLog('getMinerStatsByPercent error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§', false);
  }
}

/* contributeToMinerPool - payable */
async function contributeToMinerPoolAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    const raw = prompt('Ù…Ù‚Ø¯Ø§Ø± MATIC Ø¨Ø±Ø§ÛŒ ÙˆØ§Ø±ÛŒØ² (Ù…Ø«Ø§Ù„: 0.1):', '0.1');
    if(raw === null) return;
    const value = ethers.utils.parseEther(String(raw));
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙˆØ§Ø±ÛŒØ²...');
    const tx = await contract.contributeToMinerPool({ value });
    addLog('contribute tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('ÙˆØ§Ø±ÛŒØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    addLog('contribute confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('contribute error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±ÛŒØ²', false);
  }
}

/* buyMinerTokens */
async function buyMinerTokensAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ buyMinerTokens...');
    const tx = await contract.buyMinerTokens();
    addLog('buyMinerTokens tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('buyMinerTokens Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('buyMinerTokens confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('buyMinerTokens error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± buyMinerTokens', false);
  }
}

/* withdraws */
async function withdrawPoolAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ withdrawPool...');
    const tx = await contract.withdrawPool();
    addLog('withdrawPool tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('withdrawPool Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('withdrawPool confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('withdrawPool error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± withdrawPool', false);
  }
}

async function withdrawSpecialsAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ withdrawSpecials...');
    const tx = await contract.withdrawSpecials();
    addLog('withdrawSpecials tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('withdrawSpecials Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('withdrawSpecials confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('withdrawSpecials error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± withdrawSpecials', false);
  }
}

/* TREE: recursively fetch directs by userId up to depth */
async function fetchTreeById(userId, depth){
  if(userId === 0 || depth <= 0) return null;
  try {
    const directs = await contract.getUserDirects(userId);
    const leftId = Number(directs.leftId || directs[0]);
    const rightId = Number(directs.rightId || directs[1]);
    const node = { name: `ID ${userId}`, id: userId, children: [] };
    const leftNode = await fetchTreeById(leftId, depth-1);
    const rightNode = await fetchTreeById(rightId, depth-1);
    if(leftNode) node.children.push(leftNode);
    if(rightNode) node.children.push(rightNode);
    return node;
  } catch(e){
    return { name: `ID ${userId}`, id: userId, children: [] };
  }
}

async function loadTree(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª...');
    const myAddr = await signer.getAddress();
    const info = await contract.getUserInfo(myAddr);
    const myId = Number(info[0].toString());
    if(myId === 0){
      setStatus('Ø´Ù…Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ (id=0)', false);
      return;
    }
    const depth = Number(document.getElementById('treeDepth').value) || 3;
    const data = await fetchTreeById(myId, depth);
    drawTree(data || { name: `ID ${myId}`, children: [] });
    setStatus('Ø¯Ø±Ø®Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    addLog('Tree loaded for ID ' + myId);
  } catch(e){
    console.error(e);
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª', false);
    addLog('loadTree error: ' + (e && e.message));
  }
}

function drawTree(data){
  // clear
  treeView.innerHTML = '';
  const width = treeView.clientWidth;
  const height = 420;
  const svg = d3.select(treeView).append('svg').attr('width', width).attr('height', height);
  const g = svg.append('g').attr('transform', 'translate(40,20)');

  const root = d3.hierarchy(data);
  const treeLayout = d3.tree().size([width - 120, height - 80]);
  treeLayout(root);

  // links
  g.selectAll('path.link')
    .data(root.links())
    .enter()
    .append('path')
    .attr('class','link')
    .attr('d', d3.linkVertical()
      .x(d => d.x)
      .y(d => d.y))
    .attr('fill','none')
    .attr('stroke','#8a6bff')
    .attr('stroke-width',2)
    .attr('opacity',0.9);

  // nodes
  const node = g.selectAll('g.node')
    .data(root.descendants())
    .enter()
    .append('g')
    .attr('class','node')
    .attr('transform', d => `translate(${d.x},${d.y})`);

  node.append('circle')
    .attr('r', 20)
    .attr('fill', '#7c3aed')
    .attr('stroke','#fff')
    .attr('stroke-width',1.5)
    .on('mouseover', function(e,d){
      d3.select(this).transition().attr('r',26);
    })
    .on('mouseout', function(e,d){
      d3.select(this).transition().attr('r',20);
    });

  node.append('text')
    .attr('dy',5)
    .attr('text-anchor','middle')
    .attr('fill','#fff')
    .style('font-size','12px')
    .text(d => d.data.name);
}

/* MATRIX background generator (0/1) */
function createMatrix(){
  const rows = Math.floor(window.innerHeight/16);
  const cols = Math.floor(window.innerWidth/10);
  let out = '';
  for(let r=0;r<rows;r++){
    for(let c=0;c<cols;c++){
      out += Math.random()<0.5 ? '0' : '1';
    }
    out += '\n';
  }
  document.getElementById('matrix').textContent = out;
}
setInterval(createMatrix, 150);
createMatrix();

/* Wire UI */
initWeb3Modal();
ensureReadProvider();

connectBtn.addEventListener('click', async ()=> {
  // try injected first
  if(window.ethereum){
    await connectInjected();
  } else {
    await connectWalletConnect();
  }
});
wcBtn.addEventListener('click', async ()=> { await connectWalletConnect(); });
disconnectBtn.addEventListener('click', disconnectWallet);

readFeeBtn && readFeeBtn.addEventListener('click', async ()=> { await readEntryFee(); });
registerBtn && registerBtn.addEventListener('click', async ()=> { await registerAction(); });
document.getElementById('getUserBtn')?.addEventListener('click', async ()=> { await getUserInfoAction(); });
minerStatsBtn && minerStatsBtn.addEventListener('click', async ()=> { await getMinerStatsAction(); });
minerStatsByPercentBtn && minerStatsByPercentBtn.addEventListener('click', async ()=> { await getMinerStatsByPercentAction(); });
contributeBtn && contributeBtn.addEventListener('click', async ()=> { await contributeToMinerPoolAction(); });
buyMinerBtn && buyMinerBtn.addEventListener('click', async ()=> { await buyMinerTokensAction(); });
withdrawPoolBtn && withdrawPoolBtn.addEventListener('click', async ()=> { await withdrawPoolAction(); });
withdrawSpecialsBtn && withdrawSpecialsBtn.addEventListener('click', async ()=> { await withdrawSpecialsAction(); });
loadTreeBtn && loadTreeBtn.addEventListener('click', async ()=> { await loadTree(); });

addLog('DApp loaded (ABI embedded).');

</script>
</body>
</html>
