<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>SPS Smart â€” Ultra Pro DApp</title>

  <!-- Meta for PWA-like behaviour (single-file) -->
  <meta name="theme-color" content="#041022">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

  <!-- Ethers v5, Web3Modal, WalletConnect, D3 (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>

  <style>
    :root{
      --bg:#041022; --card:#0e1724; --accent:#7c3aed; --muted:#9fb0c8;
      --glass: rgba(255,255,255,0.03);
      --glass-2: rgba(255,255,255,0.02);
      --success:#10b981; --danger:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family: Vazirmatn, system-ui, Arial, "Noto Sans";}
    body{background: radial-gradient(ellipse at top left,#052135 0%, #041022 40%, #020612 100%); color:#e6eef8;-webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;}
    .wrap{max-width:1100px;margin:18px auto;padding:18px;position:relative}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:18px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(255,255,255,0.03)}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo-badge{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-size:18px;box-shadow:0 8px 24px rgba(124,58,237,0.18);transform:translateY(0);transition:transform .18s ease}
    .logo-badge:hover{transform:translateY(-4px) rotate(-3deg)}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    button{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 8px 18px rgba(124,58,237,0.14);transition:transform .14s,box-shadow .14s}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.05);color:var(--muted);box-shadow:none}
    button:hover{transform:translateY(-3px)}
    .row{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    input,select,textarea{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:#e6eef8;min-width:0}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:16px;margin-top:14px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
    pre{background:transparent;padding:12px;border-radius:10px;color:#cfe8ff;overflow:auto;font-size:13px;white-space:pre-wrap}
    .small{font-size:13px;color:var(--muted)}
    .status{padding:8px;border-radius:8px;margin-top:10px}
    .status.ok{background:rgba(16,185,129,0.06);color:var(--success)}
    .status.err{background:rgba(239,68,68,0.06);color:var(--danger)}
    #treeView{width:100%;height:340px;border-radius:10px;border:1px solid rgba(255,255,255,0.04);background:linear-gradient(180deg, rgba(255,255,255,0.005), rgba(255,255,255,0.01));overflow:hidden}
    .fancy-btn{display:inline-flex;align-items:center;gap:8px}
    .logo-small{width:18px;height:18px;border-radius:4px;background:linear-gradient(135deg,#7c3aed,#00d4ff);display:inline-flex;align-items:center;justify-content:center;font-weight:800;color:#fff;font-size:11px}
    /* animated pulse for CTA */
    .pulse{position:relative}
    .pulse:after{content:'';position:absolute;inset:-6px;border-radius:12px;background:linear-gradient(90deg, rgba(124,58,237,0.06), rgba(0,212,255,0.04));filter:blur(8px);opacity:0;animation:pulse 2.6s infinite}
    @keyframes pulse{0%{opacity:0}30%{opacity:1}70%{opacity:0}100%{opacity:0}}
    /* subtle glass buttons */
    .glass{backdrop-filter: blur(6px)}
    /* tiny icons */
    .icon{font-size:14px}
    footer{margin-top:14px;color:var(--muted);font-size:13px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo-badge">SPS</div>
          <div>
            <h1>SPS Smart â€” Ultra Pro DApp</h1>
            <div class="muted">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: <a id="contractLink" target="_blank" rel="noreferrer" class="muted"></a></div>
          </div>
        </div>

        <div class="controls" style="min-width:280px">
          <div style="text-align:left">
            <div id="walletShort" class="small">Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡</strong></div>
            <div id="chainInfo" class="small">Ø´Ø¨Ú©Ù‡: â€”</div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="connectBtn" class="pulse">ğŸ”— Ø§ØªØµØ§Ù„</button>
            <button id="wcBtn" class="secondary">ğŸ“± WalletConnect</button>
            <button id="disconnectBtn" class="secondary" style="display:none">âŒ Ù‚Ø·Ø¹</button>
          </div>
        </div>
      </header>

      <div class="grid" role="main">
        <!-- Left: interactions -->
        <div>
          <div class="panel">
            <h3>Ø¹Ù…Ù„ÛŒØ§Øª Ø§ØµÙ„ÛŒ â€” (Ù…Ù‡Ù…)</h3>
            <div class="small">ØªÙ…Ø§Ù… ØªÙˆØ§Ø¨Ø¹ Ù…Ù‡Ù… Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø§ÛŒÙ†Ø¬Ø§ Ù‡Ø³ØªÙ†Ø¯. Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù‡Ù…ÛŒØ´Ù‡ <strong>Û³Û°Û° MATIC</strong> Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒÚ©Ù†Ø¯.</div>

            <div class="row" style="margin-top:12px">
              <input id="uplineCode" placeholder="Upline code (Ø¹Ø¯Ø¯)" />
              <select id="placeSide"><option value="true">Ú†Ù¾</option><option value="false">Ø±Ø§Ø³Øª</option></select>
            </div>

            <div class="row" style="margin-top:10px">
              <button id="readFeeBtn" class="secondary">ğŸ” Ø®ÙˆØ§Ù†Ø¯Ù† ENTRY_FEE</button>
              <button id="registerBtn" class="fancy-btn pulse">ğŸš€ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… â€” 300 MATIC</button>
            </div>

            <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap">
              <button id="buyMinerBtn" class="fancy-btn">ğŸ’  buyMinerTokens()</button>
              <button id="contributeBtn" class="secondary">â• contributeToMinerPool (payable)</button>
              <button id="withdrawPoolBtn" class="fancy-btn">ğŸ’¸ withdrawPool()</button>
              <button id="withdrawSpecialsBtn" class="fancy-btn">ğŸ† withdrawSpecials()</button>
            </div>

            <div style="margin-top:12px">
              <div id="feeInfo" class="small">ENTRY_FEE: â€”</div>
              <div id="statusBox" class="status" style="display:none"></div>
            </div>
          </div>

          <div class="panel" style="margin-top:12px">
            <h3>Ø¬Ø³ØªØ¬ÙˆÛŒ ÛŒÙˆØ²Ø± / Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h3>
            <div class="row">
              <input id="lookupAddress" placeholder="Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ (Ø®Ø§Ù„ÛŒ = Ú©ÛŒÙ Ø´Ù…Ø§)" />
              <button id="getUserBtn" class="secondary">ğŸ” getUserInfo()</button>
            </div>
            <pre id="resultBox" style="height:140px">Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
          </div>

          <div class="panel" style="margin-top:12px">
            <h3>Ù„Ø§Ú¯ Ùˆ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§</h3>
            <div class="small">Ù‡Ø± ØªØ±Ø§Ú©Ù†Ø´ Ø¨Ø§Ø² Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ø¯Ø± Polygonscan</div>
            <pre id="logBox" style="height:120px">Ø¢Ù…Ø§Ø¯Ù‡.</pre>
          </div>
        </div>

        <!-- Right: Tree & stats -->
        <div>
          <div class="panel">
            <h3>Ø¯Ø±Ø®Øª Ø´Ø¨Ú©Ù‡ (Tree View)</h3>
            <div class="small">Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ: Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ùˆ ÙˆØµÙ„ Ú©Ù†ØŒ Ø¨Ø¹Ø¯ Ø¯Ú©Ù…Ù‡ Ù„ÙˆØ¯ Ø±Ùˆ Ø¨Ø²Ù†.</div>
            <div class="row" style="margin-top:8px">
              <input id="treeDepth" placeholder="Ø¹Ù…Ù‚" value="3" style="width:90px"/>
              <button id="loadTreeBtn" class="secondary">ğŸ” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª</button>
            </div>
            <div id="treeView" style="margin-top:10px;height:340px;"></div>
          </div>

          <div class="panel" style="margin-top:12px">
            <h3>Ø¢Ù…Ø§Ø± / Ø´Ø¨Ú©Ù‡</h3>
            <div class="row">
              <div class="small">Ù…ÙˆØ¬ÙˆØ¯ÛŒ:</div><div id="balanceInfo" class="small">â€”</div>
            </div>
            <div style="margin-top:8px">
              <button id="minerStatsBtn" class="secondary">ğŸ“Š getMinerStats()</button>
              <button id="minerStatsByPercentBtn" class="secondary">Ùª getMinerStatsByPercent</button>
            </div>
            <pre id="statsBox" style="height:120px;margin-top:8px">Ø¢Ù…Ø§Ø± Ø§ÛŒÙ†Ø¬Ø§ Ø¸Ø§Ù‡Ø± Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
          </div>
        </div>
      </div>

      <footer class="muted">
        ØªÙˆØ¬Ù‡: Ø§ÛŒÙ† DApp Ø¨Ø±Ø§ÛŒ Polygon Mainnet Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù‡. Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ Ù…Ù‚Ø§Ø¯ÛŒØ± Ø¨Ø§Ù„Ø§ (Ù…Ø«Ù„ 300 MATIC) Ø­ØªÙ…Ø§Ù‹ Ø¯Ø± ØªØ³Øªâ€ŒÙ†Øª Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.
      </footer>
    </div>
  </div>

<script>
/* ============================
   CONFIG
   (Ø¢Ø¯Ø±Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ + ABI Ø§Ø² Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§)
   ============================ */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
document.getElementById('contractLink').href = 'https://polygonscan.com/address/' + CONTRACT_ADDRESS;
document.getElementById('contractLink').innerText = CONTRACT_ADDRESS;

const POLYGON_CHAIN_ID = 137;
const POLYGON_CHAIN_HEX = '0x89';
const POLYGONSCAN_TX_PREFIX = 'https://polygonscan.com/tx/';

let web3Modal, walletProvider;
let provider, signer, contract;

/* ============================
   ABI (Ù‡Ù…Ø§Ù† ABI Ú©Ù‡ Ø´Ù…Ø§ Ù‚Ø¨Ù„Ø§Ù‹ ÙØ±Ø³ØªØ§Ø¯ÛŒØ¯)
   Ù…Ù† Ø§ÛŒÙ† ABI Ø±Ø§ Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ø¯Ø± ÙØ§ÛŒÙ„ Ù…ÛŒâ€ŒÚ¯Ø°Ø§Ø±Ù… (Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø§Ø³Øª ÙˆÙ„ÛŒ Ù„Ø§Ø²Ù… Ø§Ø³Øª)
   ============================ */
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},{"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}];

/* UI refs */
const connectBtn = document.getElementById('connectBtn');
const wcBtn = document.getElementById('wcBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const readFeeBtn = document.getElementById('readFeeBtn');
const registerBtn = document.getElementById('registerBtn');
const getUserBtn = document.getElementById('getUserBtn');
const loadTreeBtn = document.getElementById('loadTreeBtn');
const contributeBtn = document.getElementById('contributeBtn');
const buyMinerBtn = document.getElementById('buyMinerBtn');
const withdrawPoolBtn = document.getElementById('withdrawPoolBtn');
const withdrawSpecialsBtn = document.getElementById('withdrawSpecialsBtn');
const minerStatsBtn = document.getElementById('minerStatsBtn');
const minerStatsByPercentBtn = document.getElementById('minerStatsByPercentBtn');

const walletShort = document.getElementById('walletShort');
const chainInfo = document.getElementById('chainInfo');
const balanceInfo = document.getElementById('balanceInfo');
const feeInfo = document.getElementById('feeInfo');
const resultBox = document.getElementById('resultBox');
const logBox = document.getElementById('logBox');
const statusBox = document.getElementById('statusBox');
const treeView = document.getElementById('treeView');
const statsBox = document.getElementById('statsBox');

function addLog(msg){
  const now = new Date().toLocaleTimeString();
  logBox.innerText = `[${now}] ${msg}\n` + logBox.innerText;
}
function setStatus(text, ok=true){
  statusBox.style.display = 'block';
  statusBox.className = 'status ' + (ok ? 'ok' : 'err');
  statusBox.innerText = text;
  setTimeout(()=>{ statusBox.style.display='none'; }, 7000);
}

/* init Web3Modal for WalletConnect */
function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { 137: "https://polygon-rpc.com" } }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider: false, providerOptions });
}

/* ensure read provider */
function ensureReadProvider(){
  if(!provider){
    provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
  }
}

/* connect injected */
async function connectInjected(){
  try {
    if(!window.ethereum) throw new Error('No injected wallet found');
    await window.ethereum.request({ method: 'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletShort.innerHTML = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>' + addr + '</strong>';
    disconnectBtn.style.display = 'inline-block';
    addLog('Connected (injected): ' + addr);
    await refreshNetworkAndBalance();
    setStatus('Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯');
  } catch(e){
    console.error(e);
    addLog('connectInjected error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„', false);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: ' + (e && e.message));
  }
}

/* connect WalletConnect */
async function connectWalletConnect(){
  try {
    walletProvider = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(walletProvider);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletShort.innerHTML = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>' + addr + '</strong>';
    disconnectBtn.style.display = 'inline-block';
    addLog('Connected (WalletConnect): ' + addr);
    await refreshNetworkAndBalance();
    setStatus('WalletConnect Ù…ØªØµÙ„ Ø´Ø¯');
    // handle disconnect
    walletProvider.on && walletProvider.on("disconnect", (code, reason) => {
      addLog('WalletConnect disconnected');
      walletProvider = null;
      provider = null; signer = null; contract = null;
      walletShort.innerText = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡';
      disconnectBtn.style.display = 'none';
    });
  } catch(e){
    console.error(e);
    addLog('connectWalletConnect error: ' + (e && e.message));
    setStatus('Ø§ØªØµØ§Ù„ WalletConnect Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯', false);
    alert('Ø§ØªØµØ§Ù„ WalletConnect Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯: ' + (e && e.message));
  }
}

/* disconnect */
function disconnectWallet(){
  try { if(walletProvider && walletProvider.close) walletProvider.close(); } catch(e){}
  provider = null; signer = null; contract = null;
  walletShort.innerText = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡';
  disconnectBtn.style.display = 'none';
  addLog('Disconnected');
}

/* switch to polygon */
async function trySwitchToPolygon(){
  if(!window.ethereum) throw new Error('No injected wallet to switch');
  try {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_HEX }]});
    addLog('Switched to Polygon');
    setStatus('Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ Polygon ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
  } catch(switchError){
    if(switchError && switchError.code === 4902){
      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{ chainId: POLYGON_CHAIN_HEX, chainName: 'Polygon Mainnet', nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 }, rpcUrls: ['https://polygon-rpc.com'], blockExplorerUrls: ['https://polygonscan.com'] }]
        });
        addLog('Polygon added to wallet');
        setStatus('Polygon Ø¨Ù‡ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
      } catch(err){ throw err; }
    } else throw switchError;
  }
}

/* refresh network & balance */
async function refreshNetworkAndBalance(){
  try {
    if(!provider) return;
    const network = await provider.getNetwork();
    chainInfo.innerText = 'Ø´Ø¨Ú©Ù‡: ' + (network.name || network.chainId) + ' (' + network.chainId + ')';
    if(network.chainId !== POLYGON_CHAIN_ID){
      setStatus('Ø´Ø¨Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Polygon Ø¨Ø§Ø´Ø¯ â€” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ¦ÛŒÚ†...', false);
      try { await trySwitchToPolygon(); } catch(e){ addLog('Switch to polygon failed: ' + (e && e.message)); }
    }
    if(signer){
      const addr = await signer.getAddress();
      const bal = await provider.getBalance(addr);
      balanceInfo.innerText = 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ' + parseFloat(ethers.utils.formatEther(bal)).toFixed(4) + ' MATIC';
    }
  } catch(e){ console.error(e); }
}

/* read ENTRY_FEE */
async function readEntryFee(){
  try {
    ensureReadProvider();
    const fee = await contract.ENTRY_FEE();
    const feeMatic = ethers.utils.formatEther(fee);
    feeInfo.innerText = `ENTRY_FEE = ${feeMatic} MATIC (${fee.toString()} wei)`;
    addLog('ENTRY_FEE read: ' + feeMatic + ' MATIC');
    return fee;
  } catch(e){
    console.error(e);
    addLog('readEntryFee error: ' + (e && e.message));
    setStatus('Ø®ÙˆØ§Ù†Ø¯Ù† ENTRY_FEE Ø®Ø·Ø§ Ø¯Ø§Ø¯', false);
    throw e;
  }
}

/* REGISTER (fixed 300 MATIC) */
async function registerAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.');
    const uplineRaw = document.getElementById('uplineCode').value.trim();
    if(!uplineRaw) return alert('Ù„Ø·ÙØ§Ù‹ upline code Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    const upline = Number(uplineRaw);
    const placeOnLeft = document.getElementById('placeSide').value === 'true';

    const valueToSend = ethers.utils.parseEther('300'); // fixed 300 MATIC
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...');
    const tx = await contract.register(upline, placeOnLeft, { value: valueToSend });
    addLog('register tx submitted: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    addLog('register confirmed: ' + tx.hash);
    setStatus('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    alert('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ â€” ' + tx.hash);
    await refreshNetworkAndBalance();
  } catch(e){
    console.error(e);
    addLog('register error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ' + (e && e.message), false);
    alert('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø´Ø¯: ' + (e && e.message));
  }
}

/* getUserInfo */
async function getUserInfoAction(){
  try {
    ensureReadProvider();
    let addr = document.getElementById('lookupAddress').value.trim();
    if(!addr){
      if(!signer) return alert('Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª Ùˆ Ø¢Ø¯Ø±Ø³ Ø¬Ø³ØªØ¬Ùˆ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡');
      addr = await signer.getAddress();
    }
    const info = await contract.getUserInfo(addr);
    const out = {
      id: info[0].toString(),
      uplineId: info[1].toString(),
      leftCount: info[2].toString(),
      rightCount: info[3].toString(),
      saveLeft: info[4].toString(),
      saveRight: info[5].toString(),
      balanceCount: info[6].toString(),
      specialBalanceCount: info[7].toString(),
      totalMinerRewards: info[8].toString(),
      entryPrice: ethers.utils.formatEther(info[9] || '0'),
      isMiner: info[10]
    };
    resultBox.innerText = JSON.stringify(out, null, 2);
    addLog('getUserInfo fetched for ' + addr);
    return out;
  } catch(e){
    console.error(e);
    addLog('getUserInfo error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', false);
  }
}

/* contributeToMinerPool */
async function contributeToMinerPoolAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    const raw = prompt('Ù…Ù‚Ø¯Ø§Ø± MATIC Ø¨Ø±Ø§ÛŒ ÙˆØ§Ø±ÛŒØ² (Ù…Ø«Ø§Ù„: 0.1):', '0.1');
    if(raw === null) return;
    const value = ethers.utils.parseEther(String(raw));
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ÙˆØ§Ø±ÛŒØ²...');
    const tx = await contract.contributeToMinerPool({ value });
    addLog('contribute tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('ÙˆØ§Ø±ÛŒØ² Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    addLog('contribute confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('contribute error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± ÙˆØ§Ø±ÛŒØ²', false);
  }
}

/* buyMinerTokens */
async function buyMinerTokensAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ buyMinerTokens...');
    const tx = await contract.buyMinerTokens();
    addLog('buyMinerTokens tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('buyMinerTokens Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('buyMinerTokens confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('buyMinerTokens error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± buyMinerTokens', false);
    alert('buyMinerTokens failed: ' + (e && e.message));
  }
}

/* withdrawPool */
async function withdrawPoolAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ withdrawPool...');
    const tx = await contract.withdrawPool();
    addLog('withdrawPool tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('withdrawPool Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('withdrawPool confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('withdrawPool error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± withdrawPool', false);
    alert('withdrawPool failed: ' + (e && e.message));
  }
}

/* withdrawSpecials */
async function withdrawSpecialsAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ withdrawSpecials...');
    const tx = await contract.withdrawSpecials();
    addLog('withdrawSpecials tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('withdrawSpecials Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('withdrawSpecials confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('withdrawSpecials error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± withdrawSpecials', false);
    alert('withdrawSpecials failed: ' + (e && e.message));
  }
}

/* getMinerStats */
async function getMinerStatsAction(){
  try {
    ensureReadProvider();
    const stats = await contract.getMinerStats();
    const out = {
      checkedOutPaidCount: stats[0].toString(),
      eligibleInProgressCount: stats[1].toString(),
      totalRemain: stats[2].toString(),
      networkerCount: stats[3].toString()
    };
    statsBox.innerText = JSON.stringify(out, null, 2);
    addLog('getMinerStats fetched');
  } catch(e){
    console.error(e);
    addLog('getMinerStats error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ú¯Ø±ÙØªÙ† Ø¢Ù…Ø§Ø±', false);
  }
}

/* getMinerStatsByPercent */
async function getMinerStatsByPercentAction(){
  try {
    ensureReadProvider();
    const p = prompt('Ø¯Ø±ØµØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯ (Ù…Ø«Ø§Ù„: 50):', '50');
    if(p === null) return;
    const percent = Number(p);
    if(isNaN(percent) || percent <1 || percent >100) return alert('Ø¯Ø±ØµØ¯ Ø¨Ø§ÛŒØ¯ Ø¨ÛŒÙ† 1 Ùˆ 100 Ø¨Ø§Ø´Ø¯');
    const res = await contract.getMinerStatsByPercent(percent);
    const out = { usersAbovePercent: res[0].toString(), totalRemaining: res[1].toString() };
    statsBox.innerText = JSON.stringify(out, null, 2);
    addLog('getMinerStatsByPercent fetched for ' + percent + '%');
  } catch(e){
    console.error(e);
    addLog('getMinerStatsByPercent error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§', false);
  }
}

/* TREE: recursive fetch by userId using getUserDirects */
async function fetchTreeById(userId, depth){
  if(!userId || userId === 0 || depth <= 0) return null;
  try {
    const directs = await contract.getUserDirects(userId);
    const leftId = Number(directs.leftId || directs[0]) || 0;
    const rightId = Number(directs.rightId || directs[1]) || 0;
    const node = { name: `ID ${userId}`, id: userId, children: [] };
    if(leftId) {
      const leftNode = await fetchTreeById(leftId, depth-1);
      node.children.push(leftNode || { name:`ID ${leftId}`, id:leftId, children:[] });
    }
    if(rightId) {
      const rightNode = await fetchTreeById(rightId, depth-1);
      node.children.push(rightNode || { name:`ID ${rightId}`, id:rightId, children:[] });
    }
    return node;
  } catch(e){
    return { name: `ID ${userId}`, id: userId, children: [] };
  }
}

async function loadTree(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª...');
    const myAddr = await signer.getAddress();
    const info = await contract.getUserInfo(myAddr);
    const myId = Number(info[0].toString());
    if(!myId || myId === 0){ setStatus('Ø´Ù…Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ (id=0)', false); return; }
    const depth = Number(document.getElementById('treeDepth').value) || 3;
    const data = await fetchTreeById(myId, depth);
    drawTree(data || { name: `ID ${myId}`, children: [] });
    setStatus('Ø¯Ø±Ø®Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    addLog('Tree loaded for ID ' + myId);
  } catch(e){
    console.error(e);
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª', false);
    addLog('loadTree error: ' + (e && e.message));
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª: ' + (e && e.message));
  }
}

/* draw tree with d3 (interactive) */
function drawTree(data){
  treeView.innerHTML = '';
  if(!data){ treeView.innerText = 'Ø¨Ø¯ÙˆÙ† Ø¯Ø§Ø¯Ù‡'; return; }
  const width = treeView.clientWidth || 900;
  const height = treeView.clientHeight || 340;
  const svg = d3.select(treeView).append('svg').attr('width', width).attr('height', height);
  const g = svg.append('g').attr('transform', 'translate(20,20)');
  const root = d3.hierarchy(data);
  const treeLayout = d3.tree().size([width - 80, height - 80]);
  treeLayout(root);

  // links
  g.selectAll('path.link')
    .data(root.links())
    .enter()
    .append('path')
    .attr('d', d3.linkVertical().x(d=>d.x).y(d=>d.y))
    .attr('fill','none').attr('stroke','#7c3aed').attr('stroke-width',2).attr('opacity',0.85);

  // nodes
  const node = g.selectAll('g.node')
    .data(root.descendants())
    .enter()
    .append('g')
    .attr('transform', d => `translate(${d.x},${d.y})`)
    .style('cursor','pointer')
    .on('click', async (event,d) => {
      // on click fetch user info by id
      try {
        const id = d.data.id;
        // we have functions expecting addresses, but we can show ID and try to call migration info if owner has provided _getSpecialUserInfoForMigrateToNewFork (onlyOwner). Fallback: show id
        alert('Clicked node ' + id);
      } catch(e){}
    });

  node.append('circle')
    .attr('r',20)
    .attr('fill','#7c3aed')
    .attr('stroke','#fff').attr('stroke-width',1.2)
    .on('mouseover', function(){ d3.select(this).transition().attr('r',26); })
    .on('mouseout', function(){ d3.select(this).transition().attr('r',20); });

  node.append('text').attr('dy',5).attr('text-anchor','middle').attr('fill','#fff').style('font-size','12px').text(d=>d.data.name);
}

/* init & wire UI */
initWeb3Modal();
ensureReadProvider();

/* event listeners */
connectBtn.addEventListener('click', async ()=> {
  // try injected first
  if(window.ethereum){
    await connectInjected();
  } else {
    await connectWalletConnect();
  }
});
wcBtn.addEventListener('click', async ()=> { await connectWalletConnect(); });
disconnectBtn.addEventListener('click', disconnectWallet);

readFeeBtn && readFeeBtn.addEventListener('click', async ()=> { await readEntryFee(); });
registerBtn && registerBtn.addEventListener('click', async ()=> { await registerAction(); });
getUserBtn && getUserBtn.addEventListener('click', async ()=> { await getUserInfoAction(); });
loadTreeBtn && loadTreeBtn.addEventListener('click', async ()=> { await loadTree(); });
contributeBtn && contributeBtn.addEventListener('click', async ()=> { await contributeToMinerPoolAction(); });
buyMinerBtn && buyMinerBtn.addEventListener('click', async ()=> { await buyMinerTokensAction(); });
withdrawPoolBtn && withdrawPoolBtn.addEventListener('click', async ()=> { await withdrawPoolAction(); });
withdrawSpecialsBtn && withdrawSpecialsBtn.addEventListener('click', async ()=> { await withdrawSpecialsAction(); });
minerStatsBtn && minerStatsBtn.addEventListener('click', async ()=> { await getMinerStatsAction(); });
minerStatsByPercentBtn && minerStatsByPercentBtn.addEventListener('click', async ()=> { await getMinerStatsByPercentAction(); });

/* small ready log */
addLog('Ultra Pro DApp loaded (read-only provider active).');
</script>
</body>
</html>
