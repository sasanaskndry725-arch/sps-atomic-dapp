<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPS Network - Advanced DApp</title>

<!-- ethers.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<style>
  /* ----------------- Premium AI Background Theme ----------------- */
  :root {
    --bg-1: #0a0a1a;
    --bg-2: #15152b;
    --glass: rgba(255,255,255,0.03);
    --card: rgba(255,255,255,0.02);
    --muted: #8a9bb2;
    --primary: #6366f1;
    --accent: #8b5cf6;
    --neon: #00d9ff;
    --success: #10b981;
    --danger: #ef4444;
    --warning: #f59e0b;
    --glass-border: rgba(255,255,255,0.06);
    --gold: #ffd700;
  }

  * { box-sizing:border-box; margin:0; padding:0; }
  body {
    font-family: 'Inter', 'Segoe UI', system-ui, sans-serif;
    background: var(--bg-1);
    color: #f0f4ff;
    min-height: 100vh;
    overflow-x: hidden;
    position: relative;
  }

  /* AI Animated Background */
  .ai-background {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 0;
    pointer-events: none;
    background: 
      radial-gradient(circle at 20% 30%, rgba(99, 102, 241, 0.08) 0%, transparent 50%),
      radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.06) 0%, transparent 50%),
      linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
  }

  .ai-particles {
    position: fixed;
    width: 100%;
    height: 100%;
    z-index: 0;
  }

  /* Container */
  .container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 20px;
    position: relative;
    z-index: 10;
  }

  /* Header */
  .header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: rgba(255,255,255,0.02);
    backdrop-filter: blur(20px);
    border-radius: 20px;
    padding: 18px 24px;
    border: 1px solid var(--glass-border);
    box-shadow: 0 20px 40px rgba(0,0,0,0.3);
    margin-bottom: 24px;
  }

  /* Logo */
  .logo-container {
    display: flex;
    align-items: center;
    gap: 16px;
  }

  .logo-text {
    font-family: 'Orbitron', sans-serif;
    font-size: 28px;
    font-weight: 900;
    background: linear-gradient(45deg, var(--primary), var(--accent));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    letter-spacing: 1px;
  }

  .logo-badge {
    background: linear-gradient(45deg, var(--primary), var(--accent));
    color: white;
    padding: 4px 10px;
    border-radius: 20px;
    font-size: 12px;
    font-weight: 700;
  }

  /* Hamburger Menu */
  .hamburger {
    display: none;
    flex-direction: column;
    gap: 4px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 8px;
  }

  .hamburger span {
    width: 24px;
    height: 3px;
    background: var(--primary);
    border-radius: 2px;
    transition: 0.3s;
  }

  .mobile-menu {
    position: fixed;
    top: 0;
    right: -300px;
    width: 280px;
    height: 100vh;
    background: rgba(10,10,26,0.95);
    backdrop-filter: blur(20px);
    z-index: 1000;
    transition: 0.3s;
    padding: 100px 24px 24px;
    border-left: 1px solid var(--glass-border);
    box-shadow: -20px 0 40px rgba(0,0,0,0.5);
  }

  .mobile-menu.active {
    right: 0;
  }

  .mobile-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.5);
    backdrop-filter: blur(5px);
    z-index: 999;
  }

  .mobile-overlay.active {
    display: block;
  }

  .mobile-tabs {
    display: flex;
    flex-direction: column;
    gap: 10px;
  }

  .mobile-tab-btn {
    padding: 16px;
    background: rgba(255,255,255,0.05);
    border-radius: 12px;
    border: 1px solid var(--glass-border);
    color: var(--muted);
    font-size: 16px;
    font-weight: 700;
    text-align: left;
    cursor: pointer;
    transition: 0.3s;
  }

  .mobile-tab-btn.active {
    background: linear-gradient(90deg, rgba(99,102,241,0.2), rgba(139,92,246,0.1));
    color: var(--primary);
    border-color: rgba(99,102,241,0.3);
  }

  /* Status */
  .status-ind {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .status-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: var(--danger);
  }

  .status-dot.connected {
    background: var(--success);
    box-shadow: 0 0 20px var(--success);
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.5; }
  }

  /* Connect Button */
  .connect-btn {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 12px;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
    box-shadow: 0 10px 30px rgba(99,102,241,0.3);
  }

  .connect-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 15px 40px rgba(99,102,241,0.4);
  }

  /* Contract Links */
  .contract-links {
    display: flex;
    gap: 12px;
    margin: 16px 0;
    flex-wrap: wrap;
  }

  .contract-btn {
    padding: 10px 16px;
    background: rgba(99,102,241,0.1);
    border: 1px solid rgba(99,102,241,0.2);
    border-radius: 10px;
    color: var(--primary);
    text-decoration: none;
    font-weight: 700;
    font-size: 14px;
    display: flex;
    align-items: center;
    gap: 8px;
    transition: 0.3s;
  }

  .contract-btn:hover {
    background: rgba(99,102,241,0.2);
    transform: translateY(-2px);
  }

  /* Tabs */
  .tabs {
    display: flex;
    gap: 8px;
    margin: 20px 0;
    flex-wrap: wrap;
  }

  .tab-btn {
    padding: 12px 20px;
    background: transparent;
    border: 1px solid var(--glass-border);
    border-radius: 12px;
    color: var(--muted);
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
  }

  .tab-btn.active {
    background: linear-gradient(90deg, rgba(99,102,241,0.15), rgba(139,92,246,0.1));
    color: var(--primary);
    border-color: rgba(99,102,241,0.3);
    box-shadow: 0 8px 25px rgba(99,102,241,0.15);
  }

  /* Stats Grid */
  .stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 16px;
    margin: 20px 0;
  }

  .stat-box {
    background: rgba(255,255,255,0.02);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 20px;
    transition: 0.3s;
  }

  .stat-box:hover {
    transform: translateY(-5px);
    border-color: rgba(99,102,241,0.3);
  }

  .stat-label {
    color: var(--muted);
    font-size: 14px;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .stat-value {
    font-size: 24px;
    font-weight: 800;
    color: white;
  }

  /* Grid Layout */
  .grid-2 {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin: 20px 0;
  }

  @media (max-width: 768px) {
    .grid-2 {
      grid-template-columns: 1fr;
    }
  }

  .card {
    background: rgba(255,255,255,0.02);
    backdrop-filter: blur(10px);
    border: 1px solid var(--glass-border);
    border-radius: 16px;
    padding: 24px;
  }

  /* Points & Awards Display */
  .points-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
    margin: 16px 0;
  }

  .points-card {
    background: rgba(255,255,255,0.03);
    border-radius: 12px;
    padding: 16px;
    border: 1px solid var(--glass-border);
  }

  .points-label {
    color: var(--muted);
    font-size: 12px;
    margin-bottom: 6px;
  }

  .points-value {
    font-size: 20px;
    font-weight: 800;
    color: var(--primary);
  }

  /* Transaction Hash Panel */
  .tx-panel {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%) translateY(100px);
    width: 90%;
    max-width: 500px;
    background: rgba(21,21,43,0.95);
    backdrop-filter: blur(20px);
    border: 1px solid var(--glass-border);
    border-radius: 20px;
    padding: 24px;
    z-index: 2000;
    box-shadow: 0 30px 60px rgba(0,0,0,0.5);
    opacity: 0;
    transition: 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
  }

  .tx-panel.active {
    transform: translateX(-50%) translateY(0);
    opacity: 1;
  }

  .tx-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .tx-hash {
    font-family: monospace;
    background: rgba(0,0,0,0.3);
    padding: 12px;
    border-radius: 10px;
    word-break: break-all;
    font-size: 14px;
    margin: 12px 0;
    border: 1px solid var(--glass-border);
  }

  .tx-actions {
    display: flex;
    gap: 12px;
    margin-top: 20px;
  }

  .tx-btn {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    border: none;
    font-weight: 700;
    cursor: pointer;
    transition: 0.3s;
  }

  .tx-btn.primary {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    color: white;
  }

  /* Buttons */
  .btn {
    padding: 14px 24px;
    border-radius: 12px;
    border: none;
    font-weight: 800;
    cursor: pointer;
    transition: 0.3s;
  }

  .btn-primary {
    background: linear-gradient(90deg, var(--primary), var(--accent));
    color: white;
    box-shadow: 0 10px 30px rgba(99,102,241,0.3);
  }

  .btn-success {
    background: linear-gradient(90deg, var(--success), #34d399);
    color: white;
  }

  .btn-group {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
    gap: 12px;
  }

  /* Loading */
  .loading {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    backdrop-filter: blur(10px);
    z-index: 3000;
    align-items: center;
    justify-content: center;
  }

  .spinner {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.1);
    border-top-color: var(--primary);
    animation: spin 1s linear infinite;
  }

  /* Form */
  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    color: var(--muted);
    font-weight: 600;
  }

  .form-input {
    width: 100%;
    padding: 14px;
    background: rgba(255,255,255,0.05);
    border: 1px solid var(--glass-border);
    border-radius: 10px;
    color: white;
    font-size: 16px;
  }

  .form-input:focus {
    outline: none;
    border-color: var(--primary);
  }

  /* Footer */
  footer {
    text-align: center;
    color: var(--muted);
    font-size: 12px;
    margin-top: 40px;
    padding: 20px;
  }

  /* Responsive */
  @media (max-width: 768px) {
    .container {
      padding: 12px;
    }
    
    .header {
      padding: 16px;
    }
    
    .hamburger {
      display: flex;
    }
    
    .tabs {
      display: none;
    }
    
    .stats-grid {
      grid-template-columns: 1fr;
    }
  }
</style>
</head>
<body>
  <!-- AI Background -->
  <div class="ai-background"></div>
  <canvas class="ai-particles" id="aiParticles"></canvas>

  <!-- Mobile Menu -->
  <div class="mobile-overlay" id="mobileOverlay"></div>
  <div class="mobile-menu" id="mobileMenu">
    <div class="mobile-tabs" id="mobileTabs"></div>
  </div>

  <!-- Transaction Panel -->
  <div class="tx-panel" id="txPanel">
    <div class="tx-header">
      <h3 style="margin:0;color:var(--primary)">üéâ Transaction Successful</h3>
      <button onclick="closeTxPanel()" style="background:none;border:none;color:var(--muted);cursor:pointer;font-size:24px">√ó</button>
    </div>
    <div style="color:var(--muted);margin-bottom:8px">Transaction Hash:</div>
    <div class="tx-hash" id="txHashDisplay"></div>
    <div class="tx-actions">
      <button class="tx-btn" onclick="copyTxHash()">üìã Copy Hash</button>
      <button class="tx-btn primary" onclick="viewOnPolygonscan()">üîç View on Polygonscan</button>
    </div>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo-container">
        <button class="hamburger" id="hamburgerBtn">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <div class="logo-text">SPS NETWORK</div>
        <div class="logo-badge">v2.0</div>
      </div>

      <div style="display:flex;align-items:center;gap:16px">
        <div class="status-ind">
          <div id="statusDot" class="status-dot"></div>
          <div id="networkStatus">Network Status</div>
        </div>
        <div id="connectArea">
          <button id="connectBtn" class="connect-btn">Connect Wallet</button>
        </div>
      </div>
    </div>

    <!-- Contract Links -->
    <div class="contract-links">
      <a href="https://polygonscan.com/address/0x7a7b06D49129B34976D07B3854d4D72D01588191" target="_blank" class="contract-btn">
        üìÑ SPS Contract
      </a>
      <a href="https://polygonscan.com/address/0x82F7dBe1792436d15bdA22bB3340bD3f45D614Fa" target="_blank" class="contract-btn">
        üíé P-Token Contract
      </a>
    </div>

    <!-- Tabs -->
    <div class="tabs" id="tabsRow">
      <button class="tab-btn active" onclick="showTab('dashboard')">Dashboard</button>
      <button class="tab-btn" id="registerTabBtn" onclick="showTab('register')">Register</button>
      <button class="tab-btn" onclick="showTab('miner')">Miner</button>
      <button class="tab-btn" onclick="showTab('actions')">Actions</button>
      <button class="tab-btn" onclick="showTab('ptoken')">P-Token Market</button>
      <button class="tab-btn" onclick="showTab('admin')" id="adminTabBtn" style="display:none">Admin</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboardTab">
      <div class="stats-grid">
        <div class="stat-box">
          <div class="stat-label">Pool Balance</div>
          <div class="stat-value" id="poolBalance">0 MATIC</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Miner Pool</div>
          <div class="stat-value" id="minerPool">0 pToken</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Special Reward</div>
          <div class="stat-value" id="specialPool">0 MATIC</div>
        </div>
        <div class="stat-box">
          <div class="stat-label">Entry Fee</div>
          <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
        </div>
      </div>

      <div class="grid-2">
        <div class="card">
          <h3>üë§ User Information</h3>
          <div id="userInfo">Wallet not connected</div>
        </div>
        <div class="card">
          <h3>üå≥ Your Tree Structure</h3>
          <div class="tree-container" id="treeContainer">
            <div class="node">üîÑ Connect wallet to view tree</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Register -->
    <div id="registerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>üìù Registration</h3>
          <div id="registerDisabled" style="display:none; padding:30px; text-align:center; color:var(--muted);">
            <div style="font-size:48px; margin-bottom:16px">‚úÖ</div>
            <div style="font-weight:800; margin-bottom:12px; font-size:20px">Already Registered!</div>
            <div>You are already part of the network.</div>
          </div>
          <div id="registerForm">
            <div class="form-group">
              <label class="form-label">Upline Code</label>
              <input id="uplineCode" class="form-input" type="number" placeholder="1"/>
            </div>
            <div class="form-group">
              <label class="form-label">Position</label>
              <select id="position" class="form-input">
                <option value="true">Left</option>
                <option value="false">Right</option>
              </select>
            </div>
            <button class="btn btn-primary" onclick="register()">Register (300 MATIC)</button>
          </div>
          <div id="registerResult" style="margin-top:16px"></div>
        </div>
        <div class="card">
          <h3>üìä Registration Info</h3>
          <div id="registerInfo">Connect wallet to view registration info</div>
        </div>
      </div>
    </div>

    <!-- Miner -->
    <div id="minerTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>‚õèÔ∏è Miner Operations</h3>
          <div class="form-group">
            <label class="form-label">Contribution Amount (MATIC)</label>
            <input id="contribution" class="form-input" placeholder="0.1"/>
          </div>
          <div class="btn-group">
            <button class="btn btn-success" onclick="contribute()">Contribute</button>
            <button class="btn btn-primary" onclick="buyTokens()">Buy Miner Token</button>
            <button class="btn btn-success" onclick="distribute()">Distribute Tokens</button>
          </div>
          <div id="minerResult" style="margin-top:16px"></div>
        </div>
        <div class="card">
          <h3>üìä Miner Information</h3>
          <div id="minerInfo">Your miner information</div>
        </div>
      </div>
    </div>

    <!-- Actions (With Points & Awards) -->
    <div id="actionsTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>üí∏ Withdraw Operations</h3>
          
          <!-- Points & Awards Display -->
          <div class="points-grid">
            <div class="points-card">
              <div class="points-label">Commission Points</div>
              <div class="points-value" id="commissionPoints">0</div>
            </div>
            <div class="points-card">
              <div class="points-label">Special Awards</div>
              <div class="points-value" id="specialAwards">0</div>
            </div>
            <div class="points-card">
              <div class="points-label">Miner Rewards</div>
              <div class="points-value" id="minerRewards">0 MATIC</div>
            </div>
            <div class="points-card">
              <div class="points-label">Total Withdrawals</div>
              <div class="points-value" id="totalWithdrawals">0</div>
            </div>
          </div>

          <div class="countdown" style="margin:20px 0; padding:16px; background:rgba(255,255,255,0.03); border-radius:12px">
            <div style="font-weight:700; margin-right:12px">Last Withdraw:</div>
            <div id="poolTimerSegments" style="display:flex;gap:6px"></div>
          </div>

          <div class="btn-group" style="margin-top:20px">
            <button id="withdrawMainBtn" class="btn btn-success" onclick="withdrawPool()">Withdraw Main Pool</button>
            <button id="withdrawSpecialBtn" class="btn btn-primary" onclick="withdrawSpecial()">Withdraw Special</button>
          </div>
          <div id="withdrawResult" style="margin-top:16px"></div>
        </div>
        <div class="card">
          <h3>üìà Withdraw Status</h3>
          <div id="withdrawInfo">Your withdrawal status</div>
          <div style="margin-top:20px">
            <h4>üìä Activity History</h4>
            <div id="activityHistory" style="margin-top:12px">
              <div style="padding:12px; background:rgba(255,255,255,0.03); border-radius:8px; margin-bottom:8px">
                <div style="display:flex; justify-content:space-between">
                  <span>Connect wallet to view history</span>
                  <span style="color:var(--muted); font-size:12px">--</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- P-Token Market -->
    <div id="ptokenTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>üí∞ P-Token Market</h3>
          <div style="background:rgba(255,215,0,0.05); padding:20px; border-radius:12px; margin-bottom:20px; border:1px solid rgba(255,215,0,0.2)">
            <div style="color:var(--muted); font-size:14px">Current Price</div>
            <div style="font-size:32px; font-weight:800; color:var(--gold)" id="ptokenPrice">0.00 MATIC</div>
            <div style="color:var(--muted); font-size:12px; margin-top:4px" id="priceUpdate">Live</div>
          </div>

          <div class="form-group">
            <label class="form-label">Your P-Token Balance</label>
            <div style="font-size:24px; font-weight:800; color:var(--accent)" id="ptokenBalance">0 PTOKEN</div>
          </div>

          <div class="form-group">
            <label class="form-label">Amount to Sell</label>
            <input id="sellAmount" class="form-input" placeholder="0.0"/>
            <div style="font-size:12px; color:var(--muted); margin-top:8px">
              You will receive: <span id="receiveAmount" style="color:var(--success); font-weight:700">0 MATIC</span>
            </div>
          </div>

          <div class="btn-group">
            <button class="btn" onclick="setMaxPTokens()" style="background:rgba(255,255,255,0.05)">Max</button>
            <button class="btn btn-primary" onclick="sellPTokens()">Sell P-Tokens</button>
          </div>
          <div id="sellResult" style="margin-top:16px"></div>
        </div>
        <div class="card">
          <h3>üìà Market Information</h3>
          <div style="margin-top:20px">
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--glass-border)">
              <span style="color:var(--muted)">Total Supply</span>
              <span style="font-weight:700" id="totalSupply">0</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--glass-border)">
              <span style="color:var(--muted)">Backing MATIC</span>
              <span style="font-weight:700" id="backingMatic">0</span>
            </div>
            <div style="display:flex; justify-content:space-between; padding:12px 0; border-bottom:1px solid var(--glass-border)">
              <span style="color:var(--muted)">Contract Balance</span>
              <span style="font-weight:700" id="contractBalance">0 MATIC</span>
            </div>
          </div>

          <div style="margin-top:30px">
            <h4>üí° How it works</h4>
            <div style="font-size:14px; color:var(--muted); margin-top:12px; line-height:1.6">
              P-Token price is backed by MATIC in the contract. Selling returns MATIC based on current backing ratio.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Admin -->
    <div id="adminTab" style="display:none">
      <div class="grid-2">
        <div class="card">
          <h3>‚öôÔ∏è Contract Settings</h3>
          <div class="form-group">
            <label class="form-label">New Entry Fee (wei)</label>
            <input id="newFee" class="form-input" placeholder="300000000000000000000"/>
          </div>
          <button class="btn btn-danger" onclick="updateFee()">Update Entry Fee</button>
          <div id="adminResult"></div>
        </div>
        <div class="card">
          <h3>üö´ Miner Management</h3>
          <div class="form-group">
            <label class="form-label">Addresses to Remove (comma separated)</label>
            <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
          </div>
          <button class="btn btn-danger" onclick="removeMiners()">Remove Miners</button>
        </div>
      </div>
    </div>

    <!-- Loading -->
    <div class="loading" id="loading"><div class="spinner"></div></div>

    <footer>SPS Network v2.0 ‚Ä¢ Advanced DApp ‚Ä¢ Powered by Polygon</footer>
  </div>

<script>
/* ================= CONSTANTS ================= */
const SPS_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
const PTOKEN_ADDRESS = "0x82F7dBe1792436d15bdA22bB3340bD3f45D614Fa";
const POLYGON_CHAIN_ID = "0x89";
const ENTRY_FEE = "300000000000000000000"; // 300 MATIC

// SPS Contract ABI (simplified - only essential functions)
const SPS_ABI = [
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"eligibleSpecialUserCount","stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

// P-Token Contract ABI (from your provided data)
const PTOKEN_ABI = [{"inputs":[{"internalType":"address","name":"_projectWallet","type":"address"}],"stateMutability":"payable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"owner","type":"address"},{"indexed":true,"internalType":"address","name":"spender","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Approval","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"maticAmount","type":"uint256"}],"name":"BackingIncreased","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"buyer","type":"address"},{"indexed":false,"internalType":"uint256","name":"maticAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"pTokenAmount","type":"uint256"}],"name":"BuyPToken","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"donor","type":"address"},{"indexed":false,"internalType":"uint256","name":"maticAmount","type":"uint256"}],"name":"DonationAdded","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"seller","type":"address"},{"indexed":false,"internalType":"uint256","name":"pTokenAmount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"maticAmount","type":"uint256"}],"name":"SellPToken","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"from","type":"address"},{"indexed":true,"internalType":"address","name":"to","type":"address"},{"indexed":false,"internalType":"uint256","name":"value","type":"uint256"}],"name":"Transfer","type":"event"},{"inputs":[],"name":"BACKING_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_DENOMINATOR","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"FEE_PERCENT","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"INITIAL_BACKING","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"INITIAL_SUPPLY","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PROJECT_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"owner","type":"address"},{"internalType":"address","name":"spender","type":"address"}],"name":"allowance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"buyPToken","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"decimals","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"subtractedValue","type":"uint256"}],"name":"decreaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"donateToBacking","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"getContractMaticBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getPTokenPriceInWei","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"addedValue","type":"uint256"}],"name":"increaseAllowance","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"lockedSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"name","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"minPTokenAmount","type":"uint256"}],"name":"safeBuyPToken","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[{"internalType":"uint256","name":"pTokenAmount","type":"uint256"}],"name":"sellPToken","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"symbol","outputs":[{"internalType":"string","name":"","type":"string"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalBackingMatic","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalSupply","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transfer","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"from","type":"address"},{"internalType":"address","name":"to","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"transferFrom","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"stateMutability":"payable","type":"receive"}];

/* ================= STATE ================= */
let provider, signer, contractSPS, contractPToken, userAddress;
let isOwner = false, userHasId = false, ptokenDecimals = 18;
let currentTxHash = null;

/* ================= AI PARTICLES BACKGROUND ================= */
const particlesCanvas = document.getElementById('aiParticles');
let particlesCtx, particles = [];

function initParticles() {
  if (!particlesCanvas) return;
  
  particlesCanvas.width = window.innerWidth;
  particlesCanvas.height = window.innerHeight;
  particlesCtx = particlesCanvas.getContext('2d');
  
  // Create particles
  particles = [];
  const particleCount = Math.min(50, Math.floor(window.innerWidth * window.innerHeight / 20000));
  
  for (let i = 0; i < particleCount; i++) {
    particles.push({
      x: Math.random() * particlesCanvas.width,
      y: Math.random() * particlesCanvas.height,
      size: Math.random() * 3 + 1,
      speedX: (Math.random() - 0.5) * 0.5,
      speedY: (Math.random() - 0.5) * 0.5,
      color: `rgba(${Math.floor(Math.random() * 100 + 100)}, ${Math.floor(Math.random() * 100 + 100)}, ${Math.floor(Math.random() * 255)}, ${Math.random() * 0.3 + 0.1})`
    });
  }
  
  animateParticles();
}

function animateParticles() {
  if (!particlesCtx) return;
  
  // Clear with fade effect
  particlesCtx.fillStyle = 'rgba(10, 10, 26, 0.05)';
  particlesCtx.fillRect(0, 0, particlesCanvas.width, particlesCanvas.height);
  
  // Update and draw particles
  particles.forEach(particle => {
    particle.x += particle.speedX;
    particle.y += particle.speedY;
    
    // Boundary check
    if (particle.x < 0 || particle.x > particlesCanvas.width) particle.speedX *= -1;
    if (particle.y < 0 || particle.y > particlesCanvas.height) particle.speedY *= -1;
    
    // Draw particle
    particlesCtx.beginPath();
    particlesCtx.arc(particle.x, particle.y, particle.size, 0, Math.PI * 2);
    particlesCtx.fillStyle = particle.color;
    particlesCtx.fill();
    
    // Draw connections
    particles.forEach(otherParticle => {
      const dx = particle.x - otherParticle.x;
      const dy = particle.y - otherParticle.y;
      const distance = Math.sqrt(dx * dx + dy * dy);
      
      if (distance < 100) {
        particlesCtx.beginPath();
        particlesCtx.strokeStyle = `rgba(99, 102, 241, ${0.2 * (1 - distance / 100)})`;
        particlesCtx.lineWidth = 0.5;
        particlesCtx.moveTo(particle.x, particle.y);
        particlesCtx.lineTo(otherParticle.x, otherParticle.y);
        particlesCtx.stroke();
      }
    });
  });
  
  requestAnimationFrame(animateParticles);
}

/* ================= MOBILE MENU ================= */
function initMobileMenu() {
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const mobileOverlay = document.getElementById('mobileOverlay');
  const mobileMenu = document.getElementById('mobileMenu');
  
  if (!hamburgerBtn || !mobileOverlay || !mobileMenu) return;
  
  // Create mobile tabs
  updateMobileTabs();
  
  // Event listeners
  hamburgerBtn.addEventListener('click', toggleMobileMenu);
  mobileOverlay.addEventListener('click', closeMobileMenu);
  
  // Handle resize
  window.addEventListener('resize', handleResize);
  handleResize();
}

function toggleMobileMenu() {
  const hamburger = document.getElementById('hamburgerBtn');
  const overlay = document.getElementById('mobileOverlay');
  const menu = document.getElementById('mobileMenu');
  
  hamburger.classList.toggle('active');
  overlay.classList.toggle('active');
  menu.classList.toggle('active');
}

function closeMobileMenu() {
  const hamburger = document.getElementById('hamburgerBtn');
  const overlay = document.getElementById('mobileOverlay');
  const menu = document.getElementById('mobileMenu');
  
  hamburger.classList.remove('active');
  overlay.classList.remove('active');
  menu.classList.remove('active');
}

function updateMobileTabs() {
  const tabsContainer = document.getElementById('mobileTabs');
  if (!tabsContainer) return;
  
  const tabs = [
    { id: 'dashboard', name: 'Dashboard' },
    { id: 'register', name: 'Register' },
    { id: 'miner', name: 'Miner' },
    { id: 'actions', name: 'Actions' },
    { id: 'ptoken', name: 'P-Token Market' },
    { id: 'admin', name: 'Admin' }
  ];
  
  tabsContainer.innerHTML = '';
  
  tabs.forEach(tab => {
    const btn = document.createElement('button');
    btn.className = 'mobile-tab-btn';
    btn.textContent = tab.name;
    
    // Hide admin tab if not owner
    if (tab.id === 'admin' && !isOwner) {
      btn.style.display = 'none';
    }
    
    btn.onclick = () => {
      showTab(tab.id);
      closeMobileMenu();
    };
    tabsContainer.appendChild(btn);
  });
}

function handleResize() {
  const hamburgerBtn = document.getElementById('hamburgerBtn');
  const desktopTabs = document.querySelector('.tabs');
  
  if (window.innerWidth <= 768) {
    if (desktopTabs) desktopTabs.style.display = 'none';
    if (hamburgerBtn) hamburgerBtn.style.display = 'flex';
  } else {
    if (desktopTabs) desktopTabs.style.display = 'flex';
    if (hamburgerBtn) hamburgerBtn.style.display = 'none';
    closeMobileMenu();
  }
}

/* ================= TRANSACTION PANEL ================= */
function showTxPanel(txHash) {
  currentTxHash = txHash;
  const panel = document.getElementById('txPanel');
  const hashDisplay = document.getElementById('txHashDisplay');
  
  hashDisplay.textContent = txHash;
  panel.classList.add('active');
  
  // Auto-close after 30 seconds
  setTimeout(() => {
    if (panel.classList.contains('active')) {
      closeTxPanel();
    }
  }, 30000);
}

function closeTxPanel() {
  document.getElementById('txPanel').classList.remove('active');
  currentTxHash = null;
}

function copyTxHash() {
  if (!currentTxHash) return;
  
  navigator.clipboard.writeText(currentTxHash).then(() => {
    const btn = document.querySelector('.tx-btn');
    const originalText = btn.textContent;
    btn.textContent = '‚úì Copied!';
    setTimeout(() => {
      btn.textContent = originalText;
    }, 2000);
  });
}

function viewOnPolygonscan() {
  if (!currentTxHash) return;
  window.open(`https://polygonscan.com/tx/${currentTxHash}`, '_blank');
}

/* ================= UI HELPERS ================= */
function showStatus(message, targetId = 'userInfo', type = 'info') {
  const el = document.getElementById(targetId);
  if (!el) return;
  
  const color = type === 'error' ? 'var(--danger)' : 
                type === 'success' ? 'var(--success)' : 
                type === 'warning' ? 'var(--warning)' : 'white';
  
  el.innerHTML = `<div style="color:${color}">${message}</div>`;
}

function showLoading(show) {
  document.getElementById('loading').style.display = show ? 'flex' : 'none';
}

async function handleTx(txPromise, targetId) {
  try {
    showLoading(true);
    const tx = await txPromise;
    
    // Show transaction panel
    showTxPanel(tx.hash);
    
    showStatus(`‚è≥ Transaction sent... <a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" style="color:var(--primary)">View</a>`, targetId);
    
    const receipt = await tx.wait();
    showStatus(`‚úÖ Transaction confirmed! <a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" style="color:var(--success)">View</a>`, targetId, 'success');
    
    // Reload data
    await loadDashboardData();
    if (document.getElementById('ptokenTab').style.display !== 'none') {
      await loadPTokenMarket();
    }
    
    return receipt;
  } catch (error) {
    showStatus(`‚ùå Error: ${error.message || 'Transaction failed'}`, targetId, 'error');
    throw error;
  } finally {
    showLoading(false);
  }
}

/* ================= POINTS & AWARDS ================= */
async function loadPointsAndAwards() {
  if (!contractSPS || !userAddress) return;
  
  try {
    const userInfo = await contractSPS.getUserInfo(userAddress);
    
    // Update points display
    document.getElementById('commissionPoints').textContent = Number(userInfo[6]); // balanceCount
    document.getElementById('specialAwards').textContent = Number(userInfo[7]); // specialBalanceCount
    document.getElementById('minerRewards').textContent = ethers.formatEther(userInfo[8]).substring(0, 10) + ' MATIC'; // totalMinerRewards
    
    // Calculate total withdrawals (approximate)
    const totalWithdrawals = Number(userInfo[6]) + Number(userInfo[7]);
    document.getElementById('totalWithdrawals').textContent = totalWithdrawals;
    
  } catch (error) {
    console.error('Error loading points:', error);
  }
}

/* ================= REGISTRATION CONTROL ================= */
async function checkUserRegistration() {
  if (!contractSPS || !userAddress) return;
  
  try {
    const userInfo = await contractSPS.getUserInfo(userAddress);
    const userId = Number(userInfo[0]);
    
    userHasId = userId > 0;
    const registerTabBtn = document.getElementById('registerTabBtn');
    const registerForm = document.getElementById('registerForm');
    const registerDisabled = document.getElementById('registerDisabled');
    
    if (userHasId) {
      registerTabBtn.style.display = 'none';
      if (registerForm) registerForm.style.display = 'none';
      if (registerDisabled) registerDisabled.style.display = 'block';
      
      if (document.getElementById('registerTab').style.display !== 'none') {
        showTab('dashboard');
      }
    } else {
      registerTabBtn.style.display = 'block';
      if (registerForm) registerForm.style.display = 'block';
      if (registerDisabled) registerDisabled.style.display = 'none';
    }
  } catch (error) {
    userHasId = false;
  }
}

/* ================= P-TOKEN MARKET ================= */
async function initPTokenContract() {
  if (!signer) return;
  
  try {
    contractPToken = new ethers.Contract(PTOKEN_ADDRESS, PTOKEN_ABI, signer);
    
    // Get decimals
    const decimals = await contractPToken.decimals().catch(() => 18);
    ptokenDecimals = Number(decimals);
    
    console.log('‚úÖ P-Token contract initialized');
  } catch (error) {
    console.error('Error initializing P-Token contract:', error);
  }
}

async function loadPTokenMarket() {
  if (!contractPToken || !userAddress) return;
  
  try {
    // Get all data in parallel
    const [price, balance, totalSupply, backingMatic, contractBalance] = await Promise.all([
      contractPToken.getPTokenPrice().catch(() => 0),
      contractPToken.balanceOf(userAddress).catch(() => 0),
      contractPToken.totalSupply().catch(() => 0),
      contractPToken.totalBackingMatic().catch(() => 0),
      contractPToken.getContractMaticBalance().catch(() => 0)
    ]);
    
    // Format data
    const priceFormatted = ethers.formatEther(price);
    const balanceFormatted = ethers.formatUnits(balance, ptokenDecimals);
    const totalSupplyFormatted = ethers.formatUnits(totalSupply, ptokenDecimals);
    const backingMaticFormatted = ethers.formatEther(backingMatic);
    const contractBalanceFormatted = ethers.formatEther(contractBalance);
    
    // Update UI
    document.getElementById('ptokenPrice').textContent = 
      `${parseFloat(priceFormatted).toFixed(6)} MATIC`;
    
    document.getElementById('ptokenBalance').textContent = 
      `${parseFloat(balanceFormatted).toFixed(2)} PTOKEN`;
    
    document.getElementById('totalSupply').textContent = 
      `${parseFloat(totalSupplyFormatted).toFixed(0)}`;
    
    document.getElementById('backingMatic').textContent = 
      `${parseFloat(backingMaticFormatted).toFixed(2)} MATIC`;
    
    document.getElementById('contractBalance').textContent = 
      `${parseFloat(contractBalanceFormatted).substring(0, 10)} MATIC`;
    
    // Update price timestamp
    document.getElementById('priceUpdate').textContent = 
      `Updated: ${new Date().toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}`;
    
    // Update sell preview
    updateSellPreview();
    
  } catch (error) {
    console.error('Error loading P-Token market:', error);
    showStatus('Error loading P-Token data', 'sellResult', 'error');
  }
}

function updateSellPreview() {
  const sellInput = document.getElementById('sellAmount');
  if (!sellInput || !sellInput.value) return;
  
  const sellAmount = parseFloat(sellInput.value) || 0;
  const priceText = document.getElementById('ptokenPrice').textContent;
  const price = parseFloat(priceText) || 0;
  
  const receiveAmount = sellAmount * price;
  document.getElementById('receiveAmount').textContent = 
    `${receiveAmount.toFixed(6)} MATIC`;
}

function setMaxPTokens() {
  const balanceText = document.getElementById('ptokenBalance').textContent;
  const balance = parseFloat(balanceText) || 0;
  
  if (balance > 0) {
    document.getElementById('sellAmount').value = balance.toFixed(2);
    updateSellPreview();
  }
}

async function sellPTokens() {
  if (!contractPToken || !userAddress) {
    showStatus('P-Token contract not loaded', 'sellResult', 'error');
    return;
  }
  
  const sellAmount = document.getElementById('sellAmount').value;
  if (!sellAmount || parseFloat(sellAmount) <= 0) {
    showStatus('Please enter valid amount', 'sellResult', 'error');
    return;
  }
  
  try {
    showLoading(true);
    
    // Convert to correct units
    const amountInUnits = ethers.parseUnits(sellAmount, ptokenDecimals);
    
    // Check balance
    const balance = await contractPToken.balanceOf(userAddress);
    if (amountInUnits > balance) {
      showStatus('Insufficient P-Token balance', 'sellResult', 'error');
      showLoading(false);
      return;
    }
    
    // Execute sell
    const tx = await contractPToken.sellPToken(amountInUnits);
    
    // Handle transaction
    await handleTx(Promise.resolve(tx), 'sellResult');
    
    // Reload market data
    await loadPTokenMarket();
    
  } catch (error) {
    console.error('Error selling P-Tokens:', error);
    showStatus(`Error: ${error.message || 'Sell failed'}`, 'sellResult', 'error');
  } finally {
    showLoading(false);
  }
}

/* ================= TIMERS ================= */
let poolTimerInterval = null;
let specialTimerInterval = null;

function startPoolTimer(lastWithdrawUnix = 0, cycleDuration = 0) {
  if (poolTimerInterval) clearInterval(poolTimerInterval);
  
  function updateTimer() {
    const now = Math.floor(Date.now() / 1000);
    const nextTime = lastWithdrawUnix + cycleDuration;
    const remaining = Math.max(0, nextTime - now);
    
    const container = document.getElementById('poolTimerSegments');
    if (!container) return;
    
    if (remaining === 0) {
      container.innerHTML = '<div style="color:var(--success);font-weight:700">Ready to Withdraw!</div>';
      const btn = document.getElementById('withdrawMainBtn');
      if (btn) btn.classList.remove('disabled');
    } else {
      const days = Math.floor(remaining / 86400);
      const hours = Math.floor((remaining % 86400) / 3600);
      const minutes = Math.floor((remaining % 3600) / 60);
      
      container.innerHTML = `
        <div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; min-width:60px">
          <div style="font-size:18px; font-weight:800">${String(days).padStart(2,'0')}</div>
          <div style="font-size:11px; color:var(--muted)">Days</div>
        </div>
        <div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; min-width:60px">
          <div style="font-size:18px; font-weight:800">${String(hours).padStart(2,'0')}</div>
          <div style="font-size:11px; color:var(--muted)">Hours</div>
        </div>
        <div style="padding:8px 12px; background:rgba(255,255,255,0.05); border-radius:8px; min-width:60px">
          <div style="font-size:18px; font-weight:800">${String(minutes).padStart(2,'0')}</div>
          <div style="font-size:11px; color:var(--muted)">Minutes</div>
        </div>
      `;
      const btn = document.getElementById('withdrawMainBtn');
      if (btn) btn.classList.add('disabled');
    }
  }
  
  updateTimer();
  poolTimerInterval = setInterval(updateTimer, 60000); // Update every minute
}

function startSpecialTimer() {
  if (specialTimerInterval) clearInterval(specialTimerInterval);
  
  function updateSpecialTimer() {
    const now = new Date();
    const target = new Date(now);
    target.setUTCDate(3);
    target.setUTCHours(0, 0, 0, 0);
    
    if (now.getUTCDate() >= 3) {
      target.setUTCMonth(target.getUTCMonth() + 1);
    }
    
    const diff = Math.max(0, Math.floor((target - now) / 1000));
    const days = Math.floor(diff / 86400);
    const hours = Math.floor((diff % 86400) / 3600);
    
    document.getElementById('specialTimerSegments').innerHTML = `
      <div style="font-weight:800; color:var(--accent)">${days}d ${hours}h</div>
    `;
  }
  
  updateSpecialTimer();
  specialTimerInterval = setInterval(updateSpecialTimer, 60000);
}

/* ================= DASHBOARD LOADER ================= */
async function loadDashboardData() {
  if (!contractSPS) return;
  
  try {
    const [poolBal, minerBal, specialBal, entryFee, lastWithdraw, cycleDuration] = await Promise.all([
      contractSPS.poolBalance().catch(() => 0),
      contractSPS.minerTokenPool().catch(() => 0),
      contractSPS.specialRewardPool().catch(() => 0),
      contractSPS.ENTRY_FEE().catch(() => ENTRY_FEE),
      contractSPS.lastPoolWithdrawTime().catch(() => 0),
      contractSPS.CYCLE_DURATION().catch(() => 0)
    ]);
    
    // Update stats
    document.getElementById('poolBalance').textContent = ethers.formatEther(poolBal).substring(0, 10) + ' MATIC';
    document.getElementById('minerPool').textContent = ethers.formatEther(minerBal).substring(0, 10) + ' pToken';
    document.getElementById('specialPool').textContent = ethers.formatEther(specialBal).substring(0, 10) + ' MATIC';
    document.getElementById('entryFeeDisplay').textContent = ethers.formatEther(entryFee) + ' MATIC';
    
    // Start timers
    startPoolTimer(Number(lastWithdraw), Number(cycleDuration));
    startSpecialTimer();
    
    // Load user info
    if (userAddress) {
      const userInfo = await contractSPS.getUserInfo(userAddress).catch(() => null);
      if (userInfo) {
        const userId = Number(userInfo[0]);
        const isMiner = userInfo[10];
        const totalRewards = ethers.formatEther(userInfo[8]);
        
        showStatus(`
          <div style="font-size:18px; font-weight:800; margin-bottom:8px">üë§ User #${userId}</div>
          <div style="margin-bottom:4px">üìä Balance: ${userInfo[6]}</div>
          <div style="margin-bottom:4px">üéÅ Special Awards: ${userInfo[7]}</div>
          <div style="margin-bottom:4px">‚õèÔ∏è Miner: ${isMiner ? '‚úÖ' : '‚ùå'}</div>
          <div style="margin-bottom:4px">üí∞ Total Rewards: ${totalRewards} MATIC</div>
        `, 'userInfo', 'success');
        
        // Check if owner
        const owner = await contractSPS.owner().catch(() => null);
        if (owner && owner.toLowerCase() === userAddress.toLowerCase()) {
          isOwner = true;
          document.getElementById('adminTabBtn').style.display = 'block';
          updateMobileTabs();
        }
        
        // Load points and awards
        await loadPointsAndAwards();
        
        // Check registration
        await checkUserRegistration();
      }
    }
    
  } catch (error) {
    console.error('Load dashboard error:', error);
  }
}

/* ================= CONNECT WALLET ================= */
async function connectWallet() {
  if (typeof window.ethereum === 'undefined') {
    showStatus('‚ùå Wallet (MetaMask) not found', 'userInfo', 'error');
    return;
  }
  
  try {
    showLoading(true);
    showStatus('üîó Connecting...', 'userInfo');
    
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    
    // Check chain
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if (chainId !== POLYGON_CHAIN_ID) {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: POLYGON_CHAIN_ID }]
        });
      } catch (switchError) {
        if (switchError.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: POLYGON_CHAIN_ID,
              chainName: 'Polygon Mainnet',
              nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
              rpcUrls: ['https://polygon-rpc.com'],
              blockExplorerUrls: ['https://polygonscan.com']
            }]
          });
        }
      }
      await new Promise(resolve => setTimeout(resolve, 1000));
    }
    
    // Initialize provider and contracts
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    contractSPS = new ethers.Contract(SPS_ADDRESS, SPS_ABI, signer);
    
    // Initialize P-Token contract
    await initPTokenContract();
    
    // Update UI
    document.getElementById('connectArea').innerHTML = `
      <div style="background:rgba(99,102,241,0.1); color:var(--primary); padding:10px 16px; border-radius:10px; font-weight:800; border:1px solid rgba(99,102,241,0.3)">
        ‚úÖ ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}
      </div>
    `;
    
    // Update status
    document.getElementById('statusDot').classList.add('connected');
    document.getElementById('networkStatus').textContent = 'Connected';
    
    // Load data
    await loadDashboardData();
    
    showStatus('‚úÖ Wallet connected successfully', 'userInfo', 'success');
    
    // Listen for changes
    window.ethereum.on('accountsChanged', () => window.location.reload());
    window.ethereum.on('chainChanged', () => window.location.reload());
    
  } catch (error) {
    showStatus(`‚ùå Error: ${error.message}`, 'userInfo', 'error');
  } finally {
    showLoading(false);
  }
}

/* ================= CORE FUNCTIONS ================= */
async function register() {
  if (userHasId) {
    alert('You are already registered!');
    return;
  }
  
  const uplineCode = document.getElementById('uplineCode').value;
  const position = document.getElementById('position').value === 'true';
  
  if (!uplineCode) {
    alert('Please enter upline code');
    return;
  }
  
  try {
    const txPromise = contractSPS.register(uplineCode, position, { value: ENTRY_FEE });
    await handleTx(txPromise, 'registerResult');
    await checkUserRegistration();
  } catch (error) {
    console.error('Register error:', error);
  }
}

async function contribute() {
  const amount = document.getElementById('contribution').value;
  if (!amount || parseFloat(amount) <= 0) {
    alert('Please enter valid amount');
    return;
  }
  
  try {
    const txPromise = contractSPS.contributeToMinerPool({ value: ethers.parseEther(amount) });
    await handleTx(txPromise, 'minerResult');
  } catch (error) {
    console.error('Contribute error:', error);
  }
}

async function buyTokens() {
  try {
    const txPromise = contractSPS.buyMinerTokens();
    await handleTx(txPromise, 'minerResult');
  } catch (error) {
    console.error('Buy tokens error:', error);
  }
}

async function distribute() {
  try {
    const txPromise = contractSPS.distributeMinerTokens();
    await handleTx(txPromise, 'minerResult');
  } catch (error) {
    console.error('Distribute error:', error);
  }
}

async function withdrawPool() {
  try {
    const txPromise = contractSPS.withdrawPool();
    await handleTx(txPromise, 'withdrawResult');
  } catch (error) {
    console.error('Withdraw pool error:', error);
  }
}

async function withdrawSpecial() {
  try {
    const txPromise = contractSPS.withdrawSpecials();
    await handleTx(txPromise, 'withdrawResult');
  } catch (error) {
    console.error('Withdraw special error:', error);
  }
}

async function updateFee() {
  const newFee = document.getElementById('newFee').value;
  if (!newFee) {
    alert('Please enter new fee');
    return;
  }
  
  try {
    const txPromise = contractSPS.updateEntryFee(newFee);
    await handleTx(txPromise, 'adminResult');
  } catch (error) {
    console.error('Update fee error:', error);
  }
}

async function removeMiners() {
  const addressesText = document.getElementById('addresses').value;
  if (!addressesText) {
    alert('Please enter addresses');
    return;
  }
  
  const addresses = addressesText.split(',').map(addr => addr.trim()).filter(addr => addr.length > 0);
  if (addresses.length === 0) {
    alert('No valid addresses entered');
    return;
  }
  
  try {
    const txPromise = contractSPS.batchRemoveMiners(addresses);
    await handleTx(txPromise, 'adminResult');
  } catch (error) {
    console.error('Remove miners error:', error);
  }
}

/* ================= TAB MANAGEMENT ================= */
function showTab(tabName) {
  // Hide all tabs
  ['dashboard', 'register', 'miner', 'actions', 'ptoken', 'admin'].forEach(tab => {
    document.getElementById(tab + 'Tab').style.display = 'none';
  });
  
  // Remove active class
  document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
  document.querySelectorAll('.mobile-tab-btn').forEach(btn => btn.classList.remove('active'));
  
  // Show selected tab
  document.getElementById(tabName + 'Tab').style.display = 'block';
  
  // Add active class
  document.querySelectorAll('.tab-btn').forEach(btn => {
    if (btn.textContent.trim().toLowerCase().includes(tabName.toLowerCase())) {
      btn.classList.add('active');
    }
  });
  
  document.querySelectorAll('.mobile-tab-btn').forEach(btn => {
    if (btn.textContent.trim().toLowerCase().includes(tabName.toLowerCase())) {
      btn.classList.add('active');
    }
  });
  
  // Special handling
  if (tabName === 'register' && userHasId) {
    showTab('dashboard');
    alert('You are already registered!');
    return;
  }
  
  // Load data
  if (tabName === 'dashboard') {
    loadDashboardData();
  } else if (tabName === 'ptoken') {
    loadPTokenMarket();
  }
}

/* ================= INITIALIZATION ================= */
window.onload = function() {
  // Initialize AI background
  initParticles();
  window.addEventListener('resize', initParticles);
  
  // Initialize mobile menu
  initMobileMenu();
  
  // Set up connect button
  document.getElementById('connectBtn').onclick = connectWallet;
  
  // Auto-connect if previously connected
  if (typeof window.ethereum !== 'undefined') {
    window.ethereum.request({ method: 'eth_accounts' }).then(accounts => {
      if (accounts.length > 0) {
        setTimeout(() => connectWallet(), 1000);
      }
    });
  }
  
  // Start with dashboard
  showTab('dashboard');
};
</script>
</body>
</html>