<!doctype html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>SPS — Ultra Pro DApp</title>

<!-- ethers v5 UMD -->
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
<!-- Web3Modal v1 + WalletConnect -->
<script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
<script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>
<!-- d3 for tree -->
<script src="https://d3js.org/d3.v7.min.js"></script>

<style>
  :root{
    --bg:#051021;
    --panel:#07141f;
    --accent:#7c3aed;
    --muted:#9fb0c8;
    --glass: rgba(255,255,255,0.03);
    --glass-2: rgba(255,255,255,0.02);
    --good:#10b981;
    --bad:#ef4444;
  }
  html,body{height:100%;margin:0;font-family: Vazirmatn, Arial, system-ui; background:linear-gradient(180deg,#020617 0%,#051021 100%); color:#e6eef8; -webkit-font-smoothing:antialiased}
  .app{max-width:1080px;margin:20px auto;padding:18px;position:relative}
  .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); border-radius:14px;padding:16px;box-shadow:0 8px 30px rgba(2,6,12,0.7); border:1px solid rgba(255,255,255,0.03)}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .brand{display:flex;gap:12px;align-items:center}
  .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#00d4ff);display:grid;place-items:center;font-weight:900;color:white;font-size:18px;box-shadow:0 4px 18px rgba(124,58,237,0.22)}
  h1{margin:0;font-size:18px}
  .muted{color:var(--muted);font-size:13px}
  .controls{display:flex;gap:8px;align-items:center}
  button{background:var(--accent);border:none;color:white;padding:9px 12px;border-radius:10px;cursor:pointer;font-weight:600;box-shadow:0 6px 18px rgba(124,58,237,0.12);transition:transform .12s ease,opacity .12s}
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);box-shadow:none}
  button:active{transform:translateY(1px)}
  .grid{display:grid;grid-template-columns:1fr 420px;gap:14px;margin-top:14px}
  @media(max-width:980px){ .grid{grid-template-columns:1fr} .tree-col{height:300px} }
  .panel{background:var(--panel);padding:12px;border-radius:12px;border:1px solid var(--glass)}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input, select {padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:#e6eef8}
  pre{background:transparent;border-radius:8px;padding:10px;color:#cfe8ff;white-space:pre-wrap;word-break:break-word;overflow:auto}
  .mini{font-size:13px;color:var(--muted)}
  #treeView{height:420px;border-radius:10px;border:1px dashed rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));overflow:hidden}
  .badge{padding:6px 10px;border-radius:999px;background:rgba(255,255,255,0.02);color:var(--muted);font-weight:600}
  .status{margin-top:10px;padding:10px;border-radius:10px}
  .status.ok{background:rgba(16,185,129,0.06);color:var(--good)}
  .status.err{background:rgba(239,68,68,0.06);color:var(--bad)}
  /* subtle animation */
  .pulse{animation:pulse 2s infinite}
  @keyframes pulse{0%{box-shadow:0 0 0 0 rgba(124,58,237,0.12)}50%{box-shadow:0 0 0 12px rgba(124,58,237,0.02)}100%{box-shadow:0 0 0 0 rgba(124,58,237,0.00)}}
  .compact{display:flex;gap:8px;align-items:center}
</style>
</head>
<body>
  <div class="app">
    <div class="card">
      <header>
        <div class="brand">
          <div class="logo">SPS</div>
          <div>
            <h1>SPS — Ultra Pro</h1>
            <div class="muted">Network: <span id="networkLabel">—</span></div>
          </div>
        </div>

        <div class="controls">
          <div class="compact">
            <div class="mini">کیف‌پول:</div>
            <div id="walletLabel" class="badge">متصل نیست</div>
          </div>
          <button id="connectBtn" class="pulse">اتصال</button>
          <button id="wcBtn" class="secondary">WalletConnect</button>
          <button id="disconnectBtn" class="secondary" style="display:none">قطع</button>
        </div>
      </header>

      <div class="grid" style="margin-top:14px">
        <!-- left: actions + info -->
        <div>
          <div class="panel" style="margin-bottom:12px">
            <div class="row" style="justify-content:space-between">
              <div>
                <div class="mini">موجودی</div>
                <div id="balance" style="font-weight:800;font-size:18px">— MATIC</div>
              </div>
              <div>
                <div class="mini">User ID</div>
                <div id="userId" style="font-weight:800">—</div>
              </div>
            </div>
          </div>

          <div class="panel" style="margin-bottom:12px">
            <div class="row" style="justify-content:space-between">
              <div>
                <div class="mini">User Info</div>
                <pre id="userInfo" style="min-height:72px">—</pre>
              </div>
              <div style="min-width:140px">
                <div class="mini">آدرس برای جستجو</div>
                <input id="lookupAddr" placeholder="آدرس (خالی=شما)" style="width:100%"/>
                <div style="display:flex;gap:8px;margin-top:8px">
                  <button id="getUserBtn" class="secondary" style="flex:1">دریافت</button>
                  <button id="refreshBtn" style="flex:1">رفرش</button>
                </div>
              </div>
            </div>
          </div>

          <div class="panel">
            <div class="mini" style="margin-bottom:8px">ثبت‌نام — مقدار ثابت: <strong>300 MATIC</strong></div>
            <div class="row">
              <input id="upline" placeholder="upline (ID)" style="width:140px"/>
              <select id="side">
                <option value="true">چپ</option>
                <option value="false">راست</option>
              </select>
              <button id="registerBtn" style="flex:1">ثبت‌نام</button>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="buyMinerBtn" class="secondary" style="flex:1">buyMinerTokens()</button>
              <button id="withdrawPoolBtn" class="secondary" style="flex:1">withdrawPool()</button>
              <button id="withdrawSpecialsBtn" class="secondary" style="flex:1">withdrawSpecials()</button>
            </div>
            <div id="txStatus" class="status" style="display:none;margin-top:12px"></div>
          </div>
        </div>

        <!-- right: tree -->
        <div class="panel tree-col">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div class="mini">ساختار درختی</div>
            <div style="display:flex;gap:8px;align-items:center">
              <input id="depth" value="3" style="width:72px;padding:8px;border-radius:8px"/>
              <button id="loadTreeBtn" class="secondary">بارگذاری</button>
            </div>
          </div>
          <div id="treeView" style="margin-top:10px"></div>
        </div>
      </div>

      <div style="margin-top:12px" class="mini">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <div>آدرس قرارداد: <a id="contractLink" target="_blank" rel="noreferrer" style="color:var(--muted)">0x7a7b06D49129B34976D07B3854d4D72D01588191</a></div>
          <div id="logs" style="flex:1;text-align:left"></div>
        </div>
      </div>
    </div>
  </div>

<script>
/* ================= CONFIG ================= */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
document.getElementById('contractLink').href = 'https://polygonscan.com/address/' + CONTRACT_ADDRESS;
document.getElementById('contractLink').innerText = CONTRACT_ADDRESS;

const POLYGON_CHAIN_ID = 137;
const POLYGON_CHAIN_HEX = '0x89';
const POLYGONSCAN_TX_PREFIX = 'https://polygonscan.com/tx/';

let web3Modal, walletProvider;
let provider, signer, contract;

/* ============== ABI (پیوست شده) ============== */
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},{"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}];

/* ============= UI refs ============= */
const connectBtn = document.getElementById('connectBtn');
const wcBtn = document.getElementById('wcBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const walletLabel = document.getElementById('walletLabel');
const networkLabel = document.getElementById('networkLabel');
const balanceEl = document.getElementById('balance');
const userInfoEl = document.getElementById('userInfo');
const userIdEl = document.getElementById('userId');
const lookupAddr = document.getElementById('lookupAddr');
const getUserBtn = document.getElementById('getUserBtn');
const refreshBtn = document.getElementById('refreshBtn');
const registerBtn = document.getElementById('registerBtn');
const uplineInput = document.getElementById('upline');
const sideSelect = document.getElementById('side');
const buyMinerBtn = document.getElementById('buyMinerBtn');
const withdrawPoolBtn = document.getElementById('withdrawPoolBtn');
const withdrawSpecialsBtn = document.getElementById('withdrawSpecialsBtn');
const txStatus = document.getElementById('txStatus');
const logs = document.getElementById('logs');
const loadTreeBtn = document.getElementById('loadTreeBtn');
const depthInput = document.getElementById('depth');
const treeView = document.getElementById('treeView');

/* ============ utils ============ */
function log(msg){
  const t = new Date().toLocaleTimeString();
  logs.innerText = `[${t}] ${msg}`;
}
function showTx(text, ok=true){
  txStatus.style.display = 'block';
  txStatus.className = 'status ' + (ok ? 'ok' : 'err');
  txStatus.innerText = text;
  setTimeout(()=>{ txStatus.style.display='none'; }, 7000);
}
function short(addr){
  if(!addr) return '—';
  return addr.slice(0,6) + '…' + addr.slice(-4);
}

/* init Web3Modal */
function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: { rpc: { 137: 'https://polygon-rpc.com' } }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider:false, providerOptions });
}

/* ensure provider for read-only */
function ensureReadProvider(){
  if(!provider){
    provider = new ethers.providers.JsonRpcProvider('https://polygon-rpc.com');
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, provider);
  }
}

/* connect injected */
async function connectInjected(){
  try {
    if(!window.ethereum) throw new Error('No injected wallet');
    await window.ethereum.request({ method:'eth_requestAccounts' });
    provider = new ethers.providers.Web3Provider(window.ethereum);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletLabel.innerText = short(addr);
    disconnectBtn.style.display = 'inline-block';
    await refreshNetworkAndBalance();
    log('متصل شد: ' + addr);
  } catch(e){
    console.error(e); log('connectInjected error: ' + (e && e.message)); showTx('خطا در اتصال', false);
  }
}

/* connect WalletConnect */
async function connectWalletConnect(){
  try {
    walletProvider = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(walletProvider);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletLabel.innerText = short(addr);
    disconnectBtn.style.display = 'inline-block';
    await refreshNetworkAndBalance();
    log('WalletConnect متصل: ' + addr);
    walletProvider.on && walletProvider.on('disconnect', ()=>{ disconnectWallet(); });
  } catch(e){
    console.error(e); log('connectWC error: ' + (e && e.message)); showTx('خطا در WalletConnect', false);
  }
}

function disconnectWallet(){
  try{ if(walletProvider && walletProvider.close) walletProvider.close(); }catch(e){}
  provider = null; signer = null; contract = null; walletProvider = null;
  walletLabel.innerText = 'متصل نیست'; userInfoEl.innerText='—'; userIdEl.innerText='—'; balanceEl.innerText='— MATIC';
  disconnectBtn.style.display = 'none';
  log('قطع اتصال');
}

/* network / balance refresh */
async function refreshNetworkAndBalance(){
  try {
    if(!provider) return;
    const net = await provider.getNetwork();
    networkLabel.innerText = (net.name || net.chainId) + ' ('+ net.chainId +')';
    if(net.chainId !== POLYGON_CHAIN_ID){
      try {
        await trySwitchToPolygon();
      } catch(e){ log('شبکه غیر Polygon'); }
    }
    if(signer){
      const addr = await signer.getAddress();
      const bal = await provider.getBalance(addr);
      balanceEl.innerText = ethers.utils.formatEther(bal).slice(0,10) + ' MATIC';
    } else {
      // read-only balance hidden
      balanceEl.innerText = '— MATIC';
    }
  } catch(e){
    console.error(e);
  }
}

/* try switch to polygon */
async function trySwitchToPolygon(){
  if(!window.ethereum) throw new Error('no injected to switch');
  try {
    await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{chainId:POLYGON_CHAIN_HEX}]});
    log('switched to Polygon');
  } catch(s){
    if(s && s.code === 4902){
      try {
        await window.ethereum.request({ method:'wallet_addEthereumChain', params:[{
          chainId:POLYGON_CHAIN_HEX, chainName:'Polygon Mainnet',
          nativeCurrency:{name:'MATIC',symbol:'MATIC',decimals:18},
          rpcUrls:['https://polygon-rpc.com'], blockExplorerUrls:['https://polygonscan.com']
        }]});
      } catch(e){ throw e; }
    } else throw s;
  }
}

/* read user info */
async function readUserInfo(addrOverride){
  try {
    ensureReadProvider();
    let addr = addrOverride || (signer ? await signer.getAddress() : null);
    if(lookupAddr.value && lookupAddr.value.trim() !== '') addr = lookupAddr.value.trim();
    if(!addr) return alert('آدرس موجود نیست');
    const info = await contract.getUserInfo(addr);
    const parsed = {
      id: info[0].toString(),
      uplineId: info[1].toString(),
      leftCount: info[2].toString(),
      rightCount: info[3].toString(),
      saveLeft: info[4].toString(),
      saveRight: info[5].toString(),
      balanceCount: info[6].toString(),
      specialBalanceCount: info[7].toString(),
      totalMinerRewards: info[8].toString(),
      entryPrice: ethers.utils.formatEther(info[9] || '0'),
      isMiner: info[10]
    };
    userInfoEl.innerText = JSON.stringify(parsed, null, 2);
    userIdEl.innerText = parsed.id === '0' ? '—' : parsed.id;
    log('UserInfo loaded for ' + short(addr));
    return parsed;
  } catch(e){
    console.error(e);
    log('readUserInfo error: ' + (e && e.message));
    showTx('خطا در دریافت اطلاعات', false);
  }
}

/* register (fixed 300 MATIC) */
async function registerAction(){
  try {
    if(!signer) return alert('ابتدا کیف‌پول را متصل کنید');
    const uplineRaw = uplineInput.value.trim();
    if(!uplineRaw) return alert('upline ID وارد نشده');
    const upline = Number(uplineRaw);
    const placeOnLeft = sideSelect.value === 'true';
    const valueToSend = ethers.utils.parseEther('300'); // fixed 300 MATIC

    showTx('ارسال تراکنش ثبت‌نام...');
    const tx = await contract.register(upline, placeOnLeft, { value: valueToSend });
    log('register tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    showTx('ثبت‌نام موفق', true);
    await refreshNetworkAndBalance();
    await readUserInfo();
  } catch(e){
    console.error(e);
    log('register error: ' + (e && e.message));
    showTx('ثبت‌نام خطا', false);
    alert('ثبت‌نام ناموفق: ' + (e && e.message));
  }
}

/* buyMinerTokens */
async function buyMinerTokens(){
  try {
    if(!signer) return alert('ابتدا کیف‌پول را متصل کنید');
    showTx('ارسال buyMinerTokens...');
    const tx = await contract.buyMinerTokens();
    log('buyMiner tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    showTx('buyMinerTokens موفق', true);
  } catch(e){
    console.error(e);
    log('buyMiner error: ' + (e && e.message));
    showTx('buyMiner خطا', false);
  }
}

/* withdrawPool */
async function withdrawPool(){
  try {
    if(!signer) return alert('ابتدا کیف‌پول را متصل کنید');
    showTx('ارسال withdrawPool...');
    const tx = await contract.withdrawPool();
    log('withdrawPool tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    showTx('withdrawPool موفق', true);
  } catch(e){
    console.error(e);
    log('withdrawPool error: ' + (e && e.message));
    showTx('withdrawPool خطا', false);
  }
}

/* withdrawSpecials */
async function withdrawSpecials(){
  try {
    if(!signer) return alert('ابتدا کیف‌پول را متصل کنید');
    showTx('ارسال withdrawSpecials...');
    const tx = await contract.withdrawSpecials();
    log('withdrawSpecials tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    showTx('withdrawSpecials موفق', true);
  } catch(e){
    console.error(e);
    log('withdrawSpecials error: ' + (e && e.message));
    showTx('withdrawSpecials خطا', false);
  }
}

/* ========== Tree functions ========== */
/* fetch directs by userId recursively using getUserDirects */
async function fetchTreeById(userId, depth){
  if(!userId || userId === 0 || depth <= 0) return { name: `ID ${userId}`, id:userId, children:[] };
  try {
    const res = await contract.getUserDirects(userId);
    const leftId = Number(res.leftId || res[0]) || 0;
    const rightId = Number(res.rightId || res[1]) || 0;
    const node = { name: `ID ${userId}`, id:userId, children:[] };
    if(leftId) node.children.push(await fetchTreeById(leftId, depth-1));
    if(rightId) node.children.push(await fetchTreeById(rightId, depth-1));
    return node;
  } catch(e){
    return { name: `ID ${userId}`, id:userId, children:[] };
  }
}

function drawTree(data){
  treeView.innerHTML = '';
  if(!data) { treeView.innerHTML = '<div class="mini">درخت خالی است</div>'; return; }
  const width = treeView.clientWidth || 420;
  const height = treeView.clientHeight || 420;
  const svg = d3.select(treeView).append('svg').attr('width', width).attr('height', height);
  const g = svg.append('g').attr('transform', 'translate(20,20)');
  const root = d3.hierarchy(data);
  const treeLayout = d3.tree().size([width - 80, height - 80]);
  treeLayout(root);

  g.selectAll('path.link').data(root.links()).enter().append('path')
    .attr('d', d3.linkVertical().x(d=>d.x).y(d=>d.y))
    .attr('fill','none').attr('stroke','#7c3aed').attr('stroke-width',2).attr('opacity',0.95);

  const node = g.selectAll('g.node').data(root.descendants()).enter().append('g').attr('transform', d=>`translate(${d.x},${d.y})`);

  node.append('circle').attr('r',18).attr('fill','#0b1220').attr('stroke','#7c3aed').attr('stroke-width',2)
    .on('mouseover', function(){ d3.select(this).transition().attr('r',22); })
    .on('mouseout', function(){ d3.select(this).transition().attr('r',18); });

  node.append('text').attr('dy',5).attr('text-anchor','middle').attr('fill','#e6eef8').style('font-size','12px')
    .text(d=>d.data.name);
}

/* ========== wiring UI ========== */
initWeb3Modal();
ensureReadProvider();

connectBtn.addEventListener('click', async ()=>{
  if(window.ethereum) await connectInjected(); else await connectWalletConnect();
});
wcBtn.addEventListener('click', async ()=> { await connectWalletConnect(); });
disconnectBtn.addEventListener('click', ()=> { disconnectWallet(); });

getUserBtn && getUserBtn.addEventListener('click', async ()=> { await readUserInfo(); });
refreshBtn && refreshBtn.addEventListener('click', async ()=> { await refreshNetworkAndBalance(); if(signer) await readUserInfo(); });
registerBtn.addEventListener('click', async ()=> { await registerAction(); });
buyMinerBtn.addEventListener('click', async ()=> { await buyMinerTokens(); });
withdrawPoolBtn.addEventListener('click', async ()=> { await withdrawPool(); });
withdrawSpecialsBtn.addEventListener('click', async ()=> { await withdrawSpecials(); });

loadTreeBtn.addEventListener('click', async ()=>{
  try {
    if(!signer) return alert('کیف‌پول را وصل کن');
    const me = await signer.getAddress();
    const info = await contract.getUserInfo(me);
    const myId = Number(info[0].toString());
    if(!myId || myId === 0) return alert('شما ثبت‌نام نشده‌اید');
    const depth = Number(depthInput.value) || 3;
    showTx('در حال بارگذاری درخت...');
    const data = await fetchTreeById(myId, depth);
    drawTree(data);
    showTx('درخت بارگذاری شد', true);
  } catch(e){
    console.error(e);
    log('loadTree error: ' + (e && e.message));
    showTx('خطا در بارگذاری درخت', false);
  }
});

/* auto read entry fee on load (readonly) */
(async function init(){
  ensureReadProvider();
  try {
    // read ENTRY_FEE to display (if needed)
    const fee = await contract.ENTRY_FEE();
    // don't show many texts; show only if mismatch
    log('DApp آماده');
  } catch(e){
    // ignore
  }
})();

</script>
</body>
</html>
