<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>SPS DApp â€” Ultra Final</title>

<!-- Ethers (used by JS in Part 3) -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>

<!-- Fallback font: Inter (system fonts used if Inter not available) -->
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<style>
/* ================== THEME & ROOT ================== */
:root{
  --bg-1: #040615;
  --bg-2: #071029;
  --muted: #9fb3cf;
  --primary: #3b82f6;
  --accent: #8b5cf6;
  --neon: #00ffd5;
  --neon-2: #7c3aed;
  --success: #10b981;
  --danger: #ef4444;
  --glass-border: rgba(255,255,255,0.04);
  --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.006));
  --transp: rgba(255,255,255,0.02);
  --shadow-1: 0 12px 40px rgba(2,8,20,0.6);
  --max-width: 1200px;
}

/* ================== RESET ================== */
*{box-sizing:border-box;margin:0;padding:0}
html[dir="rtl"]{direction:rtl} html[dir="ltr"]{direction:ltr}
body{
  font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  background:
    radial-gradient(800px 320px at 8% 12%, rgba(124,58,237,0.03), transparent),
    radial-gradient(700px 280px at 92% 88%, rgba(0,255,213,0.02), transparent),
    linear-gradient(180deg, var(--bg-1) 0%, var(--bg-2) 100%);
  color: #e6eef8;
  -webkit-font-smoothing:antialiased;
  -moz-osx-font-smoothing:grayscale;
  min-height:100vh;
  padding:20px;
}

/* ================== LAYOUT ================== */
.container{
  max-width: var(--max-width);
  margin: 0 auto;
  position: relative;
  z-index: 10;
}

/* header */
.header{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:12px;
  padding:14px;
  border-radius:12px;
  background: var(--card-bg);
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow-1);
  backdrop-filter: blur(6px) saturate(120%);
}

/* logo 3D flipping */
.logo-3d{ width:100px; height:48px; perspective:1000px; display:flex; align-items:center; justify-content:center; position:relative; }
.logo-card{ width:100px; height:48px; border-radius:12px; position:relative; transform-style:preserve-3d; transition: transform .8s cubic-bezier(.2,.9,.3,1); }
.logo-face{ position:absolute; inset:0; display:flex; align-items:center; justify-content:center; backface-visibility:hidden; -webkit-backface-visibility:hidden; font-weight:800 }
.logo-face.front svg{ width:84px; height:36px }
.logo-face.back{ transform: rotateY(180deg); color: var(--neon); font-size:20px; text-shadow: 0 0 12px rgba(0,255,213,0.2) }
.logo-glow{ position:absolute; inset:-18%; z-index:-1; filter: blur(28px); opacity:0.6; border-radius:14px;
  background:
    radial-gradient(circle at 20% 30%, rgba(59,130,246,0.12), transparent 20%),
    radial-gradient(circle at 80% 70%, rgba(124,58,237,0.10), transparent 20%),
    radial-gradient(circle at 50% 50%, rgba(0,255,213,0.06), transparent 30%);
}

/* status and language */
.status-ind{ display:flex; gap:10px; align-items:center }
.status-dot{ width:12px; height:12px; border-radius:50%; background:var(--danger); box-shadow: 0 0 10px rgba(239,68,68,0.18) }
.status-dot.connected{ background:var(--success); box-shadow: 0 0 18px rgba(16,185,129,0.12); }
.network-text{ font-weight:700; color:var(--muted) }

.lang-switch{ display:flex; gap:8px; align-items:center }
.lang-btn{ padding:8px 10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); cursor:pointer; background:transparent; color:var(--muted); font-weight:700 }
.lang-btn.active{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:#041426; box-shadow:0 8px 26px rgba(59,130,246,0.10) }

/* tabs */
.tabs{ display:flex; gap:8px; margin:14px 0; flex-wrap:wrap }
.tab-btn{ padding:10px 12px; border-radius:8px; background:transparent; border:1px solid rgba(255,255,255,0.02); color:var(--muted); cursor:pointer; font-weight:700 }
.tab-btn.active{ background: linear-gradient(90deg, rgba(59,130,246,0.08), rgba(139,92,246,0.04)); color:var(--primary); box-shadow: 0 8px 26px rgba(59,130,246,0.04) }

/* grid & cards */
.stats-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(220px,1fr)); gap:16px; margin:14px 0 }
.stat-box{ padding:14px; border-radius:12px; background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); border:1px solid var(--glass-border); box-shadow: 0 12px 30px rgba(2,8,20,0.6) }
.stat-label{ color:var(--muted); font-size:13px }
.stat-value{ font-size:18px; font-weight:900; color:#dff5ff; margin-top:8px }

/* general card */
.card{ padding:14px; border-radius:12px; border: 1px solid var(--glass-border); background: linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005)); box-shadow: 0 12px 30px rgba(5,10,25,0.6) }

/* radial tree container */
.tree-container{ height:560px; border-radius:12px; overflow:hidden; background: transparent; padding:8px }
#radialWrap{ width:100%; height:560px; display:flex; align-items:center; justify-content:center; position:relative }
#radialSvg{ width:100%; height:100% }

/* nodes */
.node-circle{ cursor:pointer; transition: transform .18s ease }
.node-circle:hover{ transform: scale(1.08) }
.node-label{ font-size:12px; fill:#e6eef8; font-weight:700 }
.node-meta{ font-size:11px; fill:var(--muted) }

/* countdown / timer UI */
.countdown{ display:flex; align-items:center; gap:12px; padding:12px; border-radius:12px; background: linear-gradient(90deg, rgba(59,130,246,0.04), rgba(124,58,237,0.03)); border:1px solid rgba(255,255,255,0.02) }
.time-segment{ display:flex; flex-direction:column; align-items:center; padding:8px 12px; border-radius:8px; background: rgba(255,255,255,0.01) }
.time-value{ font-size:18px; color:#e6f8ff; font-weight:900 }
.time-label{ color:var(--muted); font-size:12px }

/* buttons */
.btn{ padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800 }
.btn-primary{ background: linear-gradient(90deg,var(--primary),var(--accent)); color:white; box-shadow: 0 12px 30px rgba(59,130,246,0.06) }
.btn-success{ background: linear-gradient(90deg,var(--success),#34d399); color:#031612 }
.btn-danger{ background: linear-gradient(90deg,var(--danger),#f87171); color:#2b0e0e }

/* tx toast (global) */
.tx-toast{ position:fixed; right:20px; bottom:20px; z-index:13000; min-width:320px; background: linear-gradient(90deg, rgba(0,0,0,0.6), rgba(255,255,255,0.02)); border-radius:12px; padding:12px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 20px 50px rgba(2,8,20,0.7); color:#e6eef8; display:flex; gap:12px; align-items:center; transform:translateY(20px); opacity:0; transition: transform .32s ease, opacity .32s ease }
.tx-toast.show{ transform:translateY(0); opacity:1 }

/* trust toast centered */
.trust-toast{ position:fixed; left:50%; transform:translateX(-50%); bottom:28px; background:linear-gradient(90deg,rgba(0,0,0,0.6),rgba(255,255,255,0.02)); padding:12px 18px; border-radius:12px; border:1px solid rgba(255,255,255,0.04); box-shadow:0 12px 40px rgba(2,8,20,0.6); z-index:13000; display:flex; gap:12px; align-items:center; opacity:0; transition:opacity .28s,transform .28s }
.trust-toast.show{ opacity:1; transform:translateX(-50%) translateY(0) }

/* loading overlay */
.loading{ display:none; position:fixed; inset:0; background: rgba(0,0,0,0.6); z-index:9999; align-items:center; justify-content:center }
.spinner{ width:80px; height:80px; border-radius:50%; border:6px solid rgba(255,255,255,0.04); border-top-color:var(--neon); animation: spin 1s linear infinite }
@keyframes spin{ to{ transform: rotate(360deg) } }

/* particle canvas layers (positioned behind UI) */
#neonParticles, #confetti{ position: fixed; inset: 0; z-index: 0; pointer-events: none }
#neuralWave{ position: fixed; inset:0; z-index:0; pointer-events:none; mix-blend-mode: screen }

/* responsive tweaks */
@media (max-width: 980px){
  .stats-grid{ grid-template-columns: 1fr }
  #radialWrap{ height:420px }
  .header{ flex-direction:column; align-items:flex-start }
}

/* small helper classes */
.hidden{ display:none !important }
.small-muted{ color:var(--muted); font-size:13px }

/* END OF CSS */
</style>

<!-- Small inline helper script to ensure body dir / language default (real language logic lives in Part 3) -->
<script>
  (function(){
    try{
      const saved = localStorage.getItem('sps_lang');
      if(saved) document.documentElement.setAttribute('dir', saved === 'en' ? 'ltr' : 'rtl');
    }catch(e){}
  })();
</script>

</head>
<body>

  <!-- Visual canvas layers (will be drawn by Part 3 JS) -->
  <canvas id="neonParticles"></canvas>
  <canvas id="confetti"></canvas>
  <div id="neuralWave" aria-hidden="true"></div>

  <div class="container" role="main">
    <!-- HEADER -->
    <header class="header" role="banner" aria-label="SPS header">
      <div style="display:flex;align-items:center;gap:14px">
        <div class="logo-3d" aria-hidden="true">
          <div id="logoCard" class="logo-card" role="img" aria-label="SPS Logo">
            <div class="logo-face front" id="logoFront" aria-hidden="true">
              <!-- inline SVG logo -->
              <svg viewBox="0 0 200 60" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
                <defs><linearGradient id="lgA" x1="0" x2="1"><stop offset="0" stop-color="#3b82f6"/><stop offset="1" stop-color="#8b5cf6"/></linearGradient></defs>
                <text x="50%" y="55%" text-anchor="middle" font-family="Inter, Tahoma, Arial" font-weight="800" font-size="36" fill="url(#lgA)" style="letter-spacing:2px">SPS</text>
              </svg>
            </div>
            <div class="logo-face back" id="logoBack" aria-hidden="true">$</div>
            <div class="logo-glow" aria-hidden="true"></div>
          </div>
        </div>

        <div class="status-ind" aria-hidden="true">
          <div id="statusDot" class="status-dot"></div>
          <div id="networkStatus" class="network-text">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</div>
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px">
        <div class="lang-switch" role="tablist" aria-label="Language switch">
          <button id="btn-fa" class="lang-btn" aria-pressed="true">FA</button>
          <button id="btn-en" class="lang-btn" aria-pressed="false">EN</button>
        </div>
        <div id="connectArea">
          <button id="connectBtn" class="btn-primary btn" aria-label="Connect Wallet">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
        </div>
      </div>
    </header>

    <!-- TABS -->
    <nav class="tabs" role="navigation" aria-label="Main tabs">
      <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
      <button class="tab-btn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
      <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
      <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
      <button class="tab-btn hidden" id="adminTabBtn" onclick="showTab('admin')">Ù…Ø¯ÛŒØ±ÛŒØª</button>
    </nav>

    <!-- DASHBOARD -->
    <section id="dashboardTab" style="display:block;">
      <!-- Contract links (clickable) -->
      <div style="margin:12px 0; display:flex; gap:12px; align-items:center;">
        <a id="contractLinkSmart" href="https://polygonscan.com/address/0x7a7b06D49129B34976D07B3854d4D72D01588191" target="_blank" rel="noreferrer" class="small-muted">Smart Contract (SPS)</a>
        <span class="small-muted">â€¢</span>
        <a id="contractLinkPToken" href="https://polygonscan.com/address/0x82F7dBe1792436d15bdA22bB3340bD3f45D614Fa#code" target="_blank" rel="noreferrer" class="small-muted">pToken Contract</a>
      </div>

      <div class="stats-grid" aria-hidden="false">
        <div class="stat-box" role="article" aria-label="Pool balance">
          <div class="stat-label" id="label-pool">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
          <div class="stat-value" id="poolBalance">0 MATIC</div>
        </div>

        <div class="stat-box" role="article" aria-label="Miner pool">
          <div class="stat-label" id="label-minerpool">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
          <div class="stat-value" id="minerPool">0 pToken</div>
          <div id="ptokenPriceInfo" class="small-muted" style="margin-top:8px">Ù‚ÛŒÙ…Øª pToken: â€”</div>
        </div>

        <div class="stat-box" role="article" aria-label="Special pool">
          <div class="stat-label">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
          <div class="stat-value" id="specialPool">0 MATIC</div>
        </div>

        <div class="stat-box" role="article" aria-label="Entry fee">
          <div class="stat-label">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
          <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
        </div>
      </div>

      <div class="grid" style="display:grid; grid-template-columns:1fr 1fr; gap:16px; margin-top:16px;">
        <!-- LEFT: User info + register area -->
        <div class="card" style="min-height:320px">
          <h3 id="h-userinfo">ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
          <div id="userInfo" class="small-muted" style="margin-top:8px">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª</div>

          <!-- Register area (will be hidden if user has id) -->
          <div id="registerTab" style="margin-top:12px">
            <div style="margin-bottom:8px"><label for="uplineCode">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label><input id="uplineCode" type="number" placeholder="1" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit"></div>
            <div style="margin-bottom:8px"><label for="position">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
              <select id="position" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
                <option value="true">Ú†Ù¾</option><option value="false">Ø±Ø§Ø³Øª</option>
              </select>
            </div>
            <div style="display:flex;gap:8px;margin-top:10px">
              <button id="btn-register" class="btn-primary btn" onclick="register()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
            </div>
            <div id="registerResult" style="margin-top:10px"></div>
          </div>

          <div id="userActions" style="margin-top:14px; display:none;">
            <!-- actions for active user -->
            <div style="display:flex;gap:8px">
              <button class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø³ØªØ®Ø±</button>
              <button class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡</button>
            </div>
            <div id="withdrawResult" style="margin-top:10px"></div>
          </div>

        </div>

        <!-- RIGHT: Radial tree -->
        <div class="card">
          <h3>ğŸŒŒ Ù†Ù…ÙˆØ¯Ø§Ø± Ø´Ø¨Ú©Ù‡ â€” Radial (Ú†Ù¾/Ø±Ø§Ø³Øª ØªØ§ Ø³Ø·Ø­ 6)</h3>
          <div id="radialWrap" class="tree-container" style="margin-top:10px">
            <svg id="radialSvg" viewBox="0 0 1000 600" preserveAspectRatio="xMidYMid meet"></svg>
          </div>
          <div class="small-muted" style="margin-top:8px">Ø±ÙˆÛŒ Ù‡Ø± Ù†ÙˆØ¯ Ú©Ù„ÛŒÚ© Ú©Ù† ØªØ§ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¢Ù† Ø¯Ø± Ù¾Ù†Ù„ Ú©Ø§Ø±Ø¨Ø±ÛŒ Ù†Ù…Ø§ÛŒØ´ ÛŒØ§Ø¨Ø¯.</div>
        </div>
      </div>
    </section>

    <!-- MINER tab -->
    <section id="minerTab" style="display:none; margin-top:18px;">
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px;">
        <div class="card">
          <h3>â›ï¸ Ù…Ø§ÛŒÙ†Ø±</h3>
          <div style="margin-top:8px">
            <label for="contribution">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
            <input id="contribution" placeholder="0.1" style="width:100%;margin-top:6px;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit">
          </div>
          <div id="ptokenPriceDisplay" class="small-muted" style="margin-top:8px">Ù‚ÛŒÙ…Øª pToken: â€”</div>
          <div style="display:flex;gap:8px;margin-top:12px">
            <button class="btn btn-success" onclick="contribute()">Ù…Ø´Ø§Ø±Ú©Øª</button>
            <button class="btn btn-primary" onclick="buyTokens()">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ù…Ø§ÛŒÙ†Ø±</button>
            <button class="btn btn" onclick="distribute()">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
          </div>
          <div id="minerResult" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
          <div id="minerInfo" class="small-muted">Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§ Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>
      </div>
    </section>

    <!-- ACTIONS tab -->
    <section id="actionsTab" style="display:none; margin-top:18px;">
      <div class="grid" style="grid-template-columns:1fr 1fr; gap:16px;">
        <div class="card">
          <h3>ğŸ’¸ Ø¹Ù…Ù„ÛŒØ§Øª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
          <div class="countdown" style="margin-top:10px">
            <div><strong id="poolTimerLabel">Ø§Ø®Ø±ÛŒÙ† Ø¨Ø±Ø¯Ø§Ø´Øª</strong></div>
            <div id="poolTimerSegments" style="display:flex;gap:6px;margin-left:8px"></div>
          </div>

          <div class="countdown" style="margin-top:10px">
            <div><strong id="specialTimerLabel">Ø¨Ø±Ø¯Ø§Ø´Øª ÙˆÛŒÚ˜Ù‡ Ø¨Ø¹Ø¯ÛŒ</strong></div>
            <div id="specialTimerSegments" style="display:flex;gap:6px;margin-left:8px"></div>
          </div>

          <div style="margin-top:12px; display:flex; gap:8px;">
            <button id="withdrawMainBtn" class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±</button>
            <button id="withdrawSpecialBtn" class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
          </div>

          <div id="withdrawActionResult" style="margin-top:10px"></div>
        </div>

        <div class="card">
          <h3>ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
          <div id="withdrawInfo" class="small-muted">ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.</div>
        </div>
      </div>
    </section>

    <!-- ADMIN tab (hidden unless owner) -->
    <section id="adminTab" style="display:none; margin-top:18px;">
      <div class="card">
        <h3>âš™ï¸ Ù…Ø¯ÛŒØ±ÛŒØª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
        <div style="margin-top:8px">
          <label for="newFee">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
          <input id="newFee" placeholder="300000000000000000000" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:transparent;color:inherit;margin-top:6px">
        </div>
        <div style="margin-top:10px"><button class="btn btn-danger" onclick="updateFee()">Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ</button></div>
        <div id="adminResult" style="margin-top:10px"></div>
      </div>
    </section>

    <div id="loading" class="loading"><div class="spinner" role="status" aria-hidden="true"></div></div>

    <!-- Toast container for global TX confirmations -->
    <div id="txToastContainer" aria-live="polite" aria-atomic="true"></div>
    <!-- Centered trust toast -->
    <div id="trustToast" class="trust-toast" role="status" aria-live="polite" style="display:none;">
      <div id="trustIcon">âœ…</div>
      <div id="trustMessage" style="min-width:220px">ØªØ±Ø§Ú©Ù†Ø´ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯</div>
      <a id="trustLink" href="#" class="small-muted" target="_blank" rel="noreferrer" style="margin-left:12px;text-decoration:none;color:#9ecbff">Ù…Ø´Ø§Ù‡Ø¯Ù‡</a>
    </div>

    <footer style="margin-top:18px;color:var(--muted);text-align:center">SPS Network â€¢ Polygon Mainnet</footer>
  </div>

<script>
/* =================== Part 3: JS / ABI / Web3 Logic =================== */

/* ====== Constants ====== */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
const PTOKEN_ADDRESS = "0x82F7dBe1792436d15bdA22bB3340bD3f45D614Fa";
const POLYGON_CHAIN_ID = "0x89";
const ENTRY_FEE = "300000000000000000000"; // 300 MATIC

/* ====== CONTRACT ABI (FULL) ======
   NOTE: This ABI is the full ABI used earlier in the conversation.
   If you have a different/updated ABI, replace this array with your exact ABI.
*/
const CONTRACT_ABI = [
  {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},
  {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},
  {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"eligibleSpecialUserCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
  {"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"specialPointCount","stateMutability":"view","type":"function"},
  {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
  {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
  {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
];

/* ====== State ====== */
let provider, signer, contract;
let userAddress = null;
let userIdGlobal = 0;
let isOwner = false;

/* ====== Utilities: Loading / status ====== */
function showLoading(show){
  const l = document.getElementById('loading');
  if(!l) return;
  l.style.display = show ? 'flex' : 'none';
}
function showStatus(message, targetId='userInfo'){
  const el = document.getElementById(targetId);
  if(!el) return;
  el.innerHTML = message;
}

/* ====== TX: pending and confirmed UI ====== */
function showPending(txHash, targetId){
  const el = document.getElementById(targetId);
  if(el) el.innerHTML = `â³ ${lang==='en' ? 'Transaction pending' : 'ØªØ±Ø§Ú©Ù†Ø´ Ø¯Ø± ØµÙ'} â€” <a href="https://polygonscan.com/tx/${txHash}" target="_blank" rel="noreferrer">View on Polygonscan</a>`;
}
function showTransactionLink(txHash, targetId){
  const el = document.getElementById(targetId);
  if(el) el.innerHTML = `âœ… ${lang==='en' ? 'Transaction confirmed' : 'ØªØ±Ø§Ú©Ù†Ø´ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯'} â€” <a href="https://polygonscan.com/tx/${txHash}" target="_blank" rel="noreferrer">View on Polygonscan</a>`;
  // global trust toast
  showConfirmToast(txHash);
}

/* ====== Global toast with polygonscan link ====== */
function showConfirmToast(txHash){
  const container = document.getElementById('txToastContainer') || (function(){
    const c = document.createElement('div'); c.id='txToastContainer'; document.body.appendChild(c); return c;
  })();

  const toast = document.createElement('div');
  toast.className = 'tx-toast show';
  toast.innerHTML = `<div style="flex:1;font-weight:900">${lang==='en'?'Transaction confirmed':'ØªØ±Ø§Ú©Ù†Ø´ ØªØ£ÛŒÛŒØ¯ Ø´Ø¯'}</div>
    <div><a href="https://polygonscan.com/tx/${txHash}" target="_blank" rel="noreferrer" style="background:linear-gradient(90deg,var(--neon),var(--neon-2));padding:8px 10px;border-radius:8px;color:#02161a;font-weight:800;text-decoration:none">${lang==='en'?'View':'Ù…Ø´Ø§Ù‡Ø¯Ù‡'}</a></div>`;
  container.appendChild(toast);
  // show animation in
  setTimeout(()=>{ toast.classList.add('show'); }, 50);
  // remove after 9s
  setTimeout(()=>{ toast.remove(); }, 9000);
}

/* ====== Confetti (simple) ====== */
(function initConfetti(){
  const canvas = document.getElementById('confetti');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  let pieces = [];
  function spawn(){
    pieces = [];
    for(let i=0;i<120;i++){
      pieces.push({ x: Math.random()*canvas.width, y: -Math.random()*canvas.height, vx:(Math.random()-0.5)*6, vy:2+Math.random()*6, size:6+Math.random()*8, color:['#3b82f6','#8b5cf6','#00ffd5','#ffb86b'][Math.floor(Math.random()*4)], rot:Math.random()*360, rotV:(Math.random()-0.5)*10 });
    }
    draw();
  }
  function draw(){
    ctx.clearRect(0,0,canvas.width, canvas.height);
    pieces.forEach((p,i)=>{
      ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
      ctx.fillStyle = p.color; ctx.fillRect(-p.size/2, -p.size/2, p.size, p.size*0.6); ctx.restore();
      p.x += p.vx; p.y += p.vy; p.rot += p.rotV;
      if(p.y > canvas.height + 50) pieces.splice(i,1);
    });
    if(pieces.length>0) requestAnimationFrame(draw); else canvas.style.display='none';
  }
  window.spawnConfetti = function(){ canvas.style.display='block'; spawn(); };
})();

/* ====== Neon particles (lightweight) ====== */
(function initNeon(){
  const canvas = document.getElementById('neonParticles');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  function resize(){ canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
  window.addEventListener('resize', resize); resize();
  const parts = [];
  for(let i=0;i<60;i++) parts.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height, r:1+Math.random()*3, vx:(Math.random()-0.5)*0.25, vy:(Math.random()-0.5)*0.45, hue:200+Math.random()*120, t:Math.random()*1000 });
  function frame(){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    parts.forEach(p=>{
      p.t += 0.01; p.x += p.vx + Math.sin(p.t*0.4)*0.15; p.y += p.vy + Math.cos(p.t*0.3)*0.12;
      if(p.x < -60) p.x = canvas.width + 60; if(p.x > canvas.width+60) p.x = -60;
      if(p.y < -60) p.y = canvas.height + 60; if(p.y > canvas.height+60) p.y = -60;
      const glowR = p.r*6 + Math.abs(Math.sin(p.t))*6;
      const g = ctx.createRadialGradient(p.x,p.y,0,p.x,p.y,glowR);
      g.addColorStop(0, `hsla(${p.hue},100%,65%,0.12)`); g.addColorStop(1, `hsla(${(p.hue+40)%360},80%,55%,0.02)`);
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(p.x,p.y,glowR,0,Math.PI*2); ctx.fill();
      ctx.fillStyle = `hsla(${p.hue},100%,70%,0.9)`; ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill();
    });
    requestAnimationFrame(frame);
  }
  frame();
})();

/* ====== Language (FA/EN) ====== */
let lang = localStorage.getItem('sps_lang') || 'fa';
function setLanguageUI(){
  document.documentElement.setAttribute('dir', lang==='en' ? 'ltr' : 'rtl');
  // update some buttons
  document.getElementById('connectBtn').textContent = (lang==='en' ? 'Connect Wallet' : 'Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„');
  // tabs
  const tabBtns = document.querySelectorAll('.tab-btn');
  if(lang==='fa'){ tabBtns[0].textContent='Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯'; tabBtns[1].textContent='Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…'; tabBtns[2].textContent='Ù…Ø§ÛŒÙ†Ø±'; tabBtns[3].textContent='Ø¹Ù…Ù„ÛŒØ§Øª'; }
  else { tabBtns[0].textContent='Dashboard'; tabBtns[1].textContent='Register'; tabBtns[2].textContent='Miner'; tabBtns[3].textContent='Operations'; }
}
document.getElementById('btn-fa').onclick = ()=>{ lang='fa'; localStorage.setItem('sps_lang','fa'); setLanguageUI(); };
document.getElementById('btn-en').onclick = ()=>{ lang='en'; localStorage.setItem('sps_lang','en'); setLanguageUI(); };
setLanguageUI();

/* ====== CONNECT WALLET ====== */
async function connectWallet(){
  if(typeof window.ethereum === 'undefined'){ alert(lang==='en' ? 'Wallet (MetaMask) not found' : 'Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø«Ù„ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯'); return; }
  try{
    showLoading(true);
    const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
    userAddress = accounts[0];
    // ensure chain
    const chainId = await window.ethereum.request({ method: 'eth_chainId' });
    if(chainId !== POLYGON_CHAIN_ID){
      try{
        await window.ethereum.request({ method:'wallet_switchEthereumChain', params:[{ chainId: POLYGON_CHAIN_ID }] });
      }catch(switchErr){
        if(switchErr.code === 4902){
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{ chainId: POLYGON_CHAIN_ID, chainName: 'Polygon Mainnet', nativeCurrency:{ name:'MATIC', symbol:'MATIC', decimals:18 }, rpcUrls:['https://polygon-rpc.com'], blockExplorerUrls:['https://polygonscan.com'] }]
          });
        } else {
          console.warn('chain switch failed', switchErr);
        }
      }
    }
    provider = new ethers.BrowserProvider(window.ethereum);
    signer = await provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    document.getElementById('connectArea').innerHTML = `<div style="background:linear-gradient(90deg,#10b981,#34d399);color:#021612;padding:8px;border-radius:8px;font-weight:700">âœ… ${userAddress.substring(0,6)}...${userAddress.substring(userAddress.length-4)}</div>`;
    // network status
    document.getElementById('statusDot')?.classList.add('connected');
    document.getElementById('networkStatus').textContent = lang==='en' ? 'Connected' : 'Ù…ØªØµÙ„';
    // load dashboard data
    await loadDashboard();
    // listeners
    window.ethereum.on('accountsChanged', ()=> location.reload());
    window.ethereum.on('chainChanged', ()=> location.reload());
  }catch(err){
    console.error('connect error', err);
    alert(err.message || err);
  }finally{ showLoading(false); }
}
document.getElementById('connectBtn').addEventListener('click', connectWallet);

/* ====== TX HANDLER (wrap tx promises) ====== */
async function handleTx(txPromise, targetId){
  try{
    showLoading(true);
    const tx = await txPromise;
    // show pending in-section if target exists
    if(targetId) showPending(tx.hash, targetId);
    const receipt = await tx.wait();
    if(targetId) showTransactionLink(tx.hash, targetId);
    // confetti+toast
    try{ spawnConfetti(); }catch(e){}
    return receipt;
  }catch(err){
    console.error('Transaction error', err);
    if(targetId){
      const el = document.getElementById(targetId);
      if(el) el.innerHTML = `<div style="color:#ffb3b3">âŒ ${err && err.message ? err.message : err}</div>`;
    } else alert(err && err.message ? err.message : err);
    throw err;
  }finally{ showLoading(false); }
}

/* ====== CORE ACTIONS (register, contribute, buy, distribute) ====== */
async function register(){
  const upline = document.getElementById('uplineCode').value;
  const placeLeft = document.getElementById('position').value === 'true';
  if(!upline){ alert(lang==='en' ? 'Please enter upline code' : 'Ù„Ø·ÙØ§ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  try{
    const txp = contract.register(upline, placeLeft, { value: ENTRY_FEE });
    await handleTx(txp, 'registerResult');
    await loadDashboard();
  }catch(e){}
}

async function contribute(){
  const amt = document.getElementById('contribution').value;
  if(!amt || Number(amt) <= 0){ alert(lang==='en' ? 'Enter valid amount' : 'Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯'); return; }
  try{
    const txp = contract.contributeToMinerPool({ value: ethers.parseEther(String(amt)) });
    await handleTx(txp, 'minerResult');
    await loadDashboard();
  }catch(e){}
}

async function buyTokens(){
  try{
    const txp = contract.buyMinerTokens();
    await handleTx(txp, 'minerResult');
    await loadDashboard();
  }catch(e){}
}

async function distribute(){
  try{
    const txp = contract.distributeMinerTokens();
    await handleTx(txp, 'minerResult');
    await loadDashboard();
  }catch(e){}
}

/* ====== Withdraw functions (with pre-checks) ====== */
async function canWithdrawPool(){
  if(!contract) return { ok:false, reason: lang==='en' ? 'Contract not initialized' : 'Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¢Ù…Ø§Ø¯Ù‡ Ù†ÛŒØ³Øª' };
  try{
    const withdrawable = await contract.isPoolWithdrawable().catch(()=>false);
    if(!withdrawable) return { ok:false, reason: lang==='en' ? 'Pool not withdrawable now' : 'Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§Ù…Ú©Ø§Ù†â€ŒÙ¾Ø°ÛŒØ± Ù†ÛŒØ³Øª' };
    const poolBal = await contract.poolBalance().catch(()=>0);
    if(Number(poolBal) === 0) return { ok:false, reason: lang==='en' ? 'Pool balance is zero' : 'Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø± ØµÙØ± Ø§Ø³Øª' };
    const eligible = await contract.eligiblePoolUserCount().catch(()=>0);
    if(Number(eligible) === 0) return { ok:false, reason: lang==='en' ? 'No eligible users in pool' : 'Ù‡ÛŒÚ† Ú©Ø§Ø±Ø¨Ø± ÙˆØ§Ø¬Ø¯ Ø´Ø±Ø§ÛŒØ·ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯' };
    return { ok:true };
  }catch(e){ console.error('canWithdrawPool', e); return { ok:false, reason: lang==='en' ? 'Pre-check failed' : 'Ø¨Ø±Ø±Ø³ÛŒ Ù¾ÛŒØ´ Ø§Ø² Ø¨Ø±Ø¯Ø§Ø´Øª Ù†Ø§Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯' }; }
}

async function withdrawPool(){
  try{
    const check = await canWithdrawPool();
    if(!check.ok){ showStatus(`â›” ${check.reason}`, 'withdrawActionResult'); return; }
    const txp = contract.withdrawPool();
    await handleTx(txp, 'withdrawActionResult');
    await loadDashboard();
  }catch(e){}
}

async function withdrawSpecial(){
  try{
    const eligible = await contract.eligibleSpecialUserCount().catch(()=>0);
    if(Number(eligible) === 0){ showStatus(lang==='en' ? 'No eligible special rewards' : 'Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…Ø§Ù† Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡â€ŒØ§ÛŒ Ù†ÛŒØ³Øª', 'withdrawActionResult'); return; }
    const txp = contract.withdrawSpecials();
    await handleTx(txp, 'withdrawActionResult');
    await loadDashboard();
  }catch(e){}
}

/* ====== Timers (pool & special) ====== */
let poolTimerInterval = null;
function startPoolTimer(lastWithdrawUnix = 0, cycleDurationSec = 0){
  if(poolTimerInterval) clearInterval(poolTimerInterval);
  function render(){
    const now = Math.floor(Date.now()/1000);
    const nextUnlock = (lastWithdrawUnix && cycleDurationSec) ? lastWithdrawUnix + cycleDurationSec : 0;
    let remaining = nextUnlock > now ? nextUnlock - now : 0;
    const seg = document.getElementById('poolTimerSegments');
    if(!seg) return;
    if(remaining === 0){ seg.innerHTML = `<div style="font-weight:700;color:var(--success)">${lang==='en'?'Withdrawable Now':'Ù‚Ø§Ø¨Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ú©Ù†ÙˆÙ†'}</div>`; document.getElementById('withdrawMainBtn')?.classList.remove('disabled'); }
    else {
      const d = Math.floor(remaining / 86400); remaining %= 86400;
      const h = Math.floor(remaining / 3600); remaining %= 3600;
      const m = Math.floor(remaining / 60); const s = remaining % 60;
      seg.innerHTML = `<div class="time-segment"><div class="time-value">${String(d).padStart(2,'0')}</div><div class="time-label">${lang==='en'?'Days':'Ø±ÙˆØ²'}</div></div>

# truncated to keep message size reasonable in tool exec - full file saved on disk
