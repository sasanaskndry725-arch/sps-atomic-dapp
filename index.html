<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPS DApp - Ù†Ø³Ø®Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡</title>
    
    <!-- Ethers.js Ø§Ø² Cloudflare -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    
    <style>
        /* Reset Ùˆ Ù…ØªØºÛŒØ±Ù‡Ø§ */
        :root {
            --primary: #3b82f6;
            --success: #10b981;
            --warning: #f59e0b;
            --danger: #ef4444;
            --dark-bg: #0f172a;
            --card-bg: rgba(30, 41, 59, 0.6);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: Tahoma, sans-serif;
            color: white;
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
        }
        
        /* Ø²Ù…ÛŒÙ†Ù‡ Ù…ØªØ­Ø±Ú© */
        .bg-animation {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
        }
        
        .particles {
            position: absolute;
            width: 100%;
            height: 100%;
        }
        
        .particle {
            position: absolute;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            border-radius: 50%;
            animation: float 15s infinite linear;
            opacity: 0.1;
        }
        
        @keyframes float {
            0% { transform: translate(0, 0) rotate(0deg); }
            100% { transform: translate(100vw, 100vh) rotate(360deg); }
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 1;
        }
        
        /* Header */
        .header {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            backdrop-filter: blur(10px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo {
            font-size: 28px;
            font-weight: bold;
            background: linear-gradient(90deg, #3b82f6, #8b5cf6);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            text-shadow: 0 0 20px rgba(59, 130, 246, 0.3);
        }
        
        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
            animation: pulse 2s infinite;
        }
        
        .status-dot.connected { background: #10b981; }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        .wallet-btn {
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .wallet-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
        }
        
        /* Tabs */
        .tabs {
            display: flex;
            gap: 10px;
            margin: 20px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding-bottom: 10px;
            flex-wrap: wrap;
        }
        
        .tab-btn {
            background: none;
            border: none;
            color: #94a3b8;
            padding: 12px 24px;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.3s;
        }
        
        .tab-btn:hover {
            background: rgba(59, 130, 246, 0.1);
        }
        
        .tab-btn.active {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }
        
        /* Stats */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-box {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-5px);
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            margin: 10px 0;
            color: #60a5fa;
        }
        
        .stat-label {
            color: #94a3b8;
            font-size: 14px;
        }
        
        /* Tree Structure */
        .tree-container {
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin-top: 20px;
            min-height: 200px;
            overflow-x: auto;
        }
        
        .tree-node {
            padding: 10px;
            background: rgba(30, 41, 59, 0.6);
            border-radius: 8px;
            margin: 5px 0;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        .tree-children {
            margin-right: 30px;
            margin-top: 10px;
            border-right: 2px dashed rgba(59, 130, 246, 0.3);
            padding-right: 15px;
        }
        
        /* Cards */
        .card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .card h3 {
            margin-bottom: 20px;
            color: #e2e8f0;
            border-bottom: 2px solid rgba(59, 130, 246, 0.3);
            padding-bottom: 10px;
        }
        
        /* Forms */
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            color: #cbd5e1;
            font-weight: 500;
        }
        
        .form-input {
            width: 100%;
            padding: 12px;
            background: rgba(15, 23, 42, 0.8);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            color: white;
            transition: border-color 0.3s;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
        }
        
        /* Buttons */
        .btn-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .btn {
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #3b82f6, #6366f1);
            color: white;
        }
        
        .btn-success {
            background: linear-gradient(90deg, #10b981, #34d399);
            color: white;
        }
        
        .btn-warning {
            background: linear-gradient(90deg, #f59e0b, #fbbf24);
            color: white;
        }
        
        .btn-danger {
            background: linear-gradient(90deg, #ef4444, #f87171);
            color: white;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        
        /* Grid */
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .tabs {
                justify-content: center;
            }
        }
        
        /* Status Messages */
        .status {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
        }
        
        .status.success {
            background: rgba(34, 197, 94, 0.2);
            color: #4ade80;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }
        
        .status.error {
            background: rgba(239, 68, 68, 0.2);
            color: #f87171;
            border: 1px solid rgba(239, 68, 68, 0.3);
        }
        
        .status.info {
            background: rgba(59, 130, 246, 0.2);
            color: #60a5fa;
            border: 1px solid rgba(59, 130, 246, 0.3);
        }
        
        /* Transaction Link */
        .tx-link {
            display: inline-block;
            margin-top: 10px;
            padding: 8px 15px;
            background: rgba(59, 130, 246, 0.1);
            border-radius: 6px;
            color: #60a5fa;
            text-decoration: none;
            transition: all 0.3s;
        }
        
        .tx-link:hover {
            background: rgba(59, 130, 246, 0.2);
            transform: translateX(-5px);
        }
        
        /* Loading */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
        }
        
        .spinner {
            border: 4px solid rgba(255, 255, 255, 0.1);
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* Footer */
        .footer {
            text-align: center;
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            color: #94a3b8;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Ø²Ù…ÛŒÙ†Ù‡ Ù…ØªØ­Ø±Ú© -->
    <div class="bg-animation">
        <div class="particles" id="particles"></div>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <div class="logo-section">
                <div class="logo">SPS</div>
                <div class="status-indicator">
                    <div class="status-dot" id="statusDot"></div>
                    <span id="networkStatus">Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡</span>
                </div>
            </div>
            
            <button class="wallet-btn" id="connectBtn">Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„</button>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <button class="tab-btn active" onclick="showTab('dashboard')">Ø¯Ø§Ø´Ø¨ÙˆØ±Ø¯</button>
            <button class="tab-btn" onclick="showTab('register')">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</button>
            <button class="tab-btn" onclick="showTab('miner')">Ù…Ø§ÛŒÙ†Ø±</button>
            <button class="tab-btn" onclick="showTab('actions')">Ø¹Ù…Ù„ÛŒØ§Øª</button>
            <button class="tab-btn" onclick="showTab('admin')" id="adminTab" style="display:none">Ù…Ø¯ÛŒØ±ÛŒØª</button>
        </div>
        
        <!-- Dashboard Tab -->
        <div id="dashboardTab">
            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ø³ØªØ®Ø±</div>
                    <div class="stat-value" id="poolBalance">0 MATIC</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Ø§Ø³ØªØ®Ø± Ù…Ø§ÛŒÙ†Ø±</div>
                    <div class="stat-value" id="minerPool">0 MATIC</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</div>
                    <div class="stat-value" id="specialPool">0 MATIC</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Ú©Ø§Ø±Ù…Ø²Ø¯ ÙˆØ±ÙˆØ¯</div>
                    <div class="stat-value" id="entryFeeDisplay">0 MATIC</div>
                </div>
            </div>
            
            <div class="grid-2">
                <div class="card">
                    <h3>ğŸ‘¤ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±ÛŒ</h3>
                    <div id="userInfo" class="status info">
                        Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª
                    </div>
                </div>
                
                <div class="card">
                    <h3>ğŸŒ³ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ Ø´Ù…Ø§</h3>
                    <div class="tree-container" id="treeContainer">
                        <div class="tree-node">
                            <strong>ğŸ”„ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯</strong>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Register Tab -->
        <div id="registerTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>ğŸ“ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¬Ø¯ÛŒØ¯</h3>
                    <div class="form-group">
                        <label class="form-label">Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ†</label>
                        <input type="number" id="uplineCode" class="form-input" placeholder="1">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ù…ÙˆÙ‚Ø¹ÛŒØª</label>
                        <select id="position" class="form-input">
                            <option value="true">Ú†Ù¾</option>
                            <option value="false">Ø±Ø§Ø³Øª</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="register()">Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… (300 MATIC)</button>
                    <div id="registerResult"></div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…</h3>
                    <div id="registerInfo" class="status info">
                        Ù¾Ø³ Ø§Ø² Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ØŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Miner Tab -->
        <div id="minerTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>â›ï¸ Ø¹Ù…Ù„ÛŒØ§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
                    <div class="form-group">
                        <label class="form-label">Ù…Ù‚Ø¯Ø§Ø± Ù…Ø´Ø§Ø±Ú©Øª (MATIC)</label>
                        <input type="text" id="contribution" class="form-input" placeholder="0.1">
                    </div>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="contribute()">Ù…Ø´Ø§Ø±Ú©Øª</button>
                        <button class="btn btn-warning" onclick="buyTokens()">Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†</button>
                        <button class="btn btn-primary" onclick="sellTokens()">ÙØ±ÙˆØ´ ØªÙˆÚ©Ù†</button>
                        <button class="btn btn-success" onclick="distribute()">ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§</button>
                    </div>
                    <div id="minerResult"></div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“Š Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø±</h3>
                    <div id="minerInfo" class="status info">
                        Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ø§ÛŒÙ†Ø± Ø´Ù…Ø§
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Actions Tab -->
        <div id="actionsTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>ğŸ’¸ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±Ù‡Ø§</h3>
                    <div class="btn-group">
                        <button class="btn btn-success" onclick="withdrawPool()">Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø± Ø§ØµÙ„ÛŒ</button>
                        <button class="btn btn-primary" onclick="withdrawSpecial()">Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡</button>
                    </div>
                    <div id="withdrawResult"></div>
                </div>
                
                <div class="card">
                    <h3>ğŸ“ˆ ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øª</h3>
                    <div id="withdrawInfo" class="status info">
                        ÙˆØ¶Ø¹ÛŒØª Ø¨Ø±Ø¯Ø§Ø´Øªâ€ŒÙ‡Ø§ÛŒ Ø´Ù…Ø§
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Admin Tab -->
        <div id="adminTab" style="display:none">
            <div class="grid-2">
                <div class="card">
                    <h3>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯</h3>
                    <div class="form-group">
                        <label class="form-label">Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ (wei)</label>
                        <input type="number" id="newFee" class="form-input" placeholder="300000000000000000000">
                    </div>
                    <button class="btn btn-danger" onclick="updateFee()">Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯</button>
                    <div id="adminResult"></div>
                </div>
                
                <div class="card">
                    <h3>ğŸš« Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</h3>
                    <div class="form-group">
                        <label class="form-label">Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù (Ø¨Ø§ Ú©Ø§Ù…Ø§ Ø¬Ø¯Ø§)</label>
                        <textarea id="addresses" class="form-input" rows="4" placeholder="0x123...,0x456..."></textarea>
                    </div>
                    <button class="btn btn-danger" onclick="removeMiners()">Ø­Ø°Ù Ù…Ø§ÛŒÙ†Ø±Ù‡Ø§</button>
                </div>
            </div>
        </div>
        
        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
        </div>
        
        <!-- Footer -->
        <div class="footer">
            SPS Network â€¢ Ø¢Ø¯Ø±Ø³ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: 0x7a7b06D49129B34976D07B3854d4D72D01588191 â€¢ Polygon Mainnet
        </div>
    </div>

    <script>
        // ==================== ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø§ØµÙ„ÛŒ ====================
        const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
        const POLYGON_CHAIN_ID = "0x89";
        const ENTRY_FEE = "300000000000000000000"; // 300 MATIC
        
        // ABI Ú©Ø§Ù…Ù„ Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ (Ù‡Ù…Ø§Ù† Ù†Ø³Ø®Ù‡ Ù‚Ø¨Ù„ÛŒ)
        const CONTRACT_ABI = [
            {"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},
            {"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},
            {"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}
        ];
        
        // Ù…ØªØºÛŒØ±Ù‡Ø§ÛŒ Ø§ØµÙ„ÛŒ
        let provider, signer, contract, userAddress, isOwner = false;
        let userTreeData = {};
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ú©Ù…Ú©ÛŒ ====================
        function showStatus(message, type = 'info', targetId = 'userInfo') {
            const el = document.getElementById(targetId);
            el.className = `status ${type}`;
            el.innerHTML = message;
            console.log(`[${type.toUpperCase()}] ${message.replace(/<[^>]*>/g, '')}`);
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'flex' : 'none';
        }
        
        function showTab(tabName) {
            const tabs = ['dashboard', 'register', 'miner', 'actions', 'admin'];
            tabs.forEach(id => {
                document.getElementById(id + 'Tab').style.display = 'none';
            });
            
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            document.getElementById(tabName + 'Tab').style.display = 'block';
            event.target.classList.add('active');
            
            if (tabName === 'dashboard') {
                loadDashboard();
            }
        }
        
        function createParticles() {
            const particles = document.getElementById('particles');
            for (let i = 0; i < 50; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 10 + 5}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.animationDelay = `${Math.random() * 20}s`;
                particle.style.animationDuration = `${Math.random() * 10 + 20}s`;
                particles.appendChild(particle);
            }
        }
        
        function updateNetworkStatus(connected) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('networkStatus');
            
            if (connected) {
                dot.className = 'status-dot connected';
                text.textContent = 'Polygon Mainnet';
            } else {
                dot.className = 'status-dot';
                text.textContent = 'Ø§ØªØµØ§Ù„ Ø´Ø¨Ú©Ù‡';
            }
        }
        
        function showTransactionLink(txHash, targetId) {
            const link = `https://polygonscan.com/tx/${txHash}`;
            const html = `
                <div class="status success">
                    âœ… ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯
                    <a href="${link}" target="_blank" class="tx-link">
                        ğŸ” Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø± Polygonscan
                    </a>
                </div>
            `;
            document.getElementById(targetId).innerHTML = html;
        }
        
        // ==================== Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ ====================
        async function loadTreeStructure(userId) {
            try {
                const container = document.getElementById('treeContainer');
                container.innerHTML = '<div class="tree-node">ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</div>';
                
                const userInfo = await contract.getUserInfo(userAddress);
                const [leftId, rightId] = await contract.getUserDirects(userId);
                
                let treeHtml = `
                    <div class="tree-node">
                        <strong>ğŸ‘¤ Ø´Ù…Ø§ (ID: ${userId})</strong><br>
                        ğŸ“Š Ú†Ù¾: ${userInfo[2]} | Ø±Ø§Ø³Øª: ${userInfo[3]}
                    </div>
                    <div class="tree-children">
                `;
                
                if (leftId > 0 || rightId > 0) {
                    if (leftId > 0) {
                        treeHtml += `<div class="tree-node">â† Ú†Ù¾: ID ${leftId}</div>`;
                    }
                    if (rightId > 0) {
                        treeHtml += `<div class="tree-node">â†’ Ø±Ø§Ø³Øª: ID ${rightId}</div>`;
                    }
                } else {
                    treeHtml += `<div class="tree-node">ğŸ“­ Ù‡ÛŒÚ† Ø²ÛŒØ±Ù…Ø¬Ù…ÙˆØ¹Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</div>`;
                }
                
                treeHtml += '</div>';
                container.innerHTML = treeHtml;
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ:', error);
                document.getElementById('treeContainer').innerHTML = 
                    '<div class="tree-node">âš ï¸ Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø±</div>';
            }
        }
        
        // ==================== ÙØ±ÙˆØ´ ØªÙˆÚ©Ù† ====================
        async function sellTokens() {
            if (!contract) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ù¾Ø±Ø¯Ø§Ø²Ø´ ÙØ±ÙˆØ´ ØªÙˆÚ©Ù†...', 'info', 'minerResult');
                
                // NOTE: Ø§ÛŒÙ† ØªØ§Ø¨Ø¹ Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯
                // Ø¨Ø±Ø§ÛŒ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† ØªØ§Ø¨Ø¹ sellMinerTokens Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ Ø¯Ø§Ø±ÛŒØ¯
                // const tx = await contract.sellMinerTokens();
                
                // ÙØ¹Ù„Ø§Ù‹ Ù¾ÛŒØ§Ù… Ø´Ø¨ÛŒÙ‡â€ŒØ³Ø§Ø²ÛŒ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
                await new Promise(resolve => setTimeout(resolve, 2000));
                showStatus(`
                    âš ï¸ ØªØ§Ø¨Ø¹ ÙØ±ÙˆØ´ ØªÙˆÚ©Ù† Ø¯Ø± Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯ ÙØ¹Ù„ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛŒØ³Øª<br>
                    Ù†ÛŒØ§Ø² Ø¨Ù‡ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯Ù† ØªØ§Ø¨Ø¹ sellMinerTokens Ø¯Ø± Smart Contract
                `, 'warning', 'minerResult');
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'minerResult');
            } finally {
                showLoading(false);
            }
        }
        
        // ==================== Ø§ØªØµØ§Ù„ Ú©ÛŒÙ Ù¾ÙˆÙ„ ====================
        async function connectWallet() {
            if (typeof window.ethereum === 'undefined') {
                showStatus('âŒ Ú©ÛŒÙ Ù¾ÙˆÙ„ (Ù…Ø«Ù„ MetaMask) ÛŒØ§ÙØª Ù†Ø´Ø¯', 'error');
                return;
            }
            
            try {
                showLoading(true);
                showStatus('ğŸ”— Ø¯Ø± Ø­Ø§Ù„ Ø§ØªØµØ§Ù„...', 'info');
                
                const accounts = await window.ethereum.request({
                    method: 'eth_requestAccounts'
                });
                
                userAddress = accounts[0];
                updateNetworkStatus(false);
                
                // Ø¨Ø±Ø±Ø³ÛŒ Ø´Ø¨Ú©Ù‡
                const chainId = await window.ethereum.request({ method: 'eth_chainId' });
                
                if (chainId !== POLYGON_CHAIN_ID) {
                    showStatus('ğŸ”„ ØªØºÛŒÛŒØ± Ø¨Ù‡ Ø´Ø¨Ú©Ù‡ Polygon...', 'info');
                    
                    try {
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: POLYGON_CHAIN_ID }],
                        });
                    } catch (switchError) {
                        if (switchError.code === 4902) {
                            await window.ethereum.request({
                                method: 'wallet_addEthereumChain',
                                params: [{
                                    chainId: POLYGON_CHAIN_ID,
                                    chainName: 'Polygon Mainnet',
                                    nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
                                    rpcUrls: ['https://polygon-rpc.com'],
                                    blockExplorerUrls: ['https://polygonscan.com']
                                }],
                            });
                        }
                    }
                    
                    await new Promise(resolve => setTimeout(resolve, 1500));
                }
                
                // Ø§ØªØµØ§Ù„
                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();
                contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
                
                // Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ UI
                document.getElementById('connectBtn').outerHTML = `
                    <div style="background: linear-gradient(90deg, #10b981, #34d399); color: white; padding: 12px 24px; border-radius: 8px; font-weight: bold;">
                        âœ… ${userAddress.substring(0, 6)}...${userAddress.substring(38)}
                    </div>
                `;
                
                updateNetworkStatus(true);
                await loadDashboard();
                showStatus('âœ… Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯', 'success');
                
                // Ú¯ÙˆØ´ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ ØªØºÛŒÛŒØ±Ø§Øª
                window.ethereum.on('accountsChanged', () => location.reload());
                window.ethereum.on('chainChanged', () => location.reload());
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error');
            } finally {
                showLoading(false);
            }
        }
        
        // ==================== Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª ====================
        async function loadDashboard() {
            if (!contract) return;
            
            try {
                // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ
                const [poolBalance, minerPool, specialPool, entryFee] = await Promise.all([
                    contract.poolBalance().catch(() => 0),
                    contract.minerTokenPool().catch(() => 0),
                    contract.specialRewardPool().catch(() => 0),
                    contract.ENTRY_FEE().catch(() => ENTRY_FEE)
                ]);
                
                document.getElementById('poolBalance').textContent = 
                    ethers.formatEther(poolBalance).substring(0, 10) + ' MATIC';
                document.getElementById('minerPool').textContent = 
                    ethers.formatEther(minerPool).substring(0, 10) + ' MATIC';
                document.getElementById('specialPool').textContent = 
                    ethers.formatEther(specialPool).substring(0, 10) + ' MATIC';
                document.getElementById('entryFeeDisplay').textContent = 
                    ethers.formatEther(entryFee) + ' MATIC';
                
                // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±
                const userInfo = await contract.getUserInfo(userAddress).catch(() => null);
                if (userInfo) {
                    const userId = userInfo[0];
                    showStatus(`
                        <strong>ğŸ‘¤ Ú©Ø§Ø±Ø¨Ø± #${userId}</strong><br>
                        ğŸ“Š Ù…ÙˆØ¬ÙˆØ¯ÛŒ: ${userInfo[6]} ÙˆØ§Ø­Ø¯<br>
                        ğŸ Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡: ${userInfo[7]}<br>
                        â›ï¸ Ù…Ø§ÛŒÙ†Ø±: ${userInfo[10] ? 'âœ…' : 'âŒ'}<br>
                        ğŸ’° Ù…Ø¬Ù…ÙˆØ¹ Ù¾Ø§Ø¯Ø§Ø´â€ŒÙ‡Ø§: ${ethers.formatEther(userInfo[8])} MATIC
                    `, 'success');
                    
                    // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³Ø§Ø®ØªØ§Ø± Ø¯Ø±Ø®ØªÛŒ
                    await loadTreeStructure(userId);
                    
                    // Ø¨Ø±Ø±Ø³ÛŒ Ù…Ø§Ù„Ú© Ø¨ÙˆØ¯Ù†
                    const owner = await contract.owner().catch(() => null);
                    if (owner && owner.toLowerCase() === userAddress.toLowerCase()) {
                        isOwner = true;
                        document.getElementById('adminTab').style.display = 'block';
                    }
                }
                
            } catch (error) {
                console.error('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ:', error);
            }
        }
        
        // ==================== ØªÙˆØ§Ø¨Ø¹ Ø§ØµÙ„ÛŒ ====================
        
        async function register() {
            const uplineCode = document.getElementById('uplineCode').value;
            const position = document.getElementById('position').value === 'true';
            
            if (!uplineCode) {
                alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø¢Ù¾Ù„Ø§ÛŒÙ† Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...', 'info', 'registerResult');
                
                const tx = await contract.register(uplineCode, position, {
                    value: ENTRY_FEE
                });
                
                showTransactionLink(tx.hash, 'registerResult');
                
                const receipt = await tx.wait();
                showStatus(`
                    âœ… Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚<br>
                    ğŸ‰ Ú©Ø§Ø±Ø¨Ø± Ø¬Ø¯ÛŒØ¯ Ø§ÛŒØ¬Ø§Ø¯ Ø´Ø¯<br>
                    ğŸ”— <a href="https://polygonscan.com/tx/${tx.hash}" target="_blank" class="tx-link">Ù…Ø´Ø§Ù‡Ø¯Ù‡ ØªØ±Ø§Ú©Ù†Ø´</a>
                `, 'success', 'registerResult');
                
                await loadDashboard();
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'registerResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function contribute() {
            const amount = document.getElementById('contribution').value;
            if (!amount || amount <= 0) {
                alert('Ù„Ø·ÙØ§Ù‹ Ù…Ù‚Ø¯Ø§Ø± Ù…Ø¹ØªØ¨Ø± ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ Ù…Ø´Ø§Ø±Ú©Øª...', 'info', 'minerResult');
                
                const tx = await contract.contributeToMinerPool({
                    value: ethers.parseEther(amount)
                });
                
                showTransactionLink(tx.hash, 'minerResult');
                await tx.wait();
                showStatus('âœ… Ù…Ø´Ø§Ø±Ú©Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'minerResult');
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'minerResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function buyTokens() {
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù†...', 'info', 'minerResult');
                
                const tx = await contract.buyMinerTokens();
                showTransactionLink(tx.hash, 'minerResult');
                
                await tx.wait();
                showStatus('âœ… Ø®Ø±ÛŒØ¯ ØªÙˆÚ©Ù† Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'minerResult');
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'minerResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function distribute() {
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§...', 'info', 'minerResult');
                
                const tx = await contract.distributeMinerTokens();
                showTransactionLink(tx.hash, 'minerResult');
                
                await tx.wait();
                showStatus('âœ… ØªÙˆØ²ÛŒØ¹ ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'minerResult');
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'minerResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function withdrawPool() {
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ø§Ø² Ø§Ø³ØªØ®Ø±...', 'info', 'withdrawResult');
                
                const tx = await contract.withdrawPool();
                showTransactionLink(tx.hash, 'withdrawResult');
                
                await tx.wait();
                showStatus('âœ… Ø¨Ø±Ø¯Ø§Ø´Øª Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯', 'success', 'withdrawResult');
                await loadDashboard();
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'withdrawResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function withdrawSpecial() {
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±Ø¯Ø§Ø´Øª Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡...', 'info', 'withdrawResult');
                
                const tx = await contract.withdrawSpecials();
                showTransactionLink(tx.hash, 'withdrawResult');
                
                await tx.wait();
                showStatus('âœ… Ù¾Ø§Ø¯Ø§Ø´ ÙˆÛŒÚ˜Ù‡ Ø¨Ø±Ø¯Ø§Ø´Øª Ø´Ø¯', 'success', 'withdrawResult');
                await loadDashboard();
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'withdrawResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function updateFee() {
            if (!isOwner) {
                alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯: ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯');
                return;
            }
            
            const newFee = document.getElementById('newFee').value;
            if (!newFee) {
                alert('Ù„Ø·ÙØ§Ù‹ Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¬Ø¯ÛŒØ¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            try {
                showLoading(true);
                showStatus('ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ú©Ø§Ø±Ù…Ø²Ø¯...', 'info', 'adminResult');
                
                const tx = await contract.updateEntryFee(newFee);
                showTransactionLink(tx.hash, 'adminResult');
                
                await tx.wait();
                showStatus('âœ… Ú©Ø§Ø±Ù…Ø²Ø¯ Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯', 'success', 'adminResult');
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'adminResult');
            } finally {
                showLoading(false);
            }
        }
        
        async function removeMiners() {
            if (!isOwner) {
                alert('âŒ Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø¯ Ø´Ø¯: ÙÙ‚Ø· Ù…Ø§Ù„Ú© Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯');
                return;
            }
            
            const addressesText = document.getElementById('addresses').value;
            if (!addressesText) {
                alert('Ù„Ø·ÙØ§Ù‹ Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯');
                return;
            }
            
            const addresses = addressesText.split(',').map(a => a.trim()).filter(a => ethers.isAddress(a));
            if (addresses.length === 0) {
                alert('Ù‡ÛŒÚ† Ø¢Ø¯Ø±Ø³ Ù…Ø¹ØªØ¨Ø±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯');
                return;
            }
            
            try {
                showLoading(true);
                showStatus(`ğŸ”„ Ø¯Ø± Ø­Ø§Ù„ Ø­Ø°Ù ${addresses.length} Ù…Ø§ÛŒÙ†Ø±...`, 'info', 'adminResult');
                
                const tx = await contract.batchRemoveMiners(addresses);
                showTransactionLink(tx.hash, 'adminResult');
                
                await tx.wait();
                showStatus(`âœ… ${addresses.length} Ù…Ø§ÛŒÙ†Ø± Ø­Ø°Ù Ø´Ø¯Ù†Ø¯`, 'success', 'adminResult');
                
            } catch (error) {
                showStatus(`âŒ Ø®Ø·Ø§: ${error.message}`, 'error', 'adminResult');
            } finally {
                showLoading(false);
            }
        }
        
        // ==================== Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ ====================
        window.onload = function() {
            console.log('ğŸš€ SPS DApp Ù†Ø³Ø®Ù‡ Ø¨Ù‡Ø¨ÙˆØ¯ ÛŒØ§ÙØªÙ‡ Ø±Ø§Ù‡â€ŒØ§Ù†Ø¯Ø§Ø²ÛŒ Ø´Ø¯');
            
            // Ø§ÛŒØ¬Ø§Ø¯ Ø²Ù…ÛŒÙ†Ù‡ Ù…ØªØ­Ø±Ú©
            createParticles();
            
            // Ø§ØªØµØ§Ù„ Ø¯Ú©Ù…Ù‡
            document.getElementById('connectBtn').onclick = connectWallet;
            
            // ØªÙ†Ø¸ÛŒÙ… ØªØ¨ Ù…Ø§ÛŒÙ†Ø±
            const minerTabBtn = document.querySelector('.tab-btn[onclick*="miner"]');
            if (minerTabBtn) {
                minerTabBtn.onclick = function() { showTab('miner'); };
            }
            
            // Ø¨Ø±Ø±Ø³ÛŒ Ø§ØªØµØ§Ù„ Ø®ÙˆØ¯Ú©Ø§Ø±
            if (typeof window.ethereum !== 'undefined') {
                window.ethereum.request({ method: 'eth_accounts' })
                    .then(accounts => {
                        if (accounts.length > 0) {
                            setTimeout(() => connectWallet(), 1000);
                        }
                    });
            }
            
            // Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ Ø§Ø·Ù„Ø§Ø¹Ø§Øª
            setTimeout(() => {
                if (!provider) loadDashboard();
            }, 500);
        };
    </script>
</body>
</html>