<!DOCTYPE html>
<html lang="fa">
<head>
<meta charset="UTF-8" />
<title>SP Smart DApp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>

<style>
    body {
        margin: 0;
        background: radial-gradient(circle at top, #1a0033, #000);
        font-family: 'Segoe UI', sans-serif;
        color: #fff;
    }

    h1 {
        text-align: center;
        padding: 25px 0;
        font-size: 32px;
        letter-spacing: 2px;
        background: linear-gradient(90deg,#a700ff,#00ccff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    .container {
        width: 92%;
        max-width: 950px;
        margin: auto;
        padding-bottom: 60px;
    }

    .card {
        background: rgba(255,255,255,0.06);
        border: 1px solid rgba(255,255,255,0.1);
        padding: 20px;
        border-radius: 16px;
        margin-top: 20px;
        backdrop-filter: blur(10px);
        transition: 0.3s;
    }

    .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 0 25px #8a2be2aa;
    }

    .card h2 {
        margin-bottom: 15px;
        background: linear-gradient(90deg,#ff00f2,#00e1ff);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
    }

    input {
        width: 90%;
        padding: 10px;
        border-radius: 10px;
        border: 1px solid #555;
        background: rgba(255,255,255,0.1);
        color: #fff;
        margin-bottom: 10px;
    }

    button {
        width: 100%;
        padding: 12px;
        border: none;
        border-radius: 12px;
        font-size: 16px;
        cursor: pointer;
        margin-top: 8px;
        background: linear-gradient(45deg,#8a2be2,#00d2ff);
        color: #fff;
        transition: 0.25s;
        font-weight: bold;
    }

    button:hover {
        transform: scale(1.04);
        box-shadow: 0 0 18px #6f00ffa8;
    }

    .result-box {
        background: rgba(0,0,0,0.45);
        padding: 12px;
        border-radius: 12px;
        margin-top: 12px;
        border: 1px solid #444;
        overflow-wrap: break-word;
    }
</style>
</head>
<body>

<h1>SP SMART • DAPP</h1>
<div class="container">

<!-- CONNECT -->
<div class="card">
    <h2>اتصال کیف پول</h2>
    <button onclick="connectWallet()">اتصال به ولت</button>
    <div id="walletAddress" class="result-box"></div>
</div>

<!-- USER INFO -->
<div class="card">
    <h2>۲. دریافت اطلاعات کاربر</h2>
    <input id="userAddress" placeholder="آدرس کاربر را وارد کنید">
    <button onclick="getUserInfo()">نمایش اطلاعات</button>
    <div id="userInfo" class="result-box"></div>
</div>

<!-- REGISTER -->
<div class="card">
    <h2>۳. ثبت نام (300 MATIC)</h2>
    <input id="refAddr" placeholder="آدرس معرف (اجباری)">
    <button onclick="registerUser()">ثبت نام</button>
    <div id="regResult" class="result-box"></div>
</div>

<!-- MINER STATS -->
<div class="card">
    <h2>۴. دریافت اطلاعات ماینر</h2>
    <input id="minerAddr" placeholder="آدرس کاربر">
    <button onclick="getMiner()">دریافت اطلاعات ماینر</button>
    <div id="minerInfo" class="result-box"></div>
</div>

<!-- BUY TOKENS -->
<div class="card">
    <h2>۵. خرید Miner Tokens</h2>
    <input id="amountBuy" placeholder="تعداد">
    <button onclick="buyTokens()">خرید</button>
    <div id="buyResult" class="result-box"></div>
</div>

<!-- WITHDRAW -->
<div class="card">
    <h2>۶. برداشت Pool</h2>
    <button onclick="withdrawPool()">برداشت</button>
    <div id="withdrawResult" class="result-box"></div>
</div>

</div>

<script>
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";

const ABI = [
    {
        "inputs":[{"internalType":"address","name":"_ref","type":"address"}],
        "name":"registerUser",
        "outputs":[],
        "stateMutability":"payable",
        "type":"function"
    },
    {
        "inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],
        "name":"buyMinerTokens",
        "outputs":[],
        "stateMutability":"payable",
        "type":"function"
    },
    {"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},
    {
        "inputs":[{"internalType":"address","name":"_user","type":"address"}],
        "name":"getUser",
        "outputs":[
            {"internalType":"bool","name":"isRegistered","type":"bool"},
            {"internalType":"address","name":"referrer","type":"address"},
            {"internalType":"uint256","name":"team","type":"uint256"},
            {"internalType":"uint256","name":"Direct","type":"uint256"},
            {"internalType":"uint256","name":"invested","type":"uint256"},
            {"internalType":"uint256","name":"withdrawn","type":"uint256"}
        ],
        "stateMutability":"view",
        "type":"function"
    },
    {
        "inputs":[{"internalType":"address","name":"_user","type":"address"}],
        "name":"minerInfo",
        "outputs":[
            {"internalType":"uint256","name":"power","type":"uint256"},
            {"internalType":"uint256","name":"profit","type":"uint256"},
            {"internalType":"uint256","name":"refProfit","type":"uint256"}
        ],
        "stateMutability":"view",
        "type":"function"
    }
];

let provider, signer, contract;

async function connectWallet() {
    if (!window.ethereum) return alert("کیف پول شناسایی نشد!");

    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send("eth_requestAccounts", []);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, ABI, signer);

    document.getElementById("walletAddress").innerHTML =
        "Connected: " + await signer.getAddress();
}

/* USER INFO */
async function getUserInfo() {
    try {
        const addr = document.getElementById("userAddress").value;
        let r = await contract.getUser(addr);
        document.getElementById("userInfo").innerHTML = JSON.stringify(r, null, 2);
    } catch (e) { alert(e.message); }
}

/* REGISTER */
async function registerUser() {
    try {
        const ref = document.getElementById("refAddr").value;
        const tx = await contract.registerUser(ref, { value: ethers.utils.parseEther("300") });
        document.getElementById("regResult").innerHTML = "TX: " + tx.hash;
    } catch (e) { alert(e.message); }
}

/* MINER INFO */
async function getMiner() {
    try {
        const addr = document.getElementById("minerAddr").value;
        let r = await contract.minerInfo(addr);
        document.getElementById("minerInfo").innerHTML = JSON.stringify(r, null, 2);
    } catch (e) { alert(e.message); }
}

/* BUY TOKENS */
async function buyTokens() {
    try {
        const amt = document.getElementById("amountBuy").value;
        const tx = await contract.buyMinerTokens(amt, { value: ethers.utils.parseEther("1") });
        document.getElementById("buyResult").innerHTML = "TX: " + tx.hash;
    } catch (e) { alert(e.message); }
}

/* WITHDRAW */
async function withdrawPool() {
    try {
        const tx = await contract.withdrawPool();
        document.getElementById("withdrawResult").innerHTML = "TX: " + tx.hash;
    } catch (e) { alert(e.message); }
}
</script>

</body>
</html>
