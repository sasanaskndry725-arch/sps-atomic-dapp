<!doctype html>
<html lang="fa" dir="rtl">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>SPS Ultra-Pro â€” Single File DApp</title>

  <!-- Ethers v5 + Web3Modal + WalletConnect -->
  <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
  <script src="https://unpkg.com/web3modal@1.9.8/dist/index.js"></script>
  <script src="https://unpkg.com/@walletconnect/web3-provider@1.8.0/dist/umd/index.min.js"></script>

  <style>
    :root{
      --bg:#041022; --card:#0e1724; --accent:#7c3aed; --muted:#9fb0c8;
      --glass: rgba(255,255,255,0.04);
    }
    html,body{height:100%;margin:0;font-family: Vazirmatn, system-ui, Arial; background:linear-gradient(180deg,#010713 0%,#041022 100%); color:#e6eef8}
    .wrap{max-width:1100px;margin:18px auto;padding:18px;position:relative}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border-radius:14px;padding:18px;box-shadow:0 10px 40px rgba(0,0,0,0.6)}
    .header{display:flex;justify-content:space-between;align-items:center;gap:12px;flex-wrap:wrap}
    .logo{display:flex;align-items:center;gap:12px}
    .logo-badge{width:54px;height:54px;border-radius:12px;background:linear-gradient(135deg,#7c3aed,#00d4ff);display:flex;align-items:center;justify-content:center;font-weight:900;color:#fff;font-family:Orbitron}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .row{display:flex;gap:10px;align-items:center;margin-top:12px;flex-wrap:wrap}
    input,select,button,pre{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:#031426;color:#e6eef8}
    button{background:linear-gradient(90deg,#00eaff,#7c3aed);border:none;color:#001; padding:12px 14px;border-radius:10px;cursor:pointer;font-weight:700}
    button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);font-weight:600}
    .grid{display:grid;grid-template-columns:1fr 420px;gap:14px;margin-top:16px}
    .panel{padding:12px;border-radius:10px;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.02));min-height:120px}
    #treeView{height:360px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.015));overflow:auto;padding:10px}
    pre{white-space:pre-wrap;overflow:auto;font-size:13px}
    .status{padding:8px;border-radius:8px;margin-top:10px}
    .ok{background:rgba(16,185,129,0.08);color:#10b981}
    .err{background:rgba(239,68,68,0.06);color:#ef4444}
    footer{margin-top:16px;color:var(--muted);font-size:13px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="header">
        <div class="logo">
          <div class="logo-badge">SPS</div>
          <div>
            <h1>SPS â€” Ultra Pro DApp</h1>
            <div class="muted">Ù‚Ø±Ø§Ø±Ø¯Ø§Ø¯: <a id="contractLink" class="muted" target="_blank" rel="noreferrer">0x7a7b06D49129B34976D07B3854d4D72D01588191</a></div>
          </div>
        </div>

        <div style="min-width:300px;text-align:left">
          <div id="walletShort" class="muted">Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡</strong></div>
          <div style="display:flex;gap:8px;margin-top:8px;justify-content:flex-end">
            <button id="connectBtn">ğŸ”— Ø§ØªØµØ§Ù„</button>
            <button id="wcBtn" class="secondary">ğŸ“± WalletConnect</button>
            <button id="disconnectBtn" class="secondary" style="display:none">Ù‚Ø·Ø¹ Ø§ØªØµØ§Ù„</button>
          </div>
        </div>
      </div>

      <div class="grid">
        <div>
          <div class="panel">
            <h3>Ø¹Ù…Ù„ÛŒØ§Øª Ø­ÛŒØ§ØªÛŒ</h3>

            <div class="row">
              <button id="registerBtn">ğŸš€ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… â€” Ø§Ø±Ø³Ø§Ù„ 300 MATIC</button>
              <button id="buyMinerBtn" class="secondary">ğŸ’  buyMinerTokens()</button>
            </div>

            <div class="row">
              <button id="withdrawPoolBtn">ğŸ’¸ withdrawPool()</button>
              <button id="withdrawSpecialsBtn" class="secondary">ğŸ† withdrawSpecials()</button>
            </div>

            <div style="margin-top:12px">
              <h4>Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: Ø§Ø·Ù„Ø§Ø¹Ø§Øª</h4>
              <div class="row">
                <input id="uplineInput" placeholder="Upline code (Ø¹Ø¯Ø¯) ÛŒØ§ Ø¢Ø¯Ø±Ø³ (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)" style="flex:1"/>
                <select id="placeSide"><option value="true">Ú†Ù¾</option><option value="false">Ø±Ø§Ø³Øª</option></select>
              </div>
              <div id="feeInfo" class="muted" style="margin-top:8px">ENTRY_FEE: â€”</div>
            </div>

          </div>

          <div class="panel" style="margin-top:12px">
            <h3>Ø¬Ø³ØªØ¬Ùˆ Ùˆ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ø§Ø±Ø¨Ø±</h3>
            <div class="row">
              <input id="lookupAddress" placeholder="Ø¢Ø¯Ø±Ø³ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ (Ø®Ø§Ù„ÛŒ = Ú©ÛŒÙ Ø´Ù…Ø§)"/>
              <button id="getUserBtn" class="secondary">ğŸ” Ø¯Ø±ÛŒØ§ÙØª getUserInfo</button>
            </div>
            <pre id="resultBox">Ù†ØªØ§ÛŒØ¬ Ø§ÛŒÙ†Ø¬Ø§ Ù†Ù…Ø§ÛŒØ´ Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯...</pre>
          </div>

        </div>

        <div>
          <div class="panel">
            <h3>Ø¯Ø±Ø®Øª Ø´Ø¨Ú©Ù‡ (Tree View)</h3>
            <div class="muted">Ø¨Ø±Ø§ÛŒ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ ÙˆØµÙ„ Ú©Ù† Ùˆ Ø³Ù¾Ø³ Ø¯Ú©Ù…Ù‡Ù” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø±Ø§ Ø¨Ø²Ù†.</div>
            <div class="row" style="margin-top:8px">
              <input id="treeDepth" placeholder="Ø¹Ù…Ù‚ (Ù…Ø«Ø§Ù„: 3)" style="width:110px" value="3"/>
              <button id="loadTreeBtn">ğŸ” Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª Ù…Ù†</button>
            </div>
            <div id="treeView"></div>
          </div>

          <div class="panel" style="margin-top:12px">
            <h3>Ù„Ø§Ú¯ Ùˆ ÙˆØ¶Ø¹ÛŒØª</h3>
            <div id="logBox">Ø¢Ù…Ø§Ø¯Ù‡.</div>
            <div id="statusBox" class="status" style="display:none"></div>
          </div>
        </div>
      </div>

      <footer>
        Ù†Ú©ØªÙ‡: Read provider Ø±ÙˆÛŒ <strong>rpc-mainnet.maticvigil.com</strong> ØªÙ†Ø¸ÛŒÙ… Ø´Ø¯Ù‡ Ø§Ø³Øª. Ø¨Ø±Ø§ÛŒ ØªØ±Ø§Ú©Ù†Ø´ Ø§Ø² Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø®ÙˆØ¯ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ù‚Ø¨Ù„ Ø§Ø² Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´â€ŒÙ‡Ø§ Ø§Ø¨ØªØ¯Ø§ Ø¯Ø± ØªØ³Øªâ€ŒÙ†Øª Ø¢Ø²Ù…Ø§ÛŒØ´ Ú©Ù†ÛŒØ¯.
      </footer>
    </div>
  </div>

<script>
/* ===========================
   CONFIG
   =========================== */
const CONTRACT_ADDRESS = "0x7a7b06D49129B34976D07B3854d4D72D01588191";
document.getElementById('contractLink').href = 'https://polygonscan.com/address/' + CONTRACT_ADDRESS;
document.getElementById('contractLink').innerText = CONTRACT_ADDRESS;

const READ_RPC = "https://rpc-mainnet.maticvigil.com"; // Ú¯Ø²ÛŒÙ†Ù‡Ù” Ø³ÙˆÙ… (Ø·Ø¨Ù‚ Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ)
const POLYGON_CHAIN_ID = 137;
const POLYGON_CHAIN_HEX = '0x89';
const POLYGONSCAN_TX_PREFIX = 'https://polygonscan.com/tx/';

let web3Modal, walletProvider;
let providerRead, provider, signer, contract;

/* ===========================
   ABI (Ø§Ø² Ù‡Ù…Ø§Ù† ABI Ú©Ù‡ Ø´Ù…Ø§ ÙØ±Ø³ØªØ§Ø¯ÛŒØ¯)
   =========================== */
const CONTRACT_ABI = [{"inputs":[{"internalType":"address","name":"owner","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"message","type":"string"}],"name":"DebugMessage","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"EntryFeeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"string","name":"poolType","type":"string"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"ManualWithdraw","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"contributor","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"MinerPoolContribution","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"}],"name":"MinerRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"timestamp","type":"uint256"}],"name":"MinerTokensBought","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"string","name":"poolType","type":"string"}],"name":"NoEligibleUsers","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":true,"internalType":"address","name":"upline","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"},{"indexed":false,"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"Registered","type":"event"},{"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"id","type":"uint256"}],"name":"UserMigrated","type":"event"},{"inputs":[],"name":"CYCLE_DURATION","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"ENTRY_FEE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MAX_CYCLE_BALANCES","outputs":[{"internalType":"uint8","name":"","type":"uint8"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"MINER_BUY_INTERVAL","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"PTOKEN_CONTRACT","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"_getSpecialUserInfoForMigrateToNewFork","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userAddress","type":"address"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"address","name":"upline","type":"address"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address[]","name":"usersToRemove","type":"address[]"}],"name":"batchRemoveMiners","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"buyMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"contributeToMinerPool","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"distributeMinerTokens","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"eligiblePoolUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"eligibleSpecialUserCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getMinerStats","outputs":[{"internalType":"uint256","name":"checkedOutPaidCount","type":"uint256"},{"internalType":"uint256","name":"eligibleInProgressCount","type":"uint256"},{"internalType":"uint256","name":"totalRemain","type":"uint256"},{"internalType":"uint256","name":"networkerCount","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"percent","type":"uint256"}],"name":"getMinerStatsByPercent","outputs":[{"internalType":"uint256","name":"usersAbovePercent","type":"uint256"},{"internalType":"uint256","name":"totalRemaining","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getSpecialPoolParticipants","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"getTokenPrice","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"userId","type":"uint256"}],"name":"getUserDirects","outputs":[{"internalType":"uint256","name":"leftId","type":"uint256"},{"internalType":"uint256","name":"rightId","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"user","type":"address"}],"name":"getUserInfo","outputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"uint256","name":"leftCount","type":"uint256"},{"internalType":"uint256","name":"rightCount","type":"uint256"},{"internalType":"uint256","name":"saveLeft","type":"uint256"},{"internalType":"uint256","name":"saveRight","type":"uint256"},{"internalType":"uint256","name":"balanceCount","type":"uint256"},{"internalType":"uint256","name":"specialBalanceCount","type":"uint256"},{"internalType":"uint256","name":"totalMinerRewards","type":"uint256"},{"internalType":"uint256","name":"entryPrice","type":"uint256"},{"internalType":"bool","name":"isMiner","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint8","name":"day","type":"uint8"}],"name":"isCurrentTimeMatchToDay","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"isPoolWithdrawable","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastMinerBuyTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"lastPoolWithdrawTime","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"minerTokenPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"id","type":"uint256"},{"internalType":"address","name":"userWallet","type":"address"},{"internalType":"uint256","name":"uplineId","type":"uint256"},{"internalType":"address","name":"leftChildAddress","type":"address"},{"internalType":"address","name":"rightChildAddress","type":"address"},{"internalType":"uint256","name":"oldLeftCount","type":"uint256"},{"internalType":"uint256","name":"oldRightCount","type":"uint256"},{"internalType":"uint256","name":"oldLeftSave","type":"uint256"},{"internalType":"uint256","name":"oldRightSave","type":"uint256"}],"name":"mpu","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"ownerPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"pendingMinerFunds","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolBalance","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"poolPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"uplineCode","type":"uint256"},{"internalType":"bool","name":"placeOnLeft","type":"bool"}],"name":"register","outputs":[],"stateMutability":"payable","type":"function"},{"inputs":[],"name":"specialPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialPointCount","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"specialRewardPool","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"totalUsers","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[{"internalType":"uint256","name":"newFee","type":"uint256"}],"name":"updateEntryFee","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"userTokenPercentage","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},{"inputs":[],"name":"withdrawPool","outputs":[],"stateMutability":"nonpayable","type":"function"},{"inputs":[],"name":"withdrawSpecials","outputs":[],"stateMutability":"nonpayable","type":"function"}];

/* ===========================
   UI refs
   =========================== */
const connectBtn = document.getElementById('connectBtn');
const wcBtn = document.getElementById('wcBtn');
const disconnectBtn = document.getElementById('disconnectBtn');
const registerBtn = document.getElementById('registerBtn');
const buyMinerBtn = document.getElementById('buyMinerBtn');
const withdrawPoolBtn = document.getElementById('withdrawPoolBtn');
const withdrawSpecialsBtn = document.getElementById('withdrawSpecialsBtn');
const getUserBtn = document.getElementById('getUserBtn');
const loadTreeBtn = document.getElementById('loadTreeBtn');

const walletShort = document.getElementById('walletShort');
const feeInfo = document.getElementById('feeInfo');
const resultBox = document.getElementById('resultBox');
const logBox = document.getElementById('logBox');
const statusBox = document.getElementById('statusBox');
const treeView = document.getElementById('treeView');

/* ===========================
   helpers: logs & status
   =========================== */
function addLog(msg){
  const now = new Date().toLocaleTimeString();
  logBox.innerText = `[${now}] ${msg}\n` + logBox.innerText;
}
function setStatus(text, ok=true){
  statusBox.style.display='block';
  statusBox.className = 'status ' + (ok? 'ok':'err');
  statusBox.innerText = text;
  setTimeout(()=>{ statusBox.style.display='none'; }, 7000);
}

/* ===========================
   Web3Modal init
   =========================== */
function initWeb3Modal(){
  const providerOptions = {
    walletconnect: {
      package: window.WalletConnectProvider.default,
      options: {
        rpc: { 137: READ_RPC }
      }
    }
  };
  web3Modal = new window.Web3Modal.default({ cacheProvider: false, providerOptions });
}

/* ===========================
   Read-only provider (fast RPC)
   =========================== */
function ensureReadProvider(){
  if(!providerRead){
    providerRead = new ethers.providers.JsonRpcProvider(READ_RPC);
  }
  // create contract with read provider for view calls
  if(!contract){
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, providerRead);
  }
}

/* ===========================
   Connect injected wallet (MetaMask / SafePal in-app)
   =========================== */
async function connectInjected(){
  try {
    if(!window.ethereum) throw new Error('Ø³Ø±ÙˆØ± ÙˆÙ„Øª Ø¯Ø± Ù…Ø±ÙˆØ±Ú¯Ø± Ø´Ù…Ø§ Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯');
    provider = new ethers.providers.Web3Provider(window.ethereum);
    await provider.send('eth_requestAccounts', []);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletShort.innerHTML = `Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>${addr}</strong>`;
    disconnectBtn.style.display = 'inline-block';
    addLog('Connected (injected): ' + addr);
    await refreshNetworkAndBalance();
    setStatus('Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ù…ØªØµÙ„ Ø´Ø¯');
  } catch(e){
    console.error(e);
    addLog('connectInjected error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„', false);
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: ' + (e && e.message));
  }
}

/* ===========================
   Connect via WalletConnect
   =========================== */
async function connectWalletConnect(){
  try {
    walletProvider = await web3Modal.connect();
    provider = new ethers.providers.Web3Provider(walletProvider);
    signer = provider.getSigner();
    contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, signer);
    const addr = await signer.getAddress();
    walletShort.innerHTML = `Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: <strong>${addr}</strong>`;
    disconnectBtn.style.display = 'inline-block';
    addLog('Connected (WalletConnect): ' + addr);
    await refreshNetworkAndBalance();
    setStatus('WalletConnect Ù…ØªØµÙ„ Ø´Ø¯');
    walletProvider.on && walletProvider.on("disconnect", (code, reason) => {
      addLog('WalletConnect disconnected');
      walletProvider = null;
      provider = null;
      signer = null;
      contract = null;
      walletShort.innerText = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡';
      disconnectBtn.style.display = 'none';
    });
  } catch(e){
    console.error(e);
    addLog('connectWalletConnect error: ' + (e && e.message));
    setStatus('Ø§ØªØµØ§Ù„ WalletConnect Ø´Ú©Ø³Øª Ø®ÙˆØ±Ø¯', false);
    alert('Ø®Ø·Ø§: ' + (e && e.message));
  }
}

/* ===========================
   Disconnect
   =========================== */
function disconnectWallet(){
  try { if(walletProvider && walletProvider.close) walletProvider.close(); } catch(e){}
  provider = null; signer = null; contract = new ethers.Contract(CONTRACT_ADDRESS, CONTRACT_ABI, providerRead);
  walletShort.innerText = 'Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„: Ù…ØªØµÙ„ Ù†Ø´Ø¯Ù‡';
  disconnectBtn.style.display = 'none';
  addLog('Disconnected');
}

/* ===========================
   try switch to Polygon
   =========================== */
async function trySwitchToPolygon(){
  if(!window.ethereum) throw new Error('No injected wallet to switch');
  try {
    await window.ethereum.request({ method: 'wallet_switchEthereumChain', params: [{ chainId: POLYGON_CHAIN_HEX }]});
    addLog('Switched to Polygon');
    setStatus('Ø´Ø¨Ú©Ù‡ Ø¨Ù‡ Polygon ØªØºÛŒÛŒØ± ÛŒØ§ÙØª');
  } catch(switchError){
    if(switchError && switchError.code === 4902){
      try {
        await window.ethereum.request({
          method: 'wallet_addEthereumChain',
          params: [{
            chainId: POLYGON_CHAIN_HEX,
            chainName: 'Polygon Mainnet',
            nativeCurrency: { name: 'MATIC', symbol: 'MATIC', decimals: 18 },
            rpcUrls: [READ_RPC],
            blockExplorerUrls: ['https://polygonscan.com']
          }]
        });
        addLog('Polygon added to wallet');
        setStatus('Polygon Ø¨Ù‡ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø§Ø¶Ø§ÙÙ‡ Ø´Ø¯');
      } catch(err){ throw err; }
    } else throw switchError;
  }
}

/* ===========================
   refresh network + balance
   =========================== */
async function refreshNetworkAndBalance(){
  try {
    if(!provider) return;
    const network = await provider.getNetwork();
    if(network.chainId !== POLYGON_CHAIN_ID){
      setStatus('Ø´Ø¨Ú©Ù‡ Ø¨Ø§ÛŒØ¯ Polygon Ø¨Ø§Ø´Ø¯ â€” ØªÙ„Ø§Ø´ Ø¨Ø±Ø§ÛŒ Ø³ÙˆØ¦ÛŒÚ†...', false);
      try { await trySwitchToPolygon(); } catch(e){ addLog('Switch to polygon failed: ' + (e && e.message)); }
    }
    if(signer){
      const addr = await signer.getAddress();
      const bal = await provider.getBalance(addr);
      addLog('Balance: ' + ethers.utils.formatEther(bal) + ' MATIC');
    }
  } catch(e){ console.error(e); }
}

/* ===========================
   Read ENTRY_FEE
   =========================== */
async function readEntryFee(){
  try {
    ensureReadProvider();
    const fee = await contract.ENTRY_FEE();
    const feeMatic = ethers.utils.formatEther(fee);
    feeInfo.innerText = `ENTRY_FEE = ${feeMatic} MATIC`;
    addLog('ENTRY_FEE read: ' + feeMatic + ' MATIC');
    return fee;
  } catch(e){
    console.error(e);
    addLog('readEntryFee error: ' + (e && e.message));
    feeInfo.innerText = 'ENTRY_FEE = (error)';
    return null;
  }
}

/* ===========================
   REGISTER (fixed 300 MATIC)
   =========================== */
async function registerAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯.');
    const uplineRaw = document.getElementById('uplineInput').value.trim();
    if(!uplineRaw) return alert('Ù„Ø·ÙØ§Ù‹ upline code ÛŒØ§ Ø¢Ø¯Ø±Ø³ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    // contract expects uplineCode uint256 â€” user may enter id (number) or address; prefer numeric code if numeric
    let uplineCode = Number(uplineRaw);
    if(isNaN(uplineCode) || uplineCode <= 0){
      // if not numeric, try to get id from address by scanning getUserInfo? we will fail-safe by requiring numeric
      // to keep UX simple: if not numeric, ask user to input numeric upline code
      return alert('Ù„Ø·ÙØ§Ù‹ upline code Ø±Ø§ Ø¨Ù‡ ØµÙˆØ±Øª Ø¹Ø¯Ø¯ (id) ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯.');
    }
    const placeOnLeft = document.getElementById('placeSide').value === 'true';
    const valueToSend = ethers.utils.parseEther('300');

    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø±Ø³Ø§Ù„ ØªØ±Ø§Ú©Ù†Ø´ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…...');
    const tx = await contract.register(uplineCode, placeOnLeft, { value: valueToSend });
    addLog('register tx submitted: ' + tx.hash);
    resultBox.innerText = 'TX Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯: ' + tx.hash;
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash, '_blank');
    await tx.wait();
    addLog('register confirmed: ' + tx.hash);
    setStatus('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø§Ù†Ø¬Ø§Ù… Ø´Ø¯');
    resultBox.innerText = 'Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù…ÙˆÙÙ‚ â€” ' + tx.hash;
    await refreshNetworkAndBalance();
  } catch(e){
    console.error(e);
    addLog('register error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø«Ø¨Øªâ€ŒÙ†Ø§Ù…: ' + (e && e.message), false);
    alert('Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø§Ù…ÙˆÙÙ‚ Ø´Ø¯: ' + (e && e.message));
  }
}

/* ===========================
   buyMinerTokens()
   =========================== */
async function buyMinerTokensAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ buyMinerTokens...');
    const tx = await contract.buyMinerTokens();
    addLog('buyMinerTokens tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('buyMinerTokens Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('buyMinerTokens confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('buyMinerTokens error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± buyMinerTokens', false);
    alert('buyMinerTokens Ø®Ø·Ø§: ' + (e && e.message));
  }
}

/* ===========================
   withdrawPool()
   =========================== */
async function withdrawPoolAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ withdrawPool...');
    const tx = await contract.withdrawPool();
    addLog('withdrawPool tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('withdrawPool Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('withdrawPool confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('withdrawPool error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± withdrawPool', false);
    alert('withdrawPool Ø®Ø·Ø§: ' + (e && e.message));
  }
}

/* ===========================
   withdrawSpecials()
   =========================== */
async function withdrawSpecialsAction(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø§Ø¬Ø±Ø§ÛŒ withdrawSpecials...');
    const tx = await contract.withdrawSpecials();
    addLog('withdrawSpecials tx: ' + tx.hash);
    window.open(POLYGONSCAN_TX_PREFIX + tx.hash,'_blank');
    await tx.wait();
    setStatus('withdrawSpecials Ø§Ø¬Ø±Ø§ Ø´Ø¯');
    addLog('withdrawSpecials confirmed: ' + tx.hash);
  } catch(e){
    console.error(e);
    addLog('withdrawSpecials error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± withdrawSpecials', false);
    alert('withdrawSpecials Ø®Ø·Ø§: ' + (e && e.message));
  }
}

/* ===========================
   getUserInfo (by address)
   =========================== */
async function getUserInfoAction(){
  try {
    ensureReadProvider();
    let addr = document.getElementById('lookupAddress').value.trim();
    if(!addr){
      if(!signer) return alert('Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ù…ØªØµÙ„ Ù†ÛŒØ³Øª Ùˆ Ø¢Ø¯Ø±Ø³ Ø¬Ø³ØªØ¬Ùˆ ÙˆØ§Ø±Ø¯ Ù†Ø´Ø¯Ù‡');
      addr = await signer.getAddress();
    }
    const info = await contract.getUserInfo(addr);
    const out = {
      id: info[0].toString(),
      uplineId: info[1].toString(),
      leftCount: info[2].toString(),
      rightCount: info[3].toString(),
      saveLeft: info[4].toString(),
      saveRight: info[5].toString(),
      balanceCount: info[6].toString(),
      specialBalanceCount: info[7].toString(),
      totalMinerRewards: info[8].toString(),
      entryPrice: ethers.utils.formatEther(info[9] || '0'),
      isMiner: info[10]
    };
    resultBox.innerText = JSON.stringify(out, null, 2);
    addLog('getUserInfo fetched for ' + addr);
  } catch(e){
    console.error(e);
    addLog('getUserInfo error: ' + (e && e.message));
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø±ÛŒØ§ÙØª Ø§Ø·Ù„Ø§Ø¹Ø§Øª', false);
    alert('getUserInfo Ø®Ø·Ø§: ' + (e && e.message));
  }
}

/* ===========================
   Tree loader (using getUserDirects)
   =========================== */
async function fetchTreeById(userId, depth){
  if(!userId || userId === 0 || depth <= 0) return null;
  try {
    const directs = await contract.getUserDirects(userId);
    const leftId = Number(directs.leftId || directs[0]) || 0;
    const rightId = Number(directs.rightId || directs[1]) || 0;
    const node = { id: userId, name: `ID ${userId}`, children: [] };
    if(leftId){
      const leftNode = await fetchTreeById(leftId, depth-1);
      node.children.push(leftNode || { id:leftId, name:`ID ${leftId}`, children:[] });
    }
    if(rightId){
      const rightNode = await fetchTreeById(rightId, depth-1);
      node.children.push(rightNode || { id:rightId, name:`ID ${rightId}`, children:[] });
    }
    return node;
  } catch(e){
    return { id:userId, name:`ID ${userId}`, children:[] };
  }
}

function drawAsciiTree(node, indent=0){
  if(!node) return '';
  let out = ' '.repeat(indent*2) + node.name + '\n';
  if(node.children && node.children.length){
    for(const c of node.children) out += drawAsciiTree(c, indent+1);
  }
  return out;
}

async function loadTree(){
  try {
    if(!signer) return alert('Ø§Ø¨ØªØ¯Ø§ Ú©ÛŒÙâ€ŒÙ¾ÙˆÙ„ Ø±Ø§ Ù…ØªØµÙ„ Ú©Ù†ÛŒØ¯');
    setStatus('Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª...');
    const myAddr = await signer.getAddress();
    const info = await contract.getUserInfo(myAddr);
    const myId = Number(info[0].toString());
    if(myId === 0){ setStatus('Ø´Ù…Ø§ Ø«Ø¨Øªâ€ŒÙ†Ø§Ù… Ù†Ø´Ø¯Ù‡â€ŒØ§ÛŒØ¯ (id=0)', false); return; }
    const depth = Number(document.getElementById('treeDepth').value) || 3;
    const data = await fetchTreeById(myId, depth);
    treeView.innerText = drawAsciiTree(data || { name:`ID ${myId}`, children:[] });
    setStatus('Ø¯Ø±Ø®Øª Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø´Ø¯');
    addLog('Tree loaded for ID ' + myId);
  } catch(e){
    console.error(e);
    setStatus('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª', false);
    addLog('loadTree error: ' + (e && e.message));
    alert('Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø±Ø®Øª: ' + (e && e.message));
  }
}

/* ===========================
   Wire UI
   =========================== */
initWeb3Modal();
ensureReadProvider();

connectBtn.addEventListener('click', async ()=> {
  if(window.ethereum){
    await connectInjected();
  } else {
    await connectWalletConnect();
  }
});
wcBtn.addEventListener('click', async ()=> { await connectWalletConnect(); });
disconnectBtn.addEventListener('click', disconnectWallet);

registerBtn.addEventListener('click', async ()=> { await registerAction(); });
buyMinerBtn.addEventListener('click', async ()=> { await buyMinerTokensAction(); });
withdrawPoolBtn.addEventListener('click', async ()=> { await withdrawPoolAction(); });
withdrawSpecialsBtn.addEventListener('click', async ()=> { await withdrawSpecialsAction(); });
getUserBtn.addEventListener('click', async ()=> { await getUserInfoAction(); });
loadTreeBtn.addEventListener('click', async ()=> { await loadTree(); });

readEntryFee().then(()=>addLog('Read-only provider ready.'));
addLog('DApp loaded (read provider: ' + READ_RPC + ').');

</script>
</body>
</html>
